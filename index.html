<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Terry WMS 手機版</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- 拆分後的 CSS -->
    <link rel="stylesheet" href="css/main.css">
    
    <!-- 外部函式庫 -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Firebase compat 版本 (支援傳統載入，可直接雙擊開啟) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- 登入頁 -->
    <div id="login-page" class="login-page">
        <i class="fa-solid fa-warehouse login-logo"></i>
        <h1 class="login-title">Terry WMS</h1>
        <p class="login-subtitle">倉儲管理系統 - 手機版</p>
        <div class="login-box">
            <input type="email" id="login-email" class="login-input" placeholder="Email" value="admin@bafang.com">
            <input type="password" id="login-pwd" class="login-input" placeholder="密碼" value="123456">
            <div id="login-error" class="login-error"></div>
            <button onclick="doLogin()" class="login-btn">
                <i class="fa-solid fa-right-to-bracket"></i> 登入
            </button>
        </div>
    </div>
    
    <!-- 主頁面 -->
    <div id="app-main" class="app-container">
        <header class="app-header">
            <div class="app-logo">
                <i class="fa-solid fa-warehouse"></i>
                <span>Terry WMS</span>
            </div>
            <div class="user-info">
                <span class="user-name" id="display-user">-</span>
                <button onclick="doLogout()" class="logout-btn">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </header>
        
        <div class="main-menu">
            <!-- 四大核心功能 -->
            <div class="menu-card inbound" onclick="showInboundOptions()" style="background:linear-gradient(135deg,#065f46,#047857);">
                <div class="menu-icon">
                    <i class="fa-solid fa-arrow-down"></i>
                    <span class="menu-badge" id="badge-inbound" style="display:none">0</span>
                </div>
                <div class="menu-text">
                    <h3>入庫</h3>
                    <p>任務列表 / 直接掃描</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <div class="menu-card outbound" onclick="openPage('scan-outbound')" style="background:linear-gradient(135deg,#9a3412,#ea580c);">
                <div class="menu-icon"><i class="fa-solid fa-arrow-up"></i></div>
                <div class="menu-text">
                    <h3>出庫</h3>
                    <p>掃描插單 → 輸入數量</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <div class="menu-card move" onclick="openPage('scan-move')" style="background:linear-gradient(135deg,#1e40af,#3b82f6);">
                <div class="menu-icon">
                    <i class="fa-solid fa-dolly"></i>
                    <span class="menu-badge" id="badge-move" style="display:none">0</span>
                </div>
                <div class="menu-text">
                    <h3>移板</h3>
                    <p>工單列表 / 直接掃描</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <div class="menu-card merge" onclick="openPage('scan-merge')" style="background:linear-gradient(135deg,#6b21a8,#a855f7);">
                <div class="menu-icon">
                    <i class="fa-solid fa-compress"></i>
                    <span class="menu-badge" id="badge-merge" style="display:none">0</span>
                </div>
                <div class="menu-text">
                    <h3>併板</h3>
                    <p>工單列表 / 直接掃描</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <!-- 分隔線 -->
            <div style="padding:10px 16px;color:#64748b;font-size:12px;border-top:1px solid #334155;margin-top:8px;">其他功能</div>
            
            <div class="menu-card picking" onclick="openPage('picking')">
                <div class="menu-icon">
                    <i class="fa-solid fa-barcode"></i>
                    <span class="menu-badge" id="badge-picking" style="display:none">0</span>
                </div>
                <div class="menu-text">
                    <h3>波次揀貨</h3>
                    <p>依波次批量出庫</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <div class="menu-card" onclick="openPage('stocktake')" style="background:linear-gradient(135deg,#0369a1,#0ea5e9);">
                <div class="menu-icon" style="background:rgba(255,255,255,0.2);color:white;">
                    <i class="fa-solid fa-clipboard-check"></i>
                </div>
                <div class="menu-text">
                    <h3>庫存盤點</h3>
                    <p>掃描盤點庫存</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <!-- 調度工單已整合到移板/併板功能中 -->
            
            <div class="menu-card query" onclick="openPage('query')">
                <div class="menu-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                <div class="menu-text">
                    <h3>庫存快查</h3>
                    <p>查詢品項位置</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
        </div>
        
        <!-- 入庫選項 Modal -->
        <div id="inbound-options-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:200;padding:20px;align-items:center;justify-content:center;">
            <div style="background:#1e293b;border-radius:16px;padding:20px;width:100%;max-width:320px;">
                <h3 style="color:white;font-size:18px;font-weight:bold;text-align:center;margin-bottom:16px;">
                    <i class="fa-solid fa-arrow-down" style="color:#10b981;margin-right:8px;"></i>選擇入庫模式
                </h3>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <button onclick="openPage('inbound');hideInboundOptions();" style="padding:16px;background:linear-gradient(135deg,#065f46,#047857);border:none;border-radius:12px;color:white;font-size:16px;font-weight:bold;text-align:left;display:flex;align-items:center;gap:12px;">
                        <i class="fa-solid fa-list-check" style="font-size:24px;"></i>
                        <div>
                            <div>任務列表入庫</div>
                            <div style="font-size:12px;color:#6ee7b7;font-weight:normal;">從待辦任務中選擇</div>
                        </div>
                    </button>
                    <button onclick="openPage('scan-inbound');hideInboundOptions();" style="padding:16px;background:linear-gradient(135deg,#0e7490,#06b6d4);border:none;border-radius:12px;color:white;font-size:16px;font-weight:bold;text-align:left;display:flex;align-items:center;gap:12px;">
                        <i class="fa-solid fa-qrcode" style="font-size:24px;"></i>
                        <div>
                            <div>直接掃描入庫</div>
                            <div style="font-size:12px;color:#a5f3fc;font-weight:normal;">掃儲位→掃插單→確認</div>
                        </div>
                    </button>
                    <button onclick="hideInboundOptions();" style="padding:12px;background:#334155;border:none;border-radius:10px;color:#94a3b8;font-size:14px;">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 揀貨掃描頁 -->
    <div id="page-picking" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">揀貨掃描</span>
        </header>
        
        <div class="selector-section">
            <div class="selector-label">選擇波次</div>
            <select id="picking-wave-select" class="selector-input" onchange="loadPickingWave()">
                <option value="">-- 請選擇 --</option>
            </select>
        </div>
        
        <div class="scan-section" id="picking-scan-area" style="display:none">
            <!-- 當前揀貨項目資訊 -->
            <div id="picking-current-item" style="background:#1e3a5f;border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="color:#94a3b8;">品名</span>
                    <span id="picking-item-product" style="color:white;font-weight:bold;">-</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="color:#94a3b8;">批號</span>
                    <span id="picking-item-batch" style="color:#f59e0b;">-</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="color:#94a3b8;">需揀數量</span>
                    <span id="picking-item-qty" style="color:#22c55e;font-size:20px;font-weight:bold;">-</span>
                </div>
                <div style="display:flex;justify-content:space-between;background:rgba(59,130,246,0.2);margin:-12px;margin-top:8px;padding:12px;border-radius:0 0 10px 10px;">
                    <span style="color:#3b82f6;font-weight:bold;">📍 儲位</span>
                    <span id="picking-item-location" style="color:#3b82f6;font-size:18px;font-weight:bold;">-</span>
                </div>
            </div>
            
            <!-- Step 1: 掃描儲位 -->
            <div id="picking-step1">
                <div style="background:rgba(59,130,246,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#3b82f6;font-weight:bold;">步驟 1/3</span> - 掃描儲位確認
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="picking-location-scan" class="scan-input" placeholder="掃描或輸入如 IA011" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'location', function(){ confirmPickingLocation(); })"
                           onkeypress="if(event.keyCode==13){confirmPickingLocation();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('picking-location-scan')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 2: 掃描板號 -->
            <div id="picking-step2" style="display:none;">
                <div style="background:rgba(168,85,247,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#a855f7;font-weight:bold;">步驟 2/3</span> - 掃描板號確認
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="picking-pallet-scan" class="scan-input" placeholder="掃描或輸入棧板編號" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ confirmPickingPallet(); })"
                           onkeypress="if(event.keyCode==13){confirmPickingPallet();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('picking-pallet-scan')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 3: 確認數量 -->
            <div id="picking-step3" style="display:none;">
                <div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#22c55e;font-weight:bold;">步驟 3/3</span> - 確認揀貨數量
                </div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <input type="number" id="picking-qty-input" class="scan-input" style="flex:1;text-align:center;font-size:24px;font-weight:bold;" placeholder="0">
                    <button onclick="confirmPickingQty()" style="padding:14px 24px;background:#22c55e;border:none;border-radius:10px;color:white;font-weight:bold;font-size:16px;">
                        <i class="fa-solid fa-check"></i> 確認
                    </button>
                </div>
                <p class="scan-hint" style="text-align:center;margin-top:8px;">請輸入實際揀貨數量</p>
            </div>
            
            <button onclick="resetPickingScan()" style="width:100%;padding:10px;background:transparent;border:1px solid #475569;border-radius:8px;color:#94a3b8;margin-top:10px;cursor:pointer;">
                <i class="fa-solid fa-rotate-left"></i> 重新掃描 / 跳過此項
            </button>
            
            <div id="picking-scan-result" class="scan-result"></div>
        </div>
        
        <div class="list-section" id="picking-list-area">
            <div class="list-header">
                <h4>揀貨清單</h4>
                <span class="list-progress" id="picking-progress">0/0</span>
            </div>
            <div id="picking-list">
                <div class="empty-state">
                    <i class="fa-solid fa-clipboard-list"></i>
                    <p>請先選擇波次</p>
                </div>
            </div>
        </div>
        
        <div class="bottom-actions" id="picking-actions" style="display:none">
            <button class="action-btn success" onclick="completePickingWave()">
                <i class="fa-solid fa-flag-checkered"></i> 完成波次
            </button>
        </div>
    </div>
    
    <!-- 入庫確認頁 -->
    <div id="page-inbound" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">入庫確認</span>
        </header>
        
        <div class="scan-section">
            <!-- Step 1: 掃描板號 -->
            <div id="inbound-step1">
                <div style="background:rgba(59,130,246,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#3b82f6;font-weight:bold;">步驟 1/2</span> - 掃描板號
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="inbound-pallet-scan" class="scan-input" placeholder="掃描或輸入棧板編號" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ confirmInboundPallet(); })"
                           onkeypress="if(event.keyCode==13){confirmInboundPallet();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('inbound-pallet-scan')"><i class="fa-solid fa-camera"></i></button>
                </div>
                <p class="scan-hint">掃描板號，或從下方任務列表點擊執行</p>
            </div>
            
            <!-- Step 2: 掃描儲位 -->
            <div id="inbound-step2" style="display:none;">
                <div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#22c55e;font-weight:bold;">步驟 2/2</span> - 掃描儲位確認
                </div>
                <div style="background:#1e3a5f;border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#94a3b8;">品名</span>
                        <span id="inbound-show-product" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#94a3b8;">數量</span>
                        <span id="inbound-show-qty" style="color:white;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;background:rgba(34,197,94,0.2);margin:-12px;margin-top:8px;padding:12px;border-radius:0 0 10px 10px;">
                        <span style="color:#22c55e;font-weight:bold;">📍 指定儲位</span>
                        <span id="inbound-show-location" style="color:#22c55e;font-size:18px;font-weight:bold;">-</span>
                    </div>
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="inbound-location-scan" class="scan-input" placeholder="掃描儲位 如:IA011" 
                           oninput="autoFormatAndCheck(this, 'location', function(){ confirmInboundLocation(); })"
                           onkeypress="if(event.keyCode==13){confirmInboundLocation();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('inbound-location-scan')"><i class="fa-solid fa-camera"></i></button>
                </div>
                <p class="scan-hint">掃描或輸入儲位（自動判斷）</p>
                <button onclick="resetInboundStep()" style="width:100%;padding:10px;background:transparent;border:1px solid #475569;border-radius:8px;color:#94a3b8;margin-top:10px;cursor:pointer;">
                    <i class="fa-solid fa-rotate-left"></i> 重新掃描
                </button>
            </div>
            
            <div id="inbound-scan-result" class="scan-result"></div>
        </div>
        
        <!-- 入庫確認 Modal -->
        <div id="inbound-confirm-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:200;padding:20px;align-items:center;justify-content:center;">
            <div style="background:#1e293b;border-radius:16px;padding:20px;width:100%;max-width:340px;border:2px solid #3b82f6;">
                <h3 style="color:white;font-size:18px;font-weight:bold;text-align:center;margin-bottom:16px;">
                    <i class="fa-solid fa-clipboard-check" style="color:#3b82f6;margin-right:8px;"></i>確認入庫資料
                </h3>
                
                <!-- 板號大字顯示 -->
                <div style="background:#0f172a;border:2px solid #f59e0b;border-radius:12px;padding:16px;text-align:center;margin-bottom:16px;">
                    <div style="color:#94a3b8;font-size:12px;margin-bottom:4px;">板號 / 單號</div>
                    <div id="confirm-pallet-id" style="color:#fbbf24;font-size:28px;font-weight:bold;font-family:monospace;letter-spacing:1px;">-</div>
                </div>
                
                <!-- 其他資訊 -->
                <div style="background:#0f172a;border-radius:10px;padding:12px;margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155;">
                        <span style="color:#94a3b8;">品名規格</span>
                        <span id="confirm-product-name" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155;">
                        <span style="color:#94a3b8;">數量</span>
                        <span id="confirm-quantity" style="color:#10b981;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155;">
                        <span style="color:#94a3b8;">批號</span>
                        <span id="confirm-batch" style="color:white;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;">
                        <span style="color:#94a3b8;">指定儲位</span>
                        <span id="confirm-location" style="color:#3b82f6;font-weight:bold;font-size:16px;">-</span>
                    </div>
                </div>
                
                <!-- 按鈕 -->
                <div style="display:flex;gap:12px;">
                    <button onclick="cancelInboundConfirm()" style="flex:1;padding:14px;background:#475569;border:none;border-radius:10px;color:white;font-size:16px;font-weight:bold;">
                        取消
                    </button>
                    <button onclick="confirmInboundTaskAndProceed()" style="flex:2;padding:14px;background:#10b981;border:none;border-radius:10px;color:white;font-size:16px;font-weight:bold;">
                        <i class="fa-solid fa-check" style="margin-right:6px;"></i>確認，前往儲位
                    </button>
                </div>
            </div>
        </div>
        
        <div class="list-section">
            <div class="list-header">
                <h4>👇 點擊任務直接執行</h4>
                <span class="list-progress" id="inbound-count">0 筆</span>
            </div>
            <div id="inbound-list">
                <div class="loading"><i class="fa-solid fa-spinner"></i></div>
            </div>
        </div>
    </div>
    
    <!-- 調度執行頁 -->
    <div id="page-dispatch" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">調度執行</span>
        </header>
        
        <div class="selector-section">
            <div class="selector-label">選擇工單</div>
            <select id="dispatch-order-select" class="selector-input" onchange="loadDispatchOrder()">
                <option value="">-- 請選擇 --</option>
            </select>
        </div>
        
        <div class="scan-section" id="dispatch-scan-area" style="display:none">
            <div class="scan-input-wrap">
                <input type="text" id="dispatch-scan" class="scan-input" placeholder="掃描板號確認">
                <button class="camera-btn" onclick="openCameraScanner('dispatch-scan')"><i class="fa-solid fa-camera"></i></button>
                <button class="scan-btn" onclick="confirmDispatchScan()"><i class="fa-solid fa-check"></i></button>
            </div>
            <p class="scan-hint">掃描板號確認執行</p>
            <div id="dispatch-scan-result" class="scan-result"></div>
        </div>
        
        <div class="list-section" id="dispatch-list-area">
            <div class="list-header">
                <h4>調度清單</h4>
                <span class="list-progress" id="dispatch-progress">0/0</span>
            </div>
            <div id="dispatch-list">
                <div class="empty-state">
                    <i class="fa-solid fa-clipboard-list"></i>
                    <p>請先選擇工單</p>
                </div>
            </div>
        </div>
        
        <div class="bottom-actions" id="dispatch-actions" style="display:none">
            <button class="action-btn success" onclick="completeDispatchOrder()">
                <i class="fa-solid fa-flag-checkered"></i> 完成工單
            </button>
        </div>
    </div>
    
    <!-- ========== 庫存盤點頁 ========== -->
    <div id="page-stocktake" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#0369a1,#0ea5e9);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">庫存盤點</span>
            <div id="offline-indicator" style="display:none;background:#f59e0b;color:white;padding:4px 8px;border-radius:4px;font-size:11px;">
                <i class="fa-solid fa-wifi-slash"></i> 離線
            </div>
        </header>
        
        <div class="scan-section">
            <!-- 模式切換 -->
            <div style="display:flex;gap:8px;margin-bottom:16px;">
                <button id="st-mode-single" onclick="switchStMode('single')" style="flex:1;padding:12px;background:#0ea5e9;border:none;border-radius:10px;color:white;font-weight:bold;font-size:14px;">
                    <i class="fa-solid fa-cube"></i> 單筆盤點
                </button>
                <button id="st-mode-batch" onclick="switchStMode('batch')" style="flex:1;padding:12px;background:#334155;border:none;border-radius:10px;color:#94a3b8;font-weight:bold;font-size:14px;">
                    <i class="fa-solid fa-cubes"></i> 批次盤點
                </button>
            </div>
            
            <!-- ===== 單筆盤點模式 ===== -->
            <div id="st-single-mode">
                <div style="text-align:center;color:#7dd3fc;font-size:13px;margin-bottom:16px;">
                    掃描儲位或棧板 → 確認/調整數量
                </div>
                
                <!-- 掃描區 -->
                <div id="st-scan-area">
                    <div style="background:rgba(14,165,233,0.15);border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                        <div style="color:#0ea5e9;font-size:14px;margin-bottom:4px;">單筆模式</div>
                        <div style="color:#7dd3fc;font-size:18px;font-weight:bold;">📋 掃描儲位或棧板</div>
                    </div>
                    <div class="scan-input-wrap">
                        <input type="text" id="st-scan-input" class="scan-input" placeholder="掃描儲位或棧板編號" style="text-transform:uppercase;" 
                               oninput="autoFormatAndCheck(this, 'auto', function(){ stScan(); })"
                               onkeypress="if(event.keyCode==13){stScan();return false;}" autofocus>
                        <button class="camera-btn" onclick="openCameraScanner('st-scan-input')"><i class="fa-solid fa-camera"></i></button>
                    </div>
                </div>
                
                <!-- 盤點結果區 -->
                <div id="st-result-area" style="display:none;">
                    <div style="background:rgba(14,165,233,0.2);border:1px solid #0ea5e9;border-radius:10px;padding:12px;margin-bottom:16px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#7dd3fc;">儲位</span>
                            <span id="st-info-loc" style="color:#0ea5e9;font-weight:bold;font-size:18px;">-</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#7dd3fc;">品名</span>
                            <span id="st-info-product" style="color:white;font-weight:bold;">-</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                            <span style="color:#7dd3fc;">批號</span>
                            <span id="st-info-lot" style="color:#94a3b8;">-</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="color:#7dd3fc;">系統數量</span>
                            <span id="st-info-sys-qty" style="color:#fbbf24;font-weight:bold;font-size:22px;">-</span>
                        </div>
                    </div>
                    
                    <div style="background:rgba(251,191,36,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                        <span style="color:#fbbf24;font-weight:bold;">輸入實際盤點數量</span>
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:12px;">
                        <input type="number" id="st-actual-qty" class="scan-input" style="flex:1;text-align:center;font-size:28px;font-weight:bold;" placeholder="0"
                               onkeyup="if(event.keyCode===13) executeStocktake();">
                        <button onclick="stSameQty()" style="padding:14px 20px;background:#22c55e;border:none;border-radius:10px;color:white;font-weight:bold;font-size:14px;">數量<br>相符</button>
                    </div>
                    <button onclick="executeStocktake()" style="width:100%;padding:16px;background:#0ea5e9;border:none;border-radius:10px;color:white;font-size:18px;font-weight:bold;">
                        <i class="fa-solid fa-clipboard-check"></i> 確認盤點
                    </button>
                </div>
                
                <div id="st-result" class="scan-result"></div>
                
                <button onclick="resetStocktake()" style="width:100%;padding:16px;background:#475569;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                    <i class="fa-solid fa-rotate-left"></i> 重新掃描
                </button>
            </div>
            
            <!-- ===== 批次盤點模式 ===== -->
            <div id="st-batch-mode" style="display:none;">
                <div style="text-align:center;color:#a78bfa;font-size:13px;margin-bottom:16px;">
                    連續掃描多筆 → 一次提交
                </div>
                
                <!-- 批次掃描區 -->
                <div style="background:rgba(139,92,246,0.15);border-radius:12px;padding:16px;margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <div style="color:#a78bfa;font-size:14px;">批次模式</div>
                        <div style="background:#8b5cf6;color:white;padding:4px 12px;border-radius:20px;font-size:14px;font-weight:bold;">
                            已掃 <span id="st-batch-count">0</span> 筆
                        </div>
                    </div>
                    <div class="scan-input-wrap">
                        <input type="text" id="st-batch-scan" class="scan-input" placeholder="掃描儲位或棧板" style="text-transform:uppercase;" 
                               oninput="autoFormatAndCheck(this, 'auto', function(){ stBatchScan(); })"
                               onkeypress="if(event.keyCode==13){stBatchScan();return false;}">
                        <button class="camera-btn" onclick="openCameraScanner('st-batch-scan')"><i class="fa-solid fa-camera"></i></button>
                    </div>
                </div>
                
                <!-- 當前掃描項目 -->
                <div id="st-batch-current" style="display:none;background:rgba(139,92,246,0.2);border:1px solid #8b5cf6;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#c4b5fd;">品名</span>
                        <span id="st-batch-cur-product" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#c4b5fd;">儲位</span>
                        <span id="st-batch-cur-loc" style="color:#a78bfa;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
                        <span style="color:#c4b5fd;">系統數量</span>
                        <span id="st-batch-cur-sys" style="color:#fbbf24;font-weight:bold;font-size:20px;">-</span>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <input type="number" id="st-batch-cur-qty" class="scan-input" style="flex:1;text-align:center;font-size:22px;font-weight:bold;" placeholder="實際數量"
                               onkeyup="if(event.keyCode===13) stBatchAddItem();">
                        <button onclick="stBatchSameQty()" style="padding:10px 16px;background:#22c55e;border:none;border-radius:8px;color:white;font-weight:bold;font-size:12px;">相符</button>
                        <button onclick="stBatchAddItem()" style="padding:10px 16px;background:#8b5cf6;border:none;border-radius:8px;color:white;font-weight:bold;font-size:12px;">加入</button>
                    </div>
                </div>
                
                <!-- 批次列表 -->
                <div id="st-batch-list" style="max-height:200px;overflow-y:auto;margin-bottom:12px;">
                    <div style="text-align:center;color:#64748b;font-size:13px;padding:16px;">開始掃描加入盤點項目</div>
                </div>
                
                <!-- 批次操作按鈕 -->
                <div style="display:flex;gap:10px;">
                    <button onclick="stBatchClear()" style="flex:1;padding:14px;background:#475569;border:none;border-radius:10px;color:white;font-weight:bold;">
                        <i class="fa-solid fa-trash"></i> 清空
                    </button>
                    <button onclick="stBatchSubmit()" style="flex:2;padding:14px;background:#8b5cf6;border:none;border-radius:10px;color:white;font-weight:bold;font-size:16px;">
                        <i class="fa-solid fa-paper-plane"></i> 提交盤點 (<span id="st-batch-submit-count">0</span>筆)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 今日盤點記錄 -->
        <div class="list-section" style="border-top:1px solid #334155;">
            <div class="list-header">
                <h4><i class="fa-solid fa-history mr-1 text-sky-400"></i>今日盤點記錄</h4>
                <span class="list-progress" id="st-today-count">0 筆</span>
            </div>
            <div id="st-today-list">
                <div style="text-align:center;color:#64748b;font-size:13px;padding:20px;">尚無盤點記錄</div>
            </div>
        </div>
    </div>
    
    <!-- 庫存快查頁 -->
    <div id="page-query" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">庫存快查</span>
        </header>
        
        <div class="scan-section">
            <div class="scan-input-wrap">
                <input type="text" id="query-input" class="scan-input" placeholder="輸入品名或板號">
                <button class="camera-btn" onclick="openCameraScanner('query-input')"><i class="fa-solid fa-camera"></i></button>
                <button class="scan-btn" onclick="doInventoryQuery()"><i class="fa-solid fa-search"></i></button>
            </div>
            <p class="scan-hint">支援模糊搜尋</p>
        </div>
        
        <div class="query-result" id="query-result">
            <div class="empty-state">
                <i class="fa-solid fa-box-open"></i>
                <p>輸入關鍵字搜尋庫存</p>
            </div>
        </div>
    </div>

    
    <!-- ========== 入庫掃描頁 (新版流程) ========== -->
    <div id="page-scan-inbound" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#065f46,#047857);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">入庫作業</span>
        </header>
        
        <div class="scan-section">
            <div style="text-align:center;color:#6ee7b7;font-size:13px;margin-bottom:16px;">
                掃描儲位 → 掃描插單 → 完成綁定
            </div>
            
            <!-- Step 1: 掃描儲位 -->
            <div id="scan-in-step1">
                <div style="background:rgba(16,185,129,0.15);border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                    <div style="color:#10b981;font-size:14px;margin-bottom:4px;">步驟 1</div>
                    <div style="color:#6ee7b7;font-size:20px;font-weight:bold;">📍 掃描儲位條碼</div>
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-in-location" class="scan-input" placeholder="掃描或輸入如 IA011" style="text-transform:uppercase;" 
                           oninput="autoFormatAndCheck(this, 'location', function(){ scanInboundStep1(); })"
                           onkeypress="if(event.keyCode==13){scanInboundStep1();return false;}" autofocus>
                    <button class="camera-btn" onclick="openCameraScanner('scan-in-location')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 2: 掃描插單 -->
            <div id="scan-in-step2" style="display:none;">
                <div style="background:rgba(16,185,129,0.2);border:1px solid #10b981;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="color:#6ee7b7;">✅ 儲位</span>
                        <span id="scan-in-loc-display" style="color:#10b981;font-size:20px;font-weight:bold;">-</span>
                    </div>
                </div>
                <div style="background:rgba(59,130,246,0.15);border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                    <div style="color:#3b82f6;font-size:14px;margin-bottom:4px;">步驟 2</div>
                    <div style="color:#93c5fd;font-size:20px;font-weight:bold;">📦 掃描棧板插單</div>
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-in-pallet" class="scan-input" placeholder="掃描或輸入棧板編號" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanInboundStep2(); })"
                           onkeypress="if(event.keyCode==13){scanInboundStep2();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('scan-in-pallet')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 3: 確認件數 -->
            <div id="scan-in-step3" style="display:none;">
                <div style="background:rgba(16,185,129,0.2);border:1px solid #10b981;border-radius:10px;padding:10px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;font-size:13px;">
                        <span style="color:#6ee7b7;">✅ 儲位</span>
                        <span id="scan-in-loc-display2" style="color:#10b981;font-weight:bold;">-</span>
                    </div>
                </div>
                <div style="background:rgba(245,158,11,0.15);border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                    <div style="color:#f59e0b;font-size:14px;margin-bottom:4px;">步驟 3</div>
                    <div style="color:#fcd34d;font-size:20px;font-weight:bold;">✍️ 確認件數</div>
                </div>
                <div style="background:#1e3a5f;border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="color:#94a3b8;">品名</span>
                        <span id="scan-in-product-name" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="color:#94a3b8;">規格</span>
                        <span id="scan-in-spec" style="color:white;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span style="color:#94a3b8;">批號</span>
                        <span id="scan-in-batch" style="color:white;">-</span>
                    </div>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="color:#94a3b8;font-size:13px;display:block;margin-bottom:6px;">入庫件數</label>
                    <input type="number" id="scan-in-qty-input" class="scan-input" placeholder="輸入件數" inputmode="numeric" style="font-size:24px;text-align:center;font-weight:bold;">
                </div>
                <button onclick="confirmScanInbound()" style="width:100%;padding:16px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:12px;color:white;font-size:18px;font-weight:bold;cursor:pointer;">
                    <i class="fa-solid fa-check-circle"></i> 確認入庫
                </button>
            </div>
            
            <div id="scan-in-result" class="scan-result"></div>
            
            <button onclick="resetScanInbound()" style="width:100%;padding:16px;background:#dc2626;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                <i class="fa-solid fa-rotate-left"></i> 重新掃描
            </button>
        </div>
    </div>
    
    <!-- ========== 出庫掃描頁 ========== -->
    <div id="page-scan-outbound" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#9a3412,#ea580c);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">出庫作業</span>
        </header>
        
        <div class="scan-section">
            <div style="text-align:center;color:#fdba74;font-size:13px;margin-bottom:16px;">
                掃描插單 → 輸入數量 → 完成出庫
            </div>
            
            <!-- Step 1: 掃描插單 -->
            <div id="scan-out-step1">
                <div style="background:rgba(234,88,12,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#ea580c;font-weight:bold;">步驟 1</span> - 掃描棧板插單
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-out-pallet" class="scan-input" placeholder="掃描或輸入棧板編號" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanOutboundStep1(); })"
                           onkeypress="if(event.keyCode==13){scanOutboundStep1();return false;}" autofocus>
                    <button class="camera-btn" onclick="openCameraScanner('scan-out-pallet')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 2: 輸入數量 -->
            <div id="scan-out-step2" style="display:none;">
                <div style="background:rgba(234,88,12,0.2);border:1px solid #ea580c;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="text-align:center;">
                        <div id="scan-out-product" style="color:white;font-size:18px;font-weight:bold;">-</div>
                        <div id="scan-out-spec" style="color:#94a3b8;font-size:14px;">-</div>
                        <div style="margin-top:8px;">
                            <span style="color:#fdba74;">庫存：</span>
                            <span id="scan-out-stock" style="color:#fbbf24;font-size:24px;font-weight:bold;">0</span>
                            <span style="color:#fdba74;"> 件</span>
                        </div>
                        <div style="color:#64748b;font-size:12px;margin-top:4px;">儲位：<span id="scan-out-loc">-</span></div>
                    </div>
                </div>
                <div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#ef4444;font-weight:bold;">步驟 2</span> - 選擇或輸入出庫數量
                </div>
                <!-- 快速數量按鈕 -->
                <div id="scan-out-quick-btns" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;">
                </div>
                <div style="display:flex;gap:10px;margin-bottom:12px;">
                    <input type="number" id="scan-out-qty" class="scan-input" style="flex:1;text-align:center;font-size:28px;font-weight:bold;" placeholder="0"
                           onkeyup="if(event.keyCode===13) executeScanOutbound();">
                    <button onclick="scanOutboundAll()" style="padding:14px 20px;background:#ef4444;border:none;border-radius:10px;color:white;font-weight:bold;font-size:16px;">全出</button>
                </div>
                <button onclick="executeScanOutbound()" style="width:100%;padding:16px;background:#ea580c;border:none;border-radius:10px;color:white;font-size:18px;font-weight:bold;">
                    <i class="fa-solid fa-check"></i> 確認出庫
                </button>
            </div>
            
            <div id="scan-out-result" class="scan-result"></div>
            
            <button onclick="resetScanOutbound()" style="width:100%;padding:16px;background:#dc2626;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                <i class="fa-solid fa-rotate-left"></i> 重新掃描
            </button>
        </div>
    </div>
    
    <!-- ========== 移板掃描頁 ========== -->
    <div id="page-scan-move" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#1e40af,#3b82f6);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">移板作業</span>
        </header>
        
        <!-- 待辦移板工單 -->
        <div id="move-orders-section" class="list-section" style="max-height:200px;overflow-y:auto;padding:12px;border-bottom:1px solid #334155;">
            <div class="list-header" style="margin-bottom:8px;">
                <h4 style="font-size:14px;"><i class="fa-solid fa-clipboard-list mr-1 text-blue-400"></i>待辦移板工單</h4>
                <span class="list-progress" id="move-orders-count">0 筆</span>
            </div>
            <div id="move-orders-list">
                <div style="text-align:center;color:#64748b;font-size:13px;padding:12px;">無待辦工單</div>
            </div>
        </div>
        
        <div class="scan-section">
            <div style="text-align:center;color:#93c5fd;font-size:13px;margin-bottom:16px;">
                <i class="fa-solid fa-hand-pointer mr-1"></i>點擊上方工單執行，或直接掃描
            </div>
            
            <!-- Step 1: 掃描插單 -->
            <div id="scan-move-step1">
                <div style="background:rgba(59,130,246,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#3b82f6;font-weight:bold;">步驟 1</span> - 掃描棧板插單
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-move-pallet" class="scan-input" placeholder="掃描或輸入棧板編號" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanMoveStep1(); })"
                           onkeypress="if(event.keyCode==13){scanMoveStep1();return false;}" autofocus>
                    <button class="camera-btn" onclick="openCameraScanner('scan-move-pallet')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 2: 掃描新儲位 -->
            <div id="scan-move-step2" style="display:none;">
                <div style="background:rgba(59,130,246,0.2);border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#93c5fd;">品名</span>
                        <span id="scan-move-product" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span style="color:#93c5fd;">目前儲位</span>
                        <span id="scan-move-old-loc" style="color:#fbbf24;font-weight:bold;font-size:18px;">-</span>
                    </div>
                </div>
                <div style="background:rgba(16,185,129,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#10b981;font-weight:bold;">步驟 2</span> - 掃描新儲位條碼
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-move-new-loc" class="scan-input" placeholder="掃描或輸入如 IA011" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'location', function(){ scanMoveStep2(); })"
                           onkeypress="if(event.keyCode==13){scanMoveStep2();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('scan-move-new-loc')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <div id="scan-move-result" class="scan-result"></div>
            
            <button onclick="resetScanMove()" style="width:100%;padding:16px;background:#dc2626;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                <i class="fa-solid fa-rotate-left"></i> 重新掃描
            </button>
        </div>
    </div>
    
    <!-- ========== 併板掃描頁 ========== -->
    <div id="page-scan-merge" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#6b21a8,#a855f7);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">併板作業</span>
        </header>
        
        <!-- 待辦併板工單 -->
        <div id="merge-orders-section" class="list-section" style="max-height:200px;overflow-y:auto;padding:12px;border-bottom:1px solid #334155;">
            <div class="list-header" style="margin-bottom:8px;">
                <h4 style="font-size:14px;"><i class="fa-solid fa-clipboard-list mr-1 text-purple-400"></i>待辦併板工單</h4>
                <span class="list-progress" id="merge-orders-count">0 筆</span>
            </div>
            <div id="merge-orders-list">
                <div style="text-align:center;color:#64748b;font-size:13px;padding:12px;">無待辦工單</div>
            </div>
        </div>
        
        <div class="scan-section">
            <div style="text-align:center;color:#d8b4fe;font-size:13px;margin-bottom:16px;">
                <i class="fa-solid fa-hand-pointer mr-1"></i>點擊上方工單執行，或直接掃描
            </div>
            
            <!-- Step 1: 掃描數量少的 -->
            <div id="scan-merge-step1">
                <div style="background:rgba(249,115,22,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#f97316;font-weight:bold;">步驟 1</span> - 掃描數量【少】的插單
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-merge-less" class="scan-input" placeholder="掃描或輸入棧板編號" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanMergeStep1(); })"
                           onkeypress="if(event.keyCode==13){scanMergeStep1();return false;}" autofocus>
                    <button class="camera-btn" onclick="openCameraScanner('scan-merge-less')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- 少的板資訊 -->
            <div id="scan-merge-less-info" style="display:none;background:rgba(249,115,22,0.2);border:1px solid #f97316;border-radius:10px;padding:12px;margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div id="scan-merge-less-name" style="color:white;font-weight:bold;">-</div>
                        <div style="color:#fdba74;font-size:12px;">將被清空刪除</div>
                    </div>
                    <div style="color:#f97316;font-size:24px;font-weight:bold;"><span id="scan-merge-less-qty">0</span> 件</div>
                </div>
            </div>
            
            <!-- 加號 -->
            <div id="scan-merge-plus" style="display:none;text-align:center;font-size:24px;color:#a855f7;padding:8px;">＋</div>
            
            <!-- Step 2: 掃描數量多的 -->
            <div id="scan-merge-step2" style="display:none;">
                <div style="background:rgba(168,85,247,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#a855f7;font-weight:bold;">步驟 2</span> - 掃描數量【多】的插單
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-merge-more" class="scan-input" placeholder="掃描或輸入棧板編號" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanMergeStep2(); })"
                           onkeypress="if(event.keyCode==13){scanMergeStep2();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('scan-merge-more')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- 多的板資訊 -->
            <div id="scan-merge-more-info" style="display:none;background:rgba(168,85,247,0.2);border:1px solid #a855f7;border-radius:10px;padding:12px;margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div id="scan-merge-more-name" style="color:white;font-weight:bold;">-</div>
                        <div style="color:#d8b4fe;font-size:12px;">數量會增加</div>
                    </div>
                    <div style="color:#a855f7;font-size:24px;font-weight:bold;"><span id="scan-merge-more-qty">0</span> 件</div>
                </div>
            </div>
            
            <!-- 合併預覽 -->
            <div id="scan-merge-preview" style="display:none;background:rgba(16,185,129,0.2);border:2px solid #10b981;border-radius:10px;padding:16px;margin-bottom:12px;text-align:center;">
                <div style="color:#6ee7b7;font-size:14px;margin-bottom:8px;">合併後總數</div>
                <div style="color:#10b981;font-size:36px;font-weight:bold;"><span id="scan-merge-total">0</span> 件</div>
                <div style="color:#64748b;font-size:12px;margin-top:4px;">
                    <span id="scan-merge-calc">0 + 0 = 0</span>
                </div>
            </div>
            
            <!-- 確認按鈕 -->
            <button id="btn-scan-merge-confirm" onclick="executeScanMerge()" style="display:none;width:100%;padding:16px;background:#a855f7;border:none;border-radius:10px;color:white;font-size:18px;font-weight:bold;">
                <i class="fa-solid fa-check"></i> 確認併板
            </button>
            
            <div id="scan-merge-result" class="scan-result"></div>
            
            <button onclick="resetScanMerge()" style="width:100%;padding:16px;background:#dc2626;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                <i class="fa-solid fa-rotate-left"></i> 重新掃描
            </button>
        </div>
    </div>

    <!-- Firebase -->

    <!-- ============================================== -->
    <!-- JavaScript 模組 (傳統載入，可直接雙擊開啟) -->
    <!-- 載入順序很重要！ -->
    <!-- ============================================== -->
    
    <!-- 1. Firebase 初始化 (必須最先載入) -->
    <script src="js/firebase-init.js"></script>
    
    <!-- 2. 核心功能 -->
    <script src="js/scanner.js"></script>
    <script src="js/inventory-log.js"></script>
    <script src="js/dispatch-orders.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/feedback.js"></script>
    
    <!-- 3. 業務功能 -->
    <script src="js/picking.js"></script>
    <script src="js/inbound-task.js"></script>
    <script src="js/dispatch.js"></script>
    <script src="js/query.js"></script>
    <script src="js/stocktake.js"></script>
    <script src="js/stocktake-batch.js"></script>
    <script src="js/scan-operations.js"></script>

</body>
</html>
