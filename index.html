<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Terry WMS æ‰‹æ©Ÿç‰ˆ v3.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #fff; min-height: 100vh; overflow-x: hidden; }
        
        /* ç™»å…¥é  */
        .login-page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%); }
        .login-logo { font-size: 48px; color: #3b82f6; margin-bottom: 10px; }
        .login-title { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .login-subtitle { color: #64748b; font-size: 14px; margin-bottom: 30px; }
        .login-box { width: 100%; max-width: 320px; background: rgba(30, 41, 59, 0.8); border: 1px solid #334155; border-radius: 16px; padding: 24px; }
        .login-input { width: 100%; padding: 14px 16px; background: #1e293b; border: 1px solid #334155; border-radius: 10px; color: #fff; font-size: 16px; margin-bottom: 12px; }
        .login-input:focus { outline: none; border-color: #3b82f6; }
        .login-btn { width: 100%; padding: 14px; background: #3b82f6; border: none; border-radius: 10px; color: #fff; font-size: 16px; font-weight: bold; cursor: pointer; }
        .login-btn:active { background: #2563eb; }
        .login-error { color: #f87171; font-size: 14px; margin-bottom: 12px; display: none; }
        
        /* ä¸»é é¢ */
        .app-container { display: none; min-height: 100vh; flex-direction: column; }
        .app-container.active { display: flex; }
        .app-header { background: #1e293b; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
        .app-logo { display: flex; align-items: center; gap: 8px; }
        .app-logo i { color: #3b82f6; font-size: 20px; }
        .app-logo span { font-weight: bold; font-size: 16px; }
        .user-info { display: flex; align-items: center; gap: 8px; }
        .user-name { font-size: 12px; color: #94a3b8; }
        .user-badge { font-size: 10px; background: #3b82f6; padding: 2px 6px; border-radius: 4px; }
        .logout-btn { background: rgba(239, 68, 68, 0.2); border: none; color: #f87171; padding: 6px 10px; border-radius: 6px; font-size: 12px; }
        
        /* ä¸»é¸å–® */
        .main-menu { flex: 1; padding: 20px 16px; display: flex; flex-direction: column; gap: 16px; }
        .menu-card { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 1px solid #475569; border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: transform 0.2s; }
        .menu-card:active { transform: scale(0.98); }
        .menu-card.picking { border-color: #3b82f6; }
        .menu-card.inbound { border-color: #10b981; }
        .menu-card.dispatch { border-color: #f59e0b; }
        .menu-card.query { border-color: #8b5cf6; }
        .menu-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; position: relative; }
        .menu-card.picking .menu-icon { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .menu-card.inbound .menu-icon { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .menu-card.dispatch .menu-icon { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .menu-card.query .menu-icon { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .menu-text h3 { font-size: 18px; margin-bottom: 4px; }
        .menu-text p { font-size: 13px; color: #94a3b8; }
        .menu-arrow { margin-left: auto; color: #475569; font-size: 20px; }
        .menu-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: #fff; font-size: 12px; font-weight: bold; min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; padding: 0 6px; }
        
        /* åŠŸèƒ½é é¢ */
        .func-page { display: none; flex-direction: column; min-height: 100vh; background: #0f172a; }
        .func-page.active { display: flex; }
        .func-header { background: #1e293b; padding: 12px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
        .back-btn { background: none; border: none; color: #fff; font-size: 20px; padding: 8px; }
        .func-title { font-size: 18px; font-weight: bold; }
        
        /* æƒæå€ */
        .scan-section { background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%); padding: 20px 16px; }
        .scan-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .scan-input { flex: 1; padding: 14px 16px; background: #0f172a; border: 2px solid #3b82f6; border-radius: 10px; color: #fff; font-size: 18px; text-align: center; }
        .scan-input:focus { outline: none; border-color: #60a5fa; }
        .scan-btn { padding: 14px 20px; background: #3b82f6; border: none; border-radius: 10px; color: #fff; font-size: 16px; }
        .scan-btn:active { background: #2563eb; }
        .scan-btn.camera { background: #8b5cf6; }
        .scan-hint { color: #64748b; font-size: 13px; text-align: center; }
        .scan-result { margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 14px; white-space: pre-line; }
        .scan-result.success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .scan-result.error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .scan-result.warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .scan-result.info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        
        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
        .step-indicator { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 16px; padding: 12px; background: rgba(15, 23, 42, 0.8); border-radius: 12px; }
        .step-badge { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; background: #334155; color: #64748b; }
        .step-badge.active { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 0 12px rgba(59, 130, 246, 0.5); }
        .step-badge.done { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .step-text { font-size: 12px; color: #94a3b8; }
        .step-text.active { color: #3b82f6; font-weight: bold; }
        .step-text.done { color: #22c55e; }
        .step-arrow { color: #475569; }
        
        /* ä»»å‹™è³‡è¨Šå¡ */
        .task-info-card { background: linear-gradient(135deg, #1e3a5f, #1e293b); border: 1px solid #3b82f6; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .task-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .task-row:last-child { border-bottom: none; }
        .task-row .label { color: #94a3b8; font-size: 13px; }
        .task-row .value { color: white; font-weight: 600; font-size: 14px; }
        .task-row.highlight { background: rgba(34, 197, 94, 0.1); margin: 8px -16px; padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3); }
        .task-row.highlight .label { color: #22c55e; font-weight: bold; }
        .task-row.highlight .value { color: #22c55e; font-size: 18px; }
        .task-row.warning { background: rgba(245, 158, 11, 0.1); margin: 8px -16px; padding: 12px 16px; border-radius: 8px; }
        .task-row.warning .label { color: #f59e0b; }
        .task-row.warning .value { color: #f59e0b; }
        
        /* æ•¸é‡è¼¸å…¥ */
        .qty-input-section { background: rgba(15, 23, 42, 0.8); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .qty-label { font-size: 14px; color: #94a3b8; margin-bottom: 8px; text-align: center; }
        .qty-display { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 12px; }
        .qty-btn { width: 48px; height: 48px; border-radius: 12px; border: none; font-size: 24px; font-weight: bold; cursor: pointer; }
        .qty-btn.minus { background: #ef4444; color: white; }
        .qty-btn.plus { background: #22c55e; color: white; }
        .qty-btn:active { transform: scale(0.95); }
        .qty-value { font-size: 36px; font-weight: bold; color: white; min-width: 80px; text-align: center; }
        .qty-hint { font-size: 12px; color: #64748b; text-align: center; }
        .qty-diff { font-size: 14px; color: #f59e0b; text-align: center; margin-top: 8px; }
        
        /* å·®ç•°åŸå›  */
        .diff-reason-section { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; display: none; }
        .diff-reason-section.show { display: block; }
        .diff-reason-title { color: #f87171; font-size: 14px; margin-bottom: 12px; }
        .diff-reason-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .diff-reason-btn { padding: 8px 16px; border: 1px solid #475569; border-radius: 8px; background: transparent; color: #94a3b8; font-size: 13px; cursor: pointer; }
        .diff-reason-btn.selected { border-color: #ef4444; background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        /* æ¸…å–®å€ */
        .list-section { flex: 1; padding: 16px; overflow-y: auto; }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .list-header h4 { font-size: 16px; color: #94a3b8; }
        .list-progress { font-size: 14px; color: #10b981; font-weight: bold; }
        .list-item { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 14px; margin-bottom: 10px; }
        .list-item.completed { opacity: 0.6; border-color: #22c55e; }
        .list-item.current { border-color: #3b82f6; box-shadow: 0 0 12px rgba(59, 130, 246, 0.3); }
        .list-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .list-item-title { font-weight: bold; font-size: 15px; }
        .list-item-status { font-size: 12px; padding: 4px 8px; border-radius: 6px; }
        .list-item-status.pending { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .list-item-status.done { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .list-item-status.current { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .list-item-detail { font-size: 13px; color: #94a3b8; }
        .list-item-location { font-size: 14px; color: #3b82f6; font-weight: bold; margin-top: 6px; }
        
        /* å‹•ä½œæŒ‰éˆ• */
        .action-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 12px; }
        .action-btn.primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .action-btn.success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn:active:not(:disabled) { transform: scale(0.98); }
        .cancel-btn { width: 100%; padding: 12px; background: transparent; border: 1px solid #475569; border-radius: 8px; color: #94a3b8; font-size: 14px; cursor: pointer; margin-top: 12px; }
        
        /* æ“ä½œå“¡è³‡è¨Š */
        .operator-info { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 8px 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 12px; }
        .operator-info i { color: #3b82f6; }
        .operator-info .name { color: #3b82f6; font-weight: bold; }
        .operator-info .time { color: #64748b; margin-left: auto; }
        
        /* FIFO è­¦å‘Š */
        .fifo-warning { background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center; display: none; }
        .fifo-warning-icon { font-size: 32px; color: #ef4444; margin-bottom: 8px; }
        .fifo-warning-title { color: #f87171; font-size: 16px; font-weight: bold; margin-bottom: 4px; }
        .fifo-warning-text { color: #94a3b8; font-size: 13px; }
        
        /* Toast */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: bold; z-index: 10000; animation: toastIn 0.3s ease; }
        .toast.success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: #64748b; }
        .loading i { animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- ç™»å…¥é é¢ -->
    <div class="login-page" id="login-page">
        <i class="fa-solid fa-warehouse login-logo"></i>
        <h1 class="login-title">Terry WMS</h1>
        <p class="login-subtitle">å€‰å„²ç®¡ç†ç³»çµ± æ‰‹æ©Ÿç‰ˆ v3.0</p>
        <div class="login-box">
            <div class="login-error" id="login-error">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</div>
            <input type="email" class="login-input" id="login-email" placeholder="é›»å­éƒµä»¶">
            <input type="password" class="login-input" id="login-password" placeholder="å¯†ç¢¼">
            <button class="login-btn" onclick="doLogin()"><i class="fa-solid fa-right-to-bracket"></i> ç™»å…¥</button>
        </div>
    </div>
    
    <!-- ä¸»æ‡‰ç”¨ -->
    <div class="app-container" id="app-container">
        <header class="app-header">
            <div class="app-logo"><i class="fa-solid fa-warehouse"></i><span>Terry WMS</span></div>
            <div class="user-info">
                <div><div class="user-name" id="user-display-name">æ“ä½œå“¡</div><div class="user-badge">å †é«˜æ©Ÿæ‰‹</div></div>
                <button class="logout-btn" onclick="doLogout()"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </header>
        <div class="main-menu" id="main-menu">
            <div class="menu-card picking" onclick="showPage('picking')">
                <div class="menu-icon"><i class="fa-solid fa-dolly"></i><span class="menu-badge" id="badge-picking" style="display:none">0</span></div>
                <div class="menu-text"><h3>æ€è²¨æƒæ</h3><p>æ³¢æ¬¡æ€è²¨ä½œæ¥­</p></div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            <div class="menu-card inbound" onclick="showPage('inbound')">
                <div class="menu-icon"><i class="fa-solid fa-truck-ramp-box"></i><span class="menu-badge" id="badge-inbound" style="display:none">0</span></div>
                <div class="menu-text"><h3>å…¥åº«ç¢ºèª</h3><p>æƒæå…¥åº«ä¸Šæ¶</p></div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            <div class="menu-card dispatch" onclick="showPage('dispatch')">
                <div class="menu-icon"><i class="fa-solid fa-arrows-turn-to-dots"></i><span class="menu-badge" id="badge-dispatch" style="display:none">0</span></div>
                <div class="menu-text"><h3>èª¿åº¦åŸ·è¡Œ</h3><p>ç§»ä½èˆ‡åˆä½µä½œæ¥­</p></div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            <div class="menu-card query" onclick="showPage('query')">
                <div class="menu-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                <div class="menu-text"><h3>åº«å­˜å¿«æŸ¥</h3><p>æŸ¥è©¢åº«å­˜ä½ç½®</p></div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
        </div>
    </div>
    
    <!-- å…¥åº«ç¢ºèªé é¢ -->
    <div id="page-inbound" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">å…¥åº«ç¢ºèª</span>
        </header>
        <div class="scan-section">
            <div class="operator-info">
                <i class="fa-solid fa-user"></i>
                <span>æ“ä½œå“¡: <span class="name" id="inbound-operator">-</span></span>
                <span class="time" id="inbound-time">-</span>
            </div>
            
            <!-- Step 1: æƒææ¿è™Ÿ -->
            <div id="inbound-step1">
                <div class="step-indicator">
                    <span class="step-badge active">1</span><span class="step-text active">æƒææ¿è™Ÿ</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge">2</span><span class="step-text">æƒæå„²ä½</span>
                </div>
                <div class="scan-row">
                    <input type="text" id="inbound-pallet-scan" class="scan-input" placeholder="æƒæå…¥åº«æ¿è™Ÿ">
                    <button class="scan-btn" onclick="confirmInboundPallet()"><i class="fa-solid fa-check"></i></button>
                </div>
                <p class="scan-hint">ç¬¬ä¸€æ­¥ï¼šæƒææ¨™ç±¤ä¸Šçš„æ¿è™Ÿæ¢ç¢¼</p>
            </div>
            
            <!-- Step 2: æƒæå„²ä½ -->
            <div id="inbound-step2" style="display:none;">
                <div class="step-indicator">
                    <span class="step-badge done">âœ“</span><span class="step-text done">æ¿è™Ÿå·²æƒ</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge active">2</span><span class="step-text active">æƒæå„²ä½</span>
                </div>
                <div class="task-info-card">
                    <div class="task-row"><span class="label">å“å</span><span class="value" id="inbound-product">-</span></div>
                    <div class="task-row"><span class="label">æ•¸é‡</span><span class="value" id="inbound-qty">-</span></div>
                    <div class="task-row highlight"><span class="label">ğŸ“ æŒ‡å®šå„²ä½</span><span class="value" id="inbound-target-location">-</span></div>
                </div>
                <div class="scan-row">
                    <input type="text" id="inbound-location-scan" class="scan-input" placeholder="æƒæå„²ä½æ¢ç¢¼ç¢ºèª">
                    <button class="scan-btn" onclick="confirmInboundLocation()"><i class="fa-solid fa-check"></i></button>
                </div>
                <p class="scan-hint">ç¬¬äºŒæ­¥ï¼šåˆ°é”å„²ä½å¾Œï¼Œæƒæå„²ä½æ¢ç¢¼ç¢ºèª</p>
                <button class="cancel-btn" onclick="resetInboundStep()"><i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ</button>
            </div>
            <div id="inbound-scan-result" class="scan-result"></div>
        </div>
        <div class="list-section">
            <div class="list-header"><h4>å¾…å…¥åº«ä»»å‹™</h4><span class="list-progress" id="inbound-count">0 ç­†</span></div>
            <div id="inbound-list"><div class="loading"><i class="fa-solid fa-spinner"></i> è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>
    
    <!-- æ€è²¨é é¢ -->
    <div id="page-picking" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">æ€è²¨æƒæ</span>
        </header>
        <div class="scan-section">
            <div class="operator-info">
                <i class="fa-solid fa-user"></i>
                <span>æ“ä½œå“¡: <span class="name" id="picking-operator">-</span></span>
                <span class="time" id="picking-time">-</span>
            </div>
            
            <!-- FIFO è­¦å‘Š -->
            <div id="fifo-warning" class="fifo-warning">
                <div class="fifo-warning-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <div class="fifo-warning-title">è«‹ä¾ç…§é †åºæ€è²¨ï¼</div>
                <div class="fifo-warning-text" id="fifo-warning-text">è«‹å…ˆæ€å–ç¬¬ä¸€é …</div>
            </div>
            
            <!-- Step 1: æƒæå„²ä½ -->
            <div id="picking-step1">
                <div class="step-indicator">
                    <span class="step-badge active">1</span><span class="step-text active">æƒæå„²ä½</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge">2</span><span class="step-text">æƒææ¿è™Ÿ</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge">3</span><span class="step-text">ç¢ºèªæ•¸é‡</span>
                </div>
                <div class="task-info-card" id="picking-current-task" style="display:none;">
                    <div class="task-row highlight"><span class="label">ğŸ“ å‰å¾€å„²ä½</span><span class="value" id="picking-target-location">-</span></div>
                    <div class="task-row"><span class="label">å“å</span><span class="value" id="picking-target-product">-</span></div>
                    <div class="task-row"><span class="label">éœ€æ€æ•¸é‡</span><span class="value" id="picking-target-qty">-</span></div>
                </div>
                <div class="scan-row">
                    <input type="text" id="picking-location-scan" class="scan-input" placeholder="æƒæå„²ä½æ¢ç¢¼">
                    <button class="scan-btn" onclick="confirmPickingLocation()"><i class="fa-solid fa-check"></i></button>
                </div>
                <p class="scan-hint">ç¬¬ä¸€æ­¥ï¼šåˆ°é”å„²ä½å¾Œï¼Œæƒæå„²ä½æ¢ç¢¼</p>
            </div>
            
            <!-- Step 2: æƒææ¿è™Ÿ -->
            <div id="picking-step2" style="display:none;">
                <div class="step-indicator">
                    <span class="step-badge done">âœ“</span><span class="step-text done">å„²ä½ç¢ºèª</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge active">2</span><span class="step-text active">æƒææ¿è™Ÿ</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge">3</span><span class="step-text">ç¢ºèªæ•¸é‡</span>
                </div>
                <div class="task-info-card">
                    <div class="task-row"><span class="label">å·²ç¢ºèªå„²ä½</span><span class="value" id="picking-confirmed-location">-</span></div>
                    <div class="task-row highlight"><span class="label">ğŸ“¦ è«‹æƒææ¿è™Ÿ</span><span class="value" id="picking-target-pallet">-</span></div>
                </div>
                <div class="scan-row">
                    <input type="text" id="picking-pallet-scan" class="scan-input" placeholder="æƒææ¿è™Ÿæ¢ç¢¼">
                    <button class="scan-btn" onclick="confirmPickingPallet()"><i class="fa-solid fa-check"></i></button>
                </div>
                <p class="scan-hint">ç¬¬äºŒæ­¥ï¼šæƒæè¦æ€å–çš„æ¿è™Ÿ</p>
                <button class="cancel-btn" onclick="resetPickingStep()"><i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæå„²ä½</button>
            </div>
            
            <!-- Step 3: ç¢ºèªæ•¸é‡ -->
            <div id="picking-step3" style="display:none;">
                <div class="step-indicator">
                    <span class="step-badge done">âœ“</span><span class="step-text done">å„²ä½ç¢ºèª</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge done">âœ“</span><span class="step-text done">æ¿è™Ÿç¢ºèª</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge active">3</span><span class="step-text active">ç¢ºèªæ•¸é‡</span>
                </div>
                <div class="task-info-card">
                    <div class="task-row"><span class="label">å„²ä½</span><span class="value" id="qty-confirmed-location">-</span></div>
                    <div class="task-row"><span class="label">æ¿è™Ÿ</span><span class="value" id="qty-confirmed-pallet">-</span></div>
                    <div class="task-row warning"><span class="label">ç³»çµ±è¦æ±‚æ•¸é‡</span><span class="value" id="qty-required">-</span></div>
                </div>
                <div class="qty-input-section">
                    <div class="qty-label">å¯¦éš›æ€å–æ•¸é‡</div>
                    <div class="qty-display">
                        <button class="qty-btn minus" onclick="adjustQty(-1)">âˆ’</button>
                        <span class="qty-value" id="picking-actual-qty">0</span>
                        <button class="qty-btn plus" onclick="adjustQty(1)">+</button>
                    </div>
                    <div class="qty-hint">é»æ“Š +/- èª¿æ•´æ•¸é‡</div>
                    <div class="qty-diff" id="qty-diff" style="display:none;"></div>
                </div>
                <div id="diff-reason-section" class="diff-reason-section">
                    <div class="diff-reason-title"><i class="fa-solid fa-exclamation-triangle"></i> æ•¸é‡ä¸ç¬¦ï¼Œè«‹é¸æ“‡åŸå› ï¼š</div>
                    <div class="diff-reason-options">
                        <button class="diff-reason-btn" onclick="selectDiffReason('ç ´æ')">ç ´æ</button>
                        <button class="diff-reason-btn" onclick="selectDiffReason('çŸ­å°‘')">çŸ­å°‘</button>
                        <button class="diff-reason-btn" onclick="selectDiffReason('ç›¤å·®')">ç›¤å·®</button>
                        <button class="diff-reason-btn" onclick="selectDiffReason('å“è³ªå•é¡Œ')">å“è³ªå•é¡Œ</button>
                        <button class="diff-reason-btn" onclick="selectDiffReason('å…¶ä»–')">å…¶ä»–</button>
                    </div>
                </div>
                <button class="action-btn success" onclick="completePickingItem()"><i class="fa-solid fa-check"></i> ç¢ºèªæ€è²¨</button>
                <button class="cancel-btn" onclick="resetPickingStep()"><i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ</button>
            </div>
            <div id="picking-scan-result" class="scan-result"></div>
        </div>
        <div class="list-section">
            <div class="list-header"><h4>æ€è²¨æ¸…å–®</h4><span class="list-progress" id="picking-progress">0/0</span></div>
            <div id="picking-list"><div class="loading"><i class="fa-solid fa-spinner"></i> è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>
    
    <!-- èª¿åº¦åŸ·è¡Œé é¢ -->
    <div id="page-dispatch" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">èª¿åº¦åŸ·è¡Œ</span>
        </header>
        <div class="scan-section">
            <div class="operator-info">
                <i class="fa-solid fa-user"></i>
                <span>æ“ä½œå“¡: <span class="name" id="dispatch-operator">-</span></span>
                <span class="time" id="dispatch-time">-</span>
            </div>
            
            <!-- Step 1: æƒææ¿è™Ÿ -->
            <div id="dispatch-step1">
                <div class="step-indicator">
                    <span class="step-badge active">1</span><span class="step-text active">æƒææ¿è™Ÿ</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge">2</span><span class="step-text">æƒæç›®æ¨™å„²ä½</span>
                </div>
                <div class="task-info-card" id="dispatch-current-task" style="display:none;">
                    <div class="task-row"><span class="label">ä»»å‹™é¡å‹</span><span class="value" id="dispatch-task-type">-</span></div>
                    <div class="task-row"><span class="label">ä¾†æºä½ç½®</span><span class="value" id="dispatch-from-location">-</span></div>
                    <div class="task-row highlight"><span class="label">ğŸ“ ç›®æ¨™ä½ç½®</span><span class="value" id="dispatch-to-location">-</span></div>
                </div>
                <div class="scan-row">
                    <input type="text" id="dispatch-pallet-scan" class="scan-input" placeholder="æƒææ¿è™Ÿ">
                    <button class="scan-btn" onclick="confirmDispatchPallet()"><i class="fa-solid fa-check"></i></button>
                </div>
                <p class="scan-hint">ç¬¬ä¸€æ­¥ï¼šæƒæè¦ç§»å‹•çš„æ¿è™Ÿ</p>
            </div>
            
            <!-- Step 2: æƒæç›®æ¨™å„²ä½ -->
            <div id="dispatch-step2" style="display:none;">
                <div class="step-indicator">
                    <span class="step-badge done">âœ“</span><span class="step-text done">æ¿è™Ÿå·²æƒ</span>
                    <span class="step-arrow">â†’</span>
                    <span class="step-badge active">2</span><span class="step-text active">æƒæç›®æ¨™å„²ä½</span>
                </div>
                <div class="task-info-card">
                    <div class="task-row"><span class="label">å·²ç¢ºèªæ¿è™Ÿ</span><span class="value" id="dispatch-confirmed-pallet">-</span></div>
                    <div class="task-row highlight"><span class="label">ğŸ“ è«‹ç§»å‹•åˆ°</span><span class="value" id="dispatch-target-confirm">-</span></div>
                </div>
                <div class="scan-row">
                    <input type="text" id="dispatch-location-scan" class="scan-input" placeholder="æƒæç›®æ¨™å„²ä½æ¢ç¢¼">
                    <button class="scan-btn" onclick="confirmDispatchLocation()"><i class="fa-solid fa-check"></i></button>
                </div>
                <p class="scan-hint">ç¬¬äºŒæ­¥ï¼šæ”¾ç½®è²¨ç‰©å¾Œï¼Œæƒæå„²ä½æ¢ç¢¼ç¢ºèª</p>
                <button class="cancel-btn" onclick="resetDispatchStep()"><i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ</button>
            </div>
            <div id="dispatch-scan-result" class="scan-result"></div>
        </div>
        <div class="list-section">
            <div class="list-header"><h4>èª¿åº¦ä»»å‹™</h4><span class="list-progress" id="dispatch-progress">0/0</span></div>
            <div id="dispatch-list"><div class="loading"><i class="fa-solid fa-spinner"></i> è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>
    
    <!-- åº«å­˜å¿«æŸ¥é é¢ -->
    <div id="page-query" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">åº«å­˜å¿«æŸ¥</span>
        </header>
        <div class="scan-section">
            <div class="scan-row">
                <input type="text" id="query-input" class="scan-input" placeholder="è¼¸å…¥å“åã€æ‰¹è™Ÿæˆ–æ¿è™Ÿ" oninput="doInventoryQuery()">
                <button class="scan-btn" onclick="doInventoryQuery()"><i class="fa-solid fa-search"></i></button>
            </div>
        </div>
        <div class="list-section">
            <div class="list-header"><h4>æŸ¥è©¢çµæœ</h4><span class="list-progress" id="query-count">0 ç­†</span></div>
            <div id="query-list"><p style="text-align:center; color:#64748b; padding:40px;">è¼¸å…¥é—œéµå­—æœå°‹</p></div>
        </div>
    </div>
(0, 50).map(item => `
                    <div class="list-item">
                        <div class="list-item-header">
                            <span class="list-item-title">${item.productName || '-'}</span>
                            <span class="list-item-status pending">${item.quantity || 0} ä»¶</span>
                        </div>
                        <div class="list-item-detail">${item.spec || ''} | æ‰¹è™Ÿ: ${item.batchNo || '-'} | æ•ˆæœŸ: ${item.expDate || '-'}</div>
                        <div class="list-item-location"><i class="fa-solid fa-location-dot"></i> ${item.locationId || '-'} | <i class="fa-solid fa-barcode"></i> ${item.palletId || '-'}</div>
                    </div>
                `).join('');
            });
        }
        
        // ==================== æ“ä½œæ—¥èªŒ ====================
        function logOperation(type, data) {
            db.collection('operationLogs').add({
                type: type,
                operatorId: currentOperator.id,
                operatorName: currentOperator.name,
                timestamp: new Date().toISOString(),
                deviceInfo: navigator.userAgent,
                data: data
            }).catch(err => console.error('Log error:', err));
        }
        
        function logQtyDifference(task, actualQty, diff, reason) {
            db.collection('qtyDifferences').add({
                type: 'qty_difference',
                taskId: task.id,
                productName: task.productName,
                locationId: task.locationId,
                palletId: task.palletId,
                requiredQty: task.pickQty,
                actualQty: actualQty,
                difference: diff,
                reason: reason,
                operatorId: currentOperator.id,
                operatorName: currentOperator.name,
                timestamp: new Date().toISOString()
            }).catch(err => console.error('Diff log error:', err));
        }
        
        // ==================== å·¥å…·å‡½æ•¸ ====================
        function showResult(el, message, type) {
            el.innerText = message;
            el.className = 'scan-result ' + type;
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }
        
        function vibrate(pattern) {
            if (navigator.vibrate) navigator.vibrate(pattern);
        }
        
        function playSuccessSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = 1200; osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.15);
            } catch(e) {}
        }
        
        function playErrorSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = 300; osc.type = 'sine';
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.3);
            } catch(e) {}
        }
        
        // ==================== åˆå§‹åŒ– ====================
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                currentOperator = { id: user.uid, name: user.email.split('@')[0], email: user.email };
                showApp();
            } else {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('app-container').classList.remove('active');
            }
        });
        
        setInterval(updateOperatorDisplay, 60000);
    </script>
</body>
</html>