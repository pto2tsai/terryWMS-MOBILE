<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Terry WMS æ‰‹æ©Ÿç‰ˆ</title>
    <link rel="manifest" href="data:application/json,{'name':'Terry WMS','short_name':'WMS','start_url':'.','display':'standalone','background_color':'%230f172a','theme_color':'%230f172a'}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ç™»å…¥é  */
        .login-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%);
        }
        .login-logo { font-size: 48px; color: #3b82f6; margin-bottom: 10px; }
        .login-title { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .login-subtitle { color: #64748b; font-size: 14px; margin-bottom: 30px; }
        .login-box {
            width: 100%;
            max-width: 320px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 24px;
        }
        .login-input {
            width: 100%;
            padding: 14px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            margin-bottom: 12px;
        }
        .login-input:focus { outline: none; border-color: #3b82f6; }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: #3b82f6;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .login-btn:active { background: #2563eb; }
        .login-error { color: #f87171; font-size: 14px; margin-bottom: 12px; display: none; }
        
        /* ä¸»é é¢ */
        .app-container { display: none; min-height: 100vh; flex-direction: column; }
        .app-container.active { display: flex; }
        
        /* é ‚éƒ¨ */
        .app-header {
            background: #1e293b;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #334155;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-logo { display: flex; align-items: center; gap: 8px; }
        .app-logo i { color: #3b82f6; font-size: 20px; }
        .app-logo span { font-weight: bold; font-size: 16px; }
        .user-info { display: flex; align-items: center; gap: 8px; }
        .user-name { font-size: 12px; color: #94a3b8; }
        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #f87171;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        /* ä¸»é¸å–® */
        .main-menu {
            flex: 1;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .menu-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .menu-card:active {
            transform: scale(0.98);
        }
        .menu-card.picking { border-color: #3b82f6; }
        .menu-card.inbound { border-color: #10b981; }
        .menu-card.dispatch { border-color: #f59e0b; }
        .menu-card.query { border-color: #8b5cf6; }
        
        .menu-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .menu-card.picking .menu-icon { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .menu-card.inbound .menu-icon { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .menu-card.dispatch .menu-icon { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .menu-card.query .menu-icon { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        
        .menu-text h3 { font-size: 18px; margin-bottom: 4px; }
        .menu-text p { font-size: 13px; color: #94a3b8; }
        .menu-arrow { margin-left: auto; color: #475569; font-size: 20px; }
        .menu-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
        }
        .menu-icon { position: relative; }
        
        /* åŠŸèƒ½é é¢ */
        .func-page {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            background: #0f172a;
        }
        .func-page.active { display: flex; }
        
        .func-header {
            background: #1e293b;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #334155;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .back-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            padding: 8px;
            cursor: pointer;
        }
        .func-title { font-size: 18px; font-weight: bold; }
        
        /* æƒæå€ */
        .scan-section {
            background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
            padding: 20px 16px;
            text-align: center;
        }
        .scan-input-wrap {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .scan-input {
            flex: 1;
            padding: 14px 16px;
            background: #0f172a;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            color: #fff;
            font-size: 18px;
            text-align: center;
        }
        .scan-input:focus { outline: none; border-color: #60a5fa; }
        .scan-btn {
            padding: 14px 20px;
            background: #3b82f6;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
        }
        .scan-btn:active { background: #2563eb; }
        .scan-hint { color: #64748b; font-size: 13px; }
        /* å¿«æ·æ•¸é‡æŒ‰éˆ• */
        .qty-btn {
            padding: 12px 8px;
            background: #1e40af;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .qty-btn:active { background: #1d4ed8; transform: scale(0.95); }
        
        .scan-result {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        .scan-result.success { display: block; background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .scan-result.error { display: block; background: rgba(239, 68, 68, 0.2); color: #f87171; }
        
        /* æ¸…å–®å€ */
        .list-section {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .list-header h4 { font-size: 16px; color: #94a3b8; }
        .list-progress { font-size: 14px; color: #10b981; font-weight: bold; }
        
        .list-item {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
        }
        .list-item.completed { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .list-item.shortage { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; }
        .item-location { font-size: 20px; font-weight: bold; color: #3b82f6; font-family: monospace; }
        .item-status { font-size: 12px; padding: 4px 8px; border-radius: 6px; }
        .item-status.pending { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .item-status.done { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .item-status.shortage { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .item-product { font-size: 15px; color: #fff; margin: 8px 0 4px; }
        .item-detail { font-size: 13px; color: #64748b; }
        .item-qty { font-size: 24px; font-weight: bold; color: #fbbf24; text-align: right; }
        
        /* é¸æ“‡å™¨ */
        .selector-section { padding: 16px; }
        .selector-label { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
        .selector-input {
            width: 100%;
            padding: 14px 16px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
        }
        
        /* åº«å­˜æŸ¥è©¢çµæœ */
        .query-result {
            padding: 16px;
        }
        .result-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .result-product { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
        .result-spec { font-size: 14px; color: #64748b; margin-bottom: 12px; }
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-top: 1px solid #334155;
        }
        .result-loc { font-family: monospace; color: #3b82f6; font-weight: bold; }
        .result-qty { color: #fbbf24; font-weight: bold; }
        
        /* åº•éƒ¨æ“ä½œ */
        .bottom-actions {
            padding: 16px;
            background: #1e293b;
            border-top: 1px solid #334155;
        }
        .action-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .action-btn:last-child { margin-bottom: 0; }
        .action-btn.primary { background: #3b82f6; color: #fff; }
        .action-btn.success { background: #10b981; color: #fff; }
        .action-btn.secondary { background: #334155; color: #fff; }
        .action-btn:active { opacity: 0.8; }
        
        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }
        
        /* è¼‰å…¥ä¸­ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        .loading i { font-size: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* éš±è— */
        .hidden { display: none !important; }
    
        /* ç›¸æ©Ÿæƒæ */
        .camera-btn {
            padding: 14px 16px;
            background: #10b981;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        .camera-btn:active { background: #059669; }
        .camera-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            flex-direction: column;
        }
        .camera-modal.active { display: flex; }
        .camera-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e293b;
        }
        .camera-header h3 { font-size: 18px; }
        .camera-close {
            background: #ef4444;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
        }
        .camera-preview {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #qr-reader {
            width: 100%;
            max-width: 400px;
        }
        #qr-reader video {
            border-radius: 12px;
        }
        .camera-hint {
            padding: 16px;
            text-align: center;
            color: #94a3b8;
            background: #1e293b;
        }
    
        /* å¤§å­—é«”æ¨¡å¼ - é©åˆå †é«˜æ©Ÿæ‰‹ */
        .scan-input { font-size: 20px !important; padding: 16px !important; }
        .menu-card h3 { font-size: 20px !important; }
        .func-title { font-size: 22px !important; }
        /* å¿«æ·æ•¸é‡æŒ‰éˆ• */
        .qty-btn {
            padding: 12px 8px;
            background: #1e40af;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .qty-btn:active { background: #1d4ed8; transform: scale(0.95); }
        
        .scan-result { font-size: 16px !important; }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <!-- ç™»å…¥é  -->
    <div id="login-page" class="login-page">
        <i class="fa-solid fa-warehouse login-logo"></i>
        <h1 class="login-title">Terry WMS</h1>
        <p class="login-subtitle">å€‰å„²ç®¡ç†ç³»çµ± - æ‰‹æ©Ÿç‰ˆ</p>
        <div class="login-box">
            <input type="email" id="login-email" class="login-input" placeholder="Email" value="admin@bafang.com">
            <input type="password" id="login-pwd" class="login-input" placeholder="å¯†ç¢¼" value="123456">
            <div id="login-error" class="login-error"></div>
            <button onclick="doLogin()" class="login-btn">
                <i class="fa-solid fa-right-to-bracket"></i> ç™»å…¥
            </button>
        </div>
    </div>
    
    <!-- ä¸»é é¢ -->
    <div id="app-main" class="app-container">
        <header class="app-header">
            <div class="app-logo">
                <i class="fa-solid fa-warehouse"></i>
                <span>Terry WMS</span>
            </div>
            <div class="user-info">
                <span class="user-name" id="display-user">-</span>
                <button onclick="doLogout()" class="logout-btn">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
        </header>
        
        <div class="main-menu">
            <!-- å››å¤§æ ¸å¿ƒåŠŸèƒ½ -->
            <div class="menu-card inbound" onclick="showInboundOptions()" style="background:linear-gradient(135deg,#065f46,#047857);">
                <div class="menu-icon">
                    <i class="fa-solid fa-arrow-down"></i>
                    <span class="menu-badge" id="badge-inbound" style="display:none">0</span>
                </div>
                <div class="menu-text">
                    <h3>å…¥åº«</h3>
                    <p>ä»»å‹™åˆ—è¡¨ / ç›´æ¥æƒæ</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <div class="menu-card outbound" onclick="openPage('scan-outbound')" style="background:linear-gradient(135deg,#9a3412,#ea580c);">
                <div class="menu-icon"><i class="fa-solid fa-arrow-up"></i></div>
                <div class="menu-text">
                    <h3>å‡ºåº«</h3>
                    <p>æƒææ’å–® â†’ è¼¸å…¥æ•¸é‡</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <div class="menu-card move" onclick="openPage('scan-move')" style="background:linear-gradient(135deg,#1e40af,#3b82f6);">
                <div class="menu-icon">
                    <i class="fa-solid fa-dolly"></i>
                    <span class="menu-badge" id="badge-move" style="display:none">0</span>
                </div>
                <div class="menu-text">
                    <h3>ç§»æ¿</h3>
                    <p>å·¥å–®åˆ—è¡¨ / ç›´æ¥æƒæ</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <div class="menu-card merge" onclick="openPage('scan-merge')" style="background:linear-gradient(135deg,#6b21a8,#a855f7);">
                <div class="menu-icon">
                    <i class="fa-solid fa-compress"></i>
                    <span class="menu-badge" id="badge-merge" style="display:none">0</span>
                </div>
                <div class="menu-text">
                    <h3>ä½µæ¿</h3>
                    <p>å·¥å–®åˆ—è¡¨ / ç›´æ¥æƒæ</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <!-- åˆ†éš”ç·š -->
            <div style="padding:10px 16px;color:#64748b;font-size:12px;border-top:1px solid #334155;margin-top:8px;">å…¶ä»–åŠŸèƒ½</div>
            
            <div class="menu-card picking" onclick="openPage('picking')">
                <div class="menu-icon">
                    <i class="fa-solid fa-barcode"></i>
                    <span class="menu-badge" id="badge-picking" style="display:none">0</span>
                </div>
                <div class="menu-text">
                    <h3>æ³¢æ¬¡æ€è²¨</h3>
                    <p>ä¾æ³¢æ¬¡æ‰¹é‡å‡ºåº«</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
            
            <!-- èª¿åº¦å·¥å–®å·²æ•´åˆåˆ°ç§»æ¿/ä½µæ¿åŠŸèƒ½ä¸­ -->
            
            <div class="menu-card query" onclick="openPage('query')">
                <div class="menu-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                <div class="menu-text">
                    <h3>åº«å­˜å¿«æŸ¥</h3>
                    <p>æŸ¥è©¢å“é …ä½ç½®</p>
                </div>
                <i class="fa-solid fa-chevron-right menu-arrow"></i>
            </div>
        </div>
        
        <!-- å…¥åº«é¸é … Modal -->
        <div id="inbound-options-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:200;padding:20px;align-items:center;justify-content:center;">
            <div style="background:#1e293b;border-radius:16px;padding:20px;width:100%;max-width:320px;">
                <h3 style="color:white;font-size:18px;font-weight:bold;text-align:center;margin-bottom:16px;">
                    <i class="fa-solid fa-arrow-down" style="color:#10b981;margin-right:8px;"></i>é¸æ“‡å…¥åº«æ¨¡å¼
                </h3>
                <div style="display:flex;flex-direction:column;gap:12px;">
                    <button onclick="openPage('inbound');hideInboundOptions();" style="padding:16px;background:linear-gradient(135deg,#065f46,#047857);border:none;border-radius:12px;color:white;font-size:16px;font-weight:bold;text-align:left;display:flex;align-items:center;gap:12px;">
                        <i class="fa-solid fa-list-check" style="font-size:24px;"></i>
                        <div>
                            <div>ä»»å‹™åˆ—è¡¨å…¥åº«</div>
                            <div style="font-size:12px;color:#6ee7b7;font-weight:normal;">å¾å¾…è¾¦ä»»å‹™ä¸­é¸æ“‡</div>
                        </div>
                    </button>
                    <button onclick="openPage('scan-inbound');hideInboundOptions();" style="padding:16px;background:linear-gradient(135deg,#0e7490,#06b6d4);border:none;border-radius:12px;color:white;font-size:16px;font-weight:bold;text-align:left;display:flex;align-items:center;gap:12px;">
                        <i class="fa-solid fa-qrcode" style="font-size:24px;"></i>
                        <div>
                            <div>ç›´æ¥æƒæå…¥åº«</div>
                            <div style="font-size:12px;color:#a5f3fc;font-weight:normal;">æƒå„²ä½â†’æƒæ’å–®â†’ç¢ºèª</div>
                        </div>
                    </button>
                    <button onclick="hideInboundOptions();" style="padding:12px;background:#334155;border:none;border-radius:10px;color:#94a3b8;font-size:14px;">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ€è²¨æƒæé  -->
    <div id="page-picking" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">æ€è²¨æƒæ</span>
        </header>
        
        <div class="selector-section">
            <div class="selector-label">é¸æ“‡æ³¢æ¬¡</div>
            <select id="picking-wave-select" class="selector-input" onchange="loadPickingWave()">
                <option value="">-- è«‹é¸æ“‡ --</option>
            </select>
        </div>
        
        <div class="scan-section" id="picking-scan-area" style="display:none">
            <!-- ç•¶å‰æ€è²¨é …ç›®è³‡è¨Š -->
            <div id="picking-current-item" style="background:#1e3a5f;border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="color:#94a3b8;">å“å</span>
                    <span id="picking-item-product" style="color:white;font-weight:bold;">-</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="color:#94a3b8;">æ‰¹è™Ÿ</span>
                    <span id="picking-item-batch" style="color:#f59e0b;">-</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                    <span style="color:#94a3b8;">éœ€æ€æ•¸é‡</span>
                    <span id="picking-item-qty" style="color:#22c55e;font-size:20px;font-weight:bold;">-</span>
                </div>
                <div style="display:flex;justify-content:space-between;background:rgba(59,130,246,0.2);margin:-12px;margin-top:8px;padding:12px;border-radius:0 0 10px 10px;">
                    <span style="color:#3b82f6;font-weight:bold;">ğŸ“ å„²ä½</span>
                    <span id="picking-item-location" style="color:#3b82f6;font-size:18px;font-weight:bold;">-</span>
                </div>
            </div>
            
            <!-- Step 1: æƒæå„²ä½ -->
            <div id="picking-step1">
                <div style="background:rgba(59,130,246,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#3b82f6;font-weight:bold;">æ­¥é©Ÿ 1/3</span> - æƒæå„²ä½ç¢ºèª
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="picking-location-scan" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥å¦‚ IA011" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'location', function(){ confirmPickingLocation(); })"
                           onkeypress="if(event.keyCode==13){confirmPickingLocation();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('picking-location-scan')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 2: æƒææ¿è™Ÿ -->
            <div id="picking-step2" style="display:none;">
                <div style="background:rgba(168,85,247,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#a855f7;font-weight:bold;">æ­¥é©Ÿ 2/3</span> - æƒææ¿è™Ÿç¢ºèª
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="picking-pallet-scan" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥æ£§æ¿ç·¨è™Ÿ" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ confirmPickingPallet(); })"
                           onkeypress="if(event.keyCode==13){confirmPickingPallet();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('picking-pallet-scan')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 3: ç¢ºèªæ•¸é‡ -->
            <div id="picking-step3" style="display:none;">
                <div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#22c55e;font-weight:bold;">æ­¥é©Ÿ 3/3</span> - ç¢ºèªæ€è²¨æ•¸é‡
                </div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <input type="number" id="picking-qty-input" class="scan-input" style="flex:1;text-align:center;font-size:24px;font-weight:bold;" placeholder="0">
                    <button onclick="confirmPickingQty()" style="padding:14px 24px;background:#22c55e;border:none;border-radius:10px;color:white;font-weight:bold;font-size:16px;">
                        <i class="fa-solid fa-check"></i> ç¢ºèª
                    </button>
                </div>
                <p class="scan-hint" style="text-align:center;margin-top:8px;">è«‹è¼¸å…¥å¯¦éš›æ€è²¨æ•¸é‡</p>
            </div>
            
            <button onclick="resetPickingScan()" style="width:100%;padding:10px;background:transparent;border:1px solid #475569;border-radius:8px;color:#94a3b8;margin-top:10px;cursor:pointer;">
                <i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ / è·³éæ­¤é …
            </button>
            
            <div id="picking-scan-result" class="scan-result"></div>
        </div>
        
        <div class="list-section" id="picking-list-area">
            <div class="list-header">
                <h4>æ€è²¨æ¸…å–®</h4>
                <span class="list-progress" id="picking-progress">0/0</span>
            </div>
            <div id="picking-list">
                <div class="empty-state">
                    <i class="fa-solid fa-clipboard-list"></i>
                    <p>è«‹å…ˆé¸æ“‡æ³¢æ¬¡</p>
                </div>
            </div>
        </div>
        
        <div class="bottom-actions" id="picking-actions" style="display:none">
            <button class="action-btn success" onclick="completePickingWave()">
                <i class="fa-solid fa-flag-checkered"></i> å®Œæˆæ³¢æ¬¡
            </button>
        </div>
    </div>
    
    <!-- å…¥åº«ç¢ºèªé  -->
    <div id="page-inbound" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">å…¥åº«ç¢ºèª</span>
        </header>
        
        <div class="scan-section">
            <!-- Step 1: æƒææ¿è™Ÿ -->
            <div id="inbound-step1">
                <div style="background:rgba(59,130,246,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#3b82f6;font-weight:bold;">æ­¥é©Ÿ 1/2</span> - æƒææ¿è™Ÿ
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="inbound-pallet-scan" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥æ£§æ¿ç·¨è™Ÿ" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ confirmInboundPallet(); })"
                           onkeypress="if(event.keyCode==13){confirmInboundPallet();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('inbound-pallet-scan')"><i class="fa-solid fa-camera"></i></button>
                </div>
                <p class="scan-hint">æƒææ¿è™Ÿï¼Œæˆ–å¾ä¸‹æ–¹ä»»å‹™åˆ—è¡¨é»æ“ŠåŸ·è¡Œ</p>
            </div>
            
            <!-- Step 2: æƒæå„²ä½ -->
            <div id="inbound-step2" style="display:none;">
                <div style="background:rgba(34,197,94,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#22c55e;font-weight:bold;">æ­¥é©Ÿ 2/2</span> - æƒæå„²ä½ç¢ºèª
                </div>
                <div style="background:#1e3a5f;border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#94a3b8;">å“å</span>
                        <span id="inbound-show-product" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#94a3b8;">æ•¸é‡</span>
                        <span id="inbound-show-qty" style="color:white;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;background:rgba(34,197,94,0.2);margin:-12px;margin-top:8px;padding:12px;border-radius:0 0 10px 10px;">
                        <span style="color:#22c55e;font-weight:bold;">ğŸ“ æŒ‡å®šå„²ä½</span>
                        <span id="inbound-show-location" style="color:#22c55e;font-size:18px;font-weight:bold;">-</span>
                    </div>
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="inbound-location-scan" class="scan-input" placeholder="æƒæå„²ä½ å¦‚:IA011" 
                           oninput="autoFormatAndCheck(this, 'location', function(){ confirmInboundLocation(); })"
                           onkeypress="if(event.keyCode==13){confirmInboundLocation();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('inbound-location-scan')"><i class="fa-solid fa-camera"></i></button>
                </div>
                <p class="scan-hint">æƒææˆ–è¼¸å…¥å„²ä½ï¼ˆè‡ªå‹•åˆ¤æ–·ï¼‰</p>
                <button onclick="resetInboundStep()" style="width:100%;padding:10px;background:transparent;border:1px solid #475569;border-radius:8px;color:#94a3b8;margin-top:10px;cursor:pointer;">
                    <i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ
                </button>
            </div>
            
            <div id="inbound-scan-result" class="scan-result"></div>
        </div>
        
        <!-- å…¥åº«ç¢ºèª Modal -->
        <div id="inbound-confirm-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:200;padding:20px;align-items:center;justify-content:center;">
            <div style="background:#1e293b;border-radius:16px;padding:20px;width:100%;max-width:340px;border:2px solid #3b82f6;">
                <h3 style="color:white;font-size:18px;font-weight:bold;text-align:center;margin-bottom:16px;">
                    <i class="fa-solid fa-clipboard-check" style="color:#3b82f6;margin-right:8px;"></i>ç¢ºèªå…¥åº«è³‡æ–™
                </h3>
                
                <!-- æ¿è™Ÿå¤§å­—é¡¯ç¤º -->
                <div style="background:#0f172a;border:2px solid #f59e0b;border-radius:12px;padding:16px;text-align:center;margin-bottom:16px;">
                    <div style="color:#94a3b8;font-size:12px;margin-bottom:4px;">æ¿è™Ÿ / å–®è™Ÿ</div>
                    <div id="confirm-pallet-id" style="color:#fbbf24;font-size:28px;font-weight:bold;font-family:monospace;letter-spacing:1px;">-</div>
                </div>
                
                <!-- å…¶ä»–è³‡è¨Š -->
                <div style="background:#0f172a;border-radius:10px;padding:12px;margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155;">
                        <span style="color:#94a3b8;">å“åè¦æ ¼</span>
                        <span id="confirm-product-name" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155;">
                        <span style="color:#94a3b8;">æ•¸é‡</span>
                        <span id="confirm-quantity" style="color:#10b981;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #334155;">
                        <span style="color:#94a3b8;">æ‰¹è™Ÿ</span>
                        <span id="confirm-batch" style="color:white;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px 0;">
                        <span style="color:#94a3b8;">æŒ‡å®šå„²ä½</span>
                        <span id="confirm-location" style="color:#3b82f6;font-weight:bold;font-size:16px;">-</span>
                    </div>
                </div>
                
                <!-- æŒ‰éˆ• -->
                <div style="display:flex;gap:12px;">
                    <button onclick="cancelInboundConfirm()" style="flex:1;padding:14px;background:#475569;border:none;border-radius:10px;color:white;font-size:16px;font-weight:bold;">
                        å–æ¶ˆ
                    </button>
                    <button onclick="confirmInboundTaskAndProceed()" style="flex:2;padding:14px;background:#10b981;border:none;border-radius:10px;color:white;font-size:16px;font-weight:bold;">
                        <i class="fa-solid fa-check" style="margin-right:6px;"></i>ç¢ºèªï¼Œå‰å¾€å„²ä½
                    </button>
                </div>
            </div>
        </div>
        
        <div class="list-section">
            <div class="list-header">
                <h4>ğŸ‘‡ é»æ“Šä»»å‹™ç›´æ¥åŸ·è¡Œ</h4>
                <span class="list-progress" id="inbound-count">0 ç­†</span>
            </div>
            <div id="inbound-list">
                <div class="loading"><i class="fa-solid fa-spinner"></i></div>
            </div>
        </div>
    </div>
    
    <!-- èª¿åº¦åŸ·è¡Œé  -->
    <div id="page-dispatch" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">èª¿åº¦åŸ·è¡Œ</span>
        </header>
        
        <div class="selector-section">
            <div class="selector-label">é¸æ“‡å·¥å–®</div>
            <select id="dispatch-order-select" class="selector-input" onchange="loadDispatchOrder()">
                <option value="">-- è«‹é¸æ“‡ --</option>
            </select>
        </div>
        
        <div class="scan-section" id="dispatch-scan-area" style="display:none">
            <div class="scan-input-wrap">
                <input type="text" id="dispatch-scan" class="scan-input" placeholder="æƒææ¿è™Ÿç¢ºèª">
                <button class="camera-btn" onclick="openCameraScanner('dispatch-scan')"><i class="fa-solid fa-camera"></i></button>
                <button class="scan-btn" onclick="confirmDispatchScan()"><i class="fa-solid fa-check"></i></button>
            </div>
            <p class="scan-hint">æƒææ¿è™Ÿç¢ºèªåŸ·è¡Œ</p>
            <div id="dispatch-scan-result" class="scan-result"></div>
        </div>
        
        <div class="list-section" id="dispatch-list-area">
            <div class="list-header">
                <h4>èª¿åº¦æ¸…å–®</h4>
                <span class="list-progress" id="dispatch-progress">0/0</span>
            </div>
            <div id="dispatch-list">
                <div class="empty-state">
                    <i class="fa-solid fa-clipboard-list"></i>
                    <p>è«‹å…ˆé¸æ“‡å·¥å–®</p>
                </div>
            </div>
        </div>
        
        <div class="bottom-actions" id="dispatch-actions" style="display:none">
            <button class="action-btn success" onclick="completeDispatchOrder()">
                <i class="fa-solid fa-flag-checkered"></i> å®Œæˆå·¥å–®
            </button>
        </div>
    </div>
    
    <!-- åº«å­˜å¿«æŸ¥é  -->
    <div id="page-query" class="func-page">
        <header class="func-header">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">åº«å­˜å¿«æŸ¥</span>
        </header>
        
        <div class="scan-section">
            <div class="scan-input-wrap">
                <input type="text" id="query-input" class="scan-input" placeholder="è¼¸å…¥å“åæˆ–æ¿è™Ÿ">
                <button class="camera-btn" onclick="openCameraScanner('query-input')"><i class="fa-solid fa-camera"></i></button>
                <button class="scan-btn" onclick="doInventoryQuery()"><i class="fa-solid fa-search"></i></button>
            </div>
            <p class="scan-hint">æ”¯æ´æ¨¡ç³Šæœå°‹</p>
        </div>
        
        <div class="query-result" id="query-result">
            <div class="empty-state">
                <i class="fa-solid fa-box-open"></i>
                <p>è¼¸å…¥é—œéµå­—æœå°‹åº«å­˜</p>
            </div>
        </div>
    </div>

    
    <!-- ========== å…¥åº«æƒæé  (æ–°ç‰ˆæµç¨‹) ========== -->
    <div id="page-scan-inbound" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#065f46,#047857);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">å…¥åº«ä½œæ¥­</span>
        </header>
        
        <div class="scan-section">
            <div style="text-align:center;color:#6ee7b7;font-size:13px;margin-bottom:16px;">
                æƒæå„²ä½ â†’ æƒææ’å–® â†’ å®Œæˆç¶å®š
            </div>
            
            <!-- Step 1: æƒæå„²ä½ -->
            <div id="scan-in-step1">
                <div style="background:rgba(16,185,129,0.15);border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                    <div style="color:#10b981;font-size:14px;margin-bottom:4px;">æ­¥é©Ÿ 1</div>
                    <div style="color:#6ee7b7;font-size:20px;font-weight:bold;">ğŸ“ æƒæå„²ä½æ¢ç¢¼</div>
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-in-location" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥å¦‚ IA011" style="text-transform:uppercase;" 
                           oninput="autoFormatAndCheck(this, 'location', function(){ scanInboundStep1(); })"
                           onkeypress="if(event.keyCode==13){scanInboundStep1();return false;}" autofocus>
                    <button class="camera-btn" onclick="openCameraScanner('scan-in-location')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 2: æƒææ’å–® -->
            <div id="scan-in-step2" style="display:none;">
                <div style="background:rgba(16,185,129,0.2);border:1px solid #10b981;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="color:#6ee7b7;">âœ… å„²ä½</span>
                        <span id="scan-in-loc-display" style="color:#10b981;font-size:20px;font-weight:bold;">-</span>
                    </div>
                </div>
                <div style="background:rgba(59,130,246,0.15);border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                    <div style="color:#3b82f6;font-size:14px;margin-bottom:4px;">æ­¥é©Ÿ 2</div>
                    <div style="color:#93c5fd;font-size:20px;font-weight:bold;">ğŸ“¦ æƒææ£§æ¿æ’å–®</div>
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-in-pallet" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥æ£§æ¿ç·¨è™Ÿ" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanInboundStep2(); })"
                           onkeypress="if(event.keyCode==13){scanInboundStep2();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('scan-in-pallet')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 3: ç¢ºèªä»¶æ•¸ -->
            <div id="scan-in-step3" style="display:none;">
                <div style="background:rgba(16,185,129,0.2);border:1px solid #10b981;border-radius:10px;padding:10px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;font-size:13px;">
                        <span style="color:#6ee7b7;">âœ… å„²ä½</span>
                        <span id="scan-in-loc-display2" style="color:#10b981;font-weight:bold;">-</span>
                    </div>
                </div>
                <div style="background:rgba(245,158,11,0.15);border-radius:12px;padding:16px;margin-bottom:16px;text-align:center;">
                    <div style="color:#f59e0b;font-size:14px;margin-bottom:4px;">æ­¥é©Ÿ 3</div>
                    <div style="color:#fcd34d;font-size:20px;font-weight:bold;">âœï¸ ç¢ºèªä»¶æ•¸</div>
                </div>
                <div style="background:#1e3a5f;border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="color:#94a3b8;">å“å</span>
                        <span id="scan-in-product-name" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                        <span style="color:#94a3b8;">è¦æ ¼</span>
                        <span id="scan-in-spec" style="color:white;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span style="color:#94a3b8;">æ‰¹è™Ÿ</span>
                        <span id="scan-in-batch" style="color:white;">-</span>
                    </div>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="color:#94a3b8;font-size:13px;display:block;margin-bottom:6px;">å…¥åº«ä»¶æ•¸</label>
                    <input type="number" id="scan-in-qty-input" class="scan-input" placeholder="è¼¸å…¥ä»¶æ•¸" inputmode="numeric" style="font-size:24px;text-align:center;font-weight:bold;">
                </div>
                <button onclick="confirmScanInbound()" style="width:100%;padding:16px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:12px;color:white;font-size:18px;font-weight:bold;cursor:pointer;">
                    <i class="fa-solid fa-check-circle"></i> ç¢ºèªå…¥åº«
                </button>
            </div>
            
            <div id="scan-in-result" class="scan-result"></div>
            
            <button onclick="resetScanInbound()" style="width:100%;padding:16px;background:#dc2626;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                <i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ
            </button>
        </div>
    </div>
    
    <!-- ========== å‡ºåº«æƒæé  ========== -->
    <div id="page-scan-outbound" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#9a3412,#ea580c);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">å‡ºåº«ä½œæ¥­</span>
        </header>
        
        <div class="scan-section">
            <div style="text-align:center;color:#fdba74;font-size:13px;margin-bottom:16px;">
                æƒææ’å–® â†’ è¼¸å…¥æ•¸é‡ â†’ å®Œæˆå‡ºåº«
            </div>
            
            <!-- Step 1: æƒææ’å–® -->
            <div id="scan-out-step1">
                <div style="background:rgba(234,88,12,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#ea580c;font-weight:bold;">æ­¥é©Ÿ 1</span> - æƒææ£§æ¿æ’å–®
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-out-pallet" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥æ£§æ¿ç·¨è™Ÿ" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanOutboundStep1(); })"
                           onkeypress="if(event.keyCode==13){scanOutboundStep1();return false;}" autofocus>
                    <button class="camera-btn" onclick="openCameraScanner('scan-out-pallet')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 2: è¼¸å…¥æ•¸é‡ -->
            <div id="scan-out-step2" style="display:none;">
                <div style="background:rgba(234,88,12,0.2);border:1px solid #ea580c;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="text-align:center;">
                        <div id="scan-out-product" style="color:white;font-size:18px;font-weight:bold;">-</div>
                        <div id="scan-out-spec" style="color:#94a3b8;font-size:14px;">-</div>
                        <div style="margin-top:8px;">
                            <span style="color:#fdba74;">åº«å­˜ï¼š</span>
                            <span id="scan-out-stock" style="color:#fbbf24;font-size:24px;font-weight:bold;">0</span>
                            <span style="color:#fdba74;"> ä»¶</span>
                        </div>
                        <div style="color:#64748b;font-size:12px;margin-top:4px;">å„²ä½ï¼š<span id="scan-out-loc">-</span></div>
                    </div>
                </div>
                <div style="background:rgba(239,68,68,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#ef4444;font-weight:bold;">æ­¥é©Ÿ 2</span> - é¸æ“‡æˆ–è¼¸å…¥å‡ºåº«æ•¸é‡
                </div>
                <!-- å¿«é€Ÿæ•¸é‡æŒ‰éˆ• -->
                <div id="scan-out-quick-btns" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;">
                </div>
                <div style="display:flex;gap:10px;margin-bottom:12px;">
                    <input type="number" id="scan-out-qty" class="scan-input" style="flex:1;text-align:center;font-size:28px;font-weight:bold;" placeholder="0"
                           onkeyup="if(event.keyCode===13) executeScanOutbound();">
                    <button onclick="scanOutboundAll()" style="padding:14px 20px;background:#ef4444;border:none;border-radius:10px;color:white;font-weight:bold;font-size:16px;">å…¨å‡º</button>
                </div>
                <button onclick="executeScanOutbound()" style="width:100%;padding:16px;background:#ea580c;border:none;border-radius:10px;color:white;font-size:18px;font-weight:bold;">
                    <i class="fa-solid fa-check"></i> ç¢ºèªå‡ºåº«
                </button>
            </div>
            
            <div id="scan-out-result" class="scan-result"></div>
            
            <button onclick="resetScanOutbound()" style="width:100%;padding:16px;background:#dc2626;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                <i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ
            </button>
        </div>
    </div>
    
    <!-- ========== ç§»æ¿æƒæé  ========== -->
    <div id="page-scan-move" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#1e40af,#3b82f6);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">ç§»æ¿ä½œæ¥­</span>
        </header>
        
        <!-- å¾…è¾¦ç§»æ¿å·¥å–® -->
        <div id="move-orders-section" class="list-section" style="max-height:200px;overflow-y:auto;padding:12px;border-bottom:1px solid #334155;">
            <div class="list-header" style="margin-bottom:8px;">
                <h4 style="font-size:14px;"><i class="fa-solid fa-clipboard-list mr-1 text-blue-400"></i>å¾…è¾¦ç§»æ¿å·¥å–®</h4>
                <span class="list-progress" id="move-orders-count">0 ç­†</span>
            </div>
            <div id="move-orders-list">
                <div style="text-align:center;color:#64748b;font-size:13px;padding:12px;">ç„¡å¾…è¾¦å·¥å–®</div>
            </div>
        </div>
        
        <div class="scan-section">
            <div style="text-align:center;color:#93c5fd;font-size:13px;margin-bottom:16px;">
                <i class="fa-solid fa-hand-pointer mr-1"></i>é»æ“Šä¸Šæ–¹å·¥å–®åŸ·è¡Œï¼Œæˆ–ç›´æ¥æƒæ
            </div>
            
            <!-- Step 1: æƒææ’å–® -->
            <div id="scan-move-step1">
                <div style="background:rgba(59,130,246,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#3b82f6;font-weight:bold;">æ­¥é©Ÿ 1</span> - æƒææ£§æ¿æ’å–®
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-move-pallet" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥æ£§æ¿ç·¨è™Ÿ" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanMoveStep1(); })"
                           onkeypress="if(event.keyCode==13){scanMoveStep1();return false;}" autofocus>
                    <button class="camera-btn" onclick="openCameraScanner('scan-move-pallet')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- Step 2: æƒææ–°å„²ä½ -->
            <div id="scan-move-step2" style="display:none;">
                <div style="background:rgba(59,130,246,0.2);border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#93c5fd;">å“å</span>
                        <span id="scan-move-product" style="color:white;font-weight:bold;">-</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;">
                        <span style="color:#93c5fd;">ç›®å‰å„²ä½</span>
                        <span id="scan-move-old-loc" style="color:#fbbf24;font-weight:bold;font-size:18px;">-</span>
                    </div>
                </div>
                <div style="background:rgba(16,185,129,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#10b981;font-weight:bold;">æ­¥é©Ÿ 2</span> - æƒææ–°å„²ä½æ¢ç¢¼
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-move-new-loc" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥å¦‚ IA011" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'location', function(){ scanMoveStep2(); })"
                           onkeypress="if(event.keyCode==13){scanMoveStep2();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('scan-move-new-loc')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <div id="scan-move-result" class="scan-result"></div>
            
            <button onclick="resetScanMove()" style="width:100%;padding:16px;background:#dc2626;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                <i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ
            </button>
        </div>
    </div>
    
    <!-- ========== ä½µæ¿æƒæé  ========== -->
    <div id="page-scan-merge" class="func-page">
        <header class="func-header" style="background:linear-gradient(135deg,#6b21a8,#a855f7);">
            <button class="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="func-title">ä½µæ¿ä½œæ¥­</span>
        </header>
        
        <!-- å¾…è¾¦ä½µæ¿å·¥å–® -->
        <div id="merge-orders-section" class="list-section" style="max-height:200px;overflow-y:auto;padding:12px;border-bottom:1px solid #334155;">
            <div class="list-header" style="margin-bottom:8px;">
                <h4 style="font-size:14px;"><i class="fa-solid fa-clipboard-list mr-1 text-purple-400"></i>å¾…è¾¦ä½µæ¿å·¥å–®</h4>
                <span class="list-progress" id="merge-orders-count">0 ç­†</span>
            </div>
            <div id="merge-orders-list">
                <div style="text-align:center;color:#64748b;font-size:13px;padding:12px;">ç„¡å¾…è¾¦å·¥å–®</div>
            </div>
        </div>
        
        <div class="scan-section">
            <div style="text-align:center;color:#d8b4fe;font-size:13px;margin-bottom:16px;">
                <i class="fa-solid fa-hand-pointer mr-1"></i>é»æ“Šä¸Šæ–¹å·¥å–®åŸ·è¡Œï¼Œæˆ–ç›´æ¥æƒæ
            </div>
            
            <!-- Step 1: æƒææ•¸é‡å°‘çš„ -->
            <div id="scan-merge-step1">
                <div style="background:rgba(249,115,22,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#f97316;font-weight:bold;">æ­¥é©Ÿ 1</span> - æƒææ•¸é‡ã€å°‘ã€‘çš„æ’å–®
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-merge-less" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥æ£§æ¿ç·¨è™Ÿ" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanMergeStep1(); })"
                           onkeypress="if(event.keyCode==13){scanMergeStep1();return false;}" autofocus>
                    <button class="camera-btn" onclick="openCameraScanner('scan-merge-less')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- å°‘çš„æ¿è³‡è¨Š -->
            <div id="scan-merge-less-info" style="display:none;background:rgba(249,115,22,0.2);border:1px solid #f97316;border-radius:10px;padding:12px;margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div id="scan-merge-less-name" style="color:white;font-weight:bold;">-</div>
                        <div style="color:#fdba74;font-size:12px;">å°‡è¢«æ¸…ç©ºåˆªé™¤</div>
                    </div>
                    <div style="color:#f97316;font-size:24px;font-weight:bold;"><span id="scan-merge-less-qty">0</span> ä»¶</div>
                </div>
            </div>
            
            <!-- åŠ è™Ÿ -->
            <div id="scan-merge-plus" style="display:none;text-align:center;font-size:24px;color:#a855f7;padding:8px;">ï¼‹</div>
            
            <!-- Step 2: æƒææ•¸é‡å¤šçš„ -->
            <div id="scan-merge-step2" style="display:none;">
                <div style="background:rgba(168,85,247,0.1);border-radius:8px;padding:10px;margin-bottom:12px;text-align:center;">
                    <span style="color:#a855f7;font-weight:bold;">æ­¥é©Ÿ 2</span> - æƒææ•¸é‡ã€å¤šã€‘çš„æ’å–®
                </div>
                <div class="scan-input-wrap">
                    <input type="text" id="scan-merge-more" class="scan-input" placeholder="æƒææˆ–è¼¸å…¥æ£§æ¿ç·¨è™Ÿ" style="text-transform:uppercase;"
                           oninput="autoFormatAndCheck(this, 'pallet', function(){ scanMergeStep2(); })"
                           onkeypress="if(event.keyCode==13){scanMergeStep2();return false;}">
                    <button class="camera-btn" onclick="openCameraScanner('scan-merge-more')"><i class="fa-solid fa-camera"></i></button>
                </div>
            </div>
            
            <!-- å¤šçš„æ¿è³‡è¨Š -->
            <div id="scan-merge-more-info" style="display:none;background:rgba(168,85,247,0.2);border:1px solid #a855f7;border-radius:10px;padding:12px;margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div id="scan-merge-more-name" style="color:white;font-weight:bold;">-</div>
                        <div style="color:#d8b4fe;font-size:12px;">æ•¸é‡æœƒå¢åŠ </div>
                    </div>
                    <div style="color:#a855f7;font-size:24px;font-weight:bold;"><span id="scan-merge-more-qty">0</span> ä»¶</div>
                </div>
            </div>
            
            <!-- åˆä½µé è¦½ -->
            <div id="scan-merge-preview" style="display:none;background:rgba(16,185,129,0.2);border:2px solid #10b981;border-radius:10px;padding:16px;margin-bottom:12px;text-align:center;">
                <div style="color:#6ee7b7;font-size:14px;margin-bottom:8px;">åˆä½µå¾Œç¸½æ•¸</div>
                <div style="color:#10b981;font-size:36px;font-weight:bold;"><span id="scan-merge-total">0</span> ä»¶</div>
                <div style="color:#64748b;font-size:12px;margin-top:4px;">
                    <span id="scan-merge-calc">0 + 0 = 0</span>
                </div>
            </div>
            
            <!-- ç¢ºèªæŒ‰éˆ• -->
            <button id="btn-scan-merge-confirm" onclick="executeScanMerge()" style="display:none;width:100%;padding:16px;background:#a855f7;border:none;border-radius:10px;color:white;font-size:18px;font-weight:bold;">
                <i class="fa-solid fa-check"></i> ç¢ºèªä½µæ¿
            </button>
            
            <div id="scan-merge-result" class="scan-result"></div>
            
            <button onclick="resetScanMerge()" style="width:100%;padding:16px;background:#dc2626;border:none;border-radius:12px;color:white;margin-top:20px;font-size:16px;font-weight:bold;">
                <i class="fa-solid fa-rotate-left"></i> é‡æ–°æƒæ
            </button>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, deleteDoc, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyBEWzyRMJQirGbh28ANkE6aN42GzUBuw2s", 
            authDomain: "terrywms-2345f.firebaseapp.com", 
            projectId: "terrywms-2345f", 
            storageBucket: "terrywms-2345f.firebasestorage.app", 
            messagingSenderId: "75589714942", 
            appId: "1:75589714942:web:3a7f723c3d1449df78f6af" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        
        // è³‡æ–™
        window.pallets = [];
        window.waves = [];
        window.dispatchOrders = [];
        window.inboundTasks = [];
        
        // å·¥å–®æ•¸é‡ï¼ˆç”¨æ–¼é€šçŸ¥ï¼‰
        let prevWaveCount = 0;
        let prevDispatchCount = 0;
        let prevInboundCount = 0;
        
        // ç›£è½èªè­‰ç‹€æ…‹
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-main').classList.add('active');
                document.getElementById('display-user').innerText = user.email.split('@')[0];
                initData();
            } else {
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('app-main').classList.remove('active');
            }
        });
        
        // ç™»å…¥
        window.doLogin = async function() {
            const email = document.getElementById('login-email').value;
            const pwd = document.getElementById('login-pwd').value;
            const errorEl = document.getElementById('login-error');
            
            try {
                errorEl.style.display = 'none';
                await signInWithEmailAndPassword(auth, email, pwd);
            } catch (err) {
                errorEl.style.display = 'block';
                if (err.code === 'auth/user-not-found') errorEl.innerText = 'å¸³è™Ÿä¸å­˜åœ¨';
                else if (err.code === 'auth/wrong-password') errorEl.innerText = 'å¯†ç¢¼éŒ¯èª¤';
                else errorEl.innerText = 'ç™»å…¥å¤±æ•—';
            }
        };
        
        // ç™»å‡º
        window.doLogout = function() {
            signOut(auth);
        };
        
        // åˆå§‹åŒ–è³‡æ–™ - å³æ™‚ç›£è½
        function initData() {
            // ç›£è½åº«å­˜
            onSnapshot(collection(db, 'pallets'), (snap) => {
                window.pallets = [];
                snap.forEach(d => window.pallets.push({ id: d.id, ...d.data() }));
                updateBadges();
            });
            
            // ç›£è½æ³¢æ¬¡å·¥å–®
            onSnapshot(collection(db, 'waves'), (snap) => {
                window.waves = [];
                snap.forEach(d => window.waves.push({ id: d.id, ...d.data() }));
                
                // æª¢æŸ¥æ–°å·¥å–®é€šçŸ¥
                const activeWaves = window.waves.filter(w => w.status !== 'done').length;
                if (prevWaveCount > 0 && activeWaves > prevWaveCount) {
                    showNotification('ğŸ“¦ æ–°æ€è²¨æ³¢æ¬¡', 'æœ‰æ–°çš„æ€è²¨ä»»å‹™ï¼');
                }
                prevWaveCount = activeWaves;
                updateBadges();
            });
            
            // ç›£è½èª¿åº¦å·¥å–®
            onSnapshot(collection(db, 'dispatchOrders'), (snap) => {
                window.dispatchOrders = [];
                snap.forEach(d => window.dispatchOrders.push({ id: d.id, ...d.data() }));
                
                // æª¢æŸ¥æ–°å·¥å–®é€šçŸ¥
                const activeOrders = window.dispatchOrders.filter(o => o.status !== 'done').length;
                if (prevDispatchCount > 0 && activeOrders > prevDispatchCount) {
                    showNotification('ğŸš› æ–°èª¿åº¦å·¥å–®', 'æœ‰æ–°çš„èª¿åº¦ä»»å‹™ï¼');
                }
                prevDispatchCount = activeOrders;
                updateBadges();
                
                // å³æ™‚æ›´æ–°ç§»æ¿/ä½µæ¿é é¢çš„å·¥å–®åˆ—è¡¨
                if (window.loadMoveOrders) window.loadMoveOrders();
                if (window.loadMergeOrders) window.loadMergeOrders();
            });
            
            // ç›£è¯å…¥åº«ä»»å‹™
            onSnapshot(collection(db, 'inboundTasks'), (snap) => {
                window.inboundTasks = [];
                snap.forEach(d => window.inboundTasks.push({ id: d.id, ...d.data() }));
                
                // æª¢æŸ¥æ–°ä»»å‹™é€šçŸ¥
                const activeTasks = window.inboundTasks.filter(t => t.status !== 'done').length;
                if (prevInboundCount > 0 && activeTasks > prevInboundCount) {
                    showNotification('ğŸ“¥ æ–°å…¥åº«ä»»å‹™', 'æœ‰æ–°çš„å…¥åº«ä»»å‹™ï¼');
                }
                prevInboundCount = activeTasks;
                updateBadges();
                
                // å¦‚æœæ­£åœ¨å…¥åº«é é¢ï¼Œè‡ªå‹•åˆ·æ–°åˆ—è¡¨
                if (document.getElementById('page-inbound').classList.contains('active')) {
                    loadInboundTasks();
                }
            });
        }
        
        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(title, body) {
            // éœ‡å‹•
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            
            // ç€è¦½å™¨é€šçŸ¥ï¼ˆå¦‚æœæœ‰æ¬Šé™ï¼‰
            if (Notification.permission === 'granted') {
                new Notification(title, { body: body, icon: 'ğŸ“¦' });
            }
            
            // ç•«é¢æç¤º
            showToast(title + ' - ' + body);
        }
        
        // æ ¼å¼åŒ–å„²ä½ç·¨è™Ÿï¼šIA011F â†’ I-A-01-1F
        // è¼¸å…¥æ ¼å¼: å€(1ç¢¼) + æ’(1ç¢¼) + åˆ—(1-2ç¢¼) + æ¨“(1ç¢¼) + F(å¯é¸)
        // ä¾‹: ia011f, IA11F, ke101, kb222 â†’ I-A-01-1F, K-E-10-1F, K-B-22-2F
        window.formatLocationId = function(input) {
            if (!input) return '';
            var s = input.trim().toUpperCase();
            
            // å¦‚æœå·²ç¶“æœ‰æ­£ç¢ºæ ¼å¼ï¼ˆåŒ…å«-ï¼‰ï¼Œç›´æ¥è¿”å›å¤§å¯«
            if (s.indexOf('-') !== -1) return s;
            
            // ç§»é™¤æ‰€æœ‰éå­—æ¯æ•¸å­—
            s = s.replace(/[^A-Z0-9]/g, '');
            
            // æœ€å°‘éœ€è¦5ç¢¼
            if (s.length < 5) return input.toUpperCase();
            
            var zone1 = s.charAt(0);  // I, J, K ç­‰
            var zone2 = s.charAt(1);  // A, B, C ç­‰
            var rest = s.substring(2); // å‰©é¤˜éƒ¨åˆ†: åˆ—è™Ÿ + æ¨“å±¤
            
            // ç§»é™¤çµå°¾çš„ F (å¦‚æœæœ‰)
            var hasF = rest.charAt(rest.length - 1) === 'F';
            if (hasF) {
                rest = rest.substring(0, rest.length - 1);
            }
            
            // rest ç¾åœ¨æ˜¯ç´”æ•¸å­—ï¼Œä¾‹å¦‚: 011, 0112, 11, 101
            // æœ€å¾Œä¸€å€‹æ•¸å­—æ˜¯æ¨“å±¤ï¼Œå‰é¢æ˜¯åˆ—è™Ÿ
            var floorNum = '1';
            var rowNum = '01';
            
            if (rest.length >= 2) {
                floorNum = rest.charAt(rest.length - 1);  // æœ€å¾Œä¸€å€‹æ•¸å­—æ˜¯æ¨“å±¤
                rowNum = rest.substring(0, rest.length - 1);   // å‰é¢æ˜¯åˆ—è™Ÿ
            } else if (rest.length === 1) {
                floorNum = rest;
                rowNum = '01';
            }
            
            // è£œé›¶åˆ°å…©ä½
            while (rowNum.length < 2) rowNum = '0' + rowNum;
            
            return zone1 + '-' + zone2 + '-' + rowNum + '-' + floorNum + 'F';
        }
        
        // æ ¼å¼åŒ–æ£§æ¿ç·¨è™Ÿ: å¤§å¯«ä¸¦ç§»é™¤ç‰¹æ®Šå­—å…ƒ
        window.formatPalletId = function(input) {
            if (!input) return '';
            return input.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
        }
        
        // è‡ªå‹•æ ¼å¼åŒ–è¼¸å…¥ä¸¦æª¢æŸ¥æ˜¯å¦æ‡‰è©²è‡ªå‹•è§¸ç™¼ç¢ºèª
        // type: 'location' æˆ– 'pallet'
        // callback: ç¢ºèªå‡½æ•¸
        window.autoCheckTimer = null;
        window.lastInputLength = {};
        window.autoFormatAndCheck = function(input, type, callback) {
            console.log('[autoFormatAndCheck] é–‹å§‹, type:', type, 'value:', input.value);
            
            // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
            if (window.autoCheckTimer) {
                clearTimeout(window.autoCheckTimer);
                window.autoCheckTimer = null;
            }
            
            var val = input.value.trim().toUpperCase();
            
            // è‡ªå‹•å¤§å¯«
            if (input.value !== val) {
                var pos = input.selectionStart;
                input.value = val;
                input.setSelectionRange(pos, pos);
            }
            
            if (!val) {
                window.lastInputLength[input.id] = 0;
                return;
            }
            
            // æª¢æ¸¬æ˜¯å¦ç‚ºæƒæå™¨è¼¸å…¥ï¼ˆä¸€æ¬¡è¼¸å…¥å¤šå€‹å­—ç¬¦ï¼‰
            var prevLen = window.lastInputLength[input.id] || 0;
            var isScanner = (val.length - prevLen) > 3;
            window.lastInputLength[input.id] = val.length;
            
            // æ ¹æ“šé¡å‹åˆ¤æ–·æ˜¯å¦é”åˆ°å®Œæ•´æ ¼å¼
            var shouldTrigger = false;
            
            if (type === 'location') {
                // å„²ä½æ ¼å¼: JC012 æˆ– JC012F æˆ– J-C-01-2F
                var clean = val.replace(/[^A-Z0-9]/g, '');
                console.log('[autoFormatAndCheck] location clean:', clean, 'length:', clean.length);
                
                // ç§»é™¤çµå°¾çš„ F ä¾†åˆ¤æ–·
                var checkVal = clean;
                if (checkVal.charAt(checkVal.length - 1) === 'F') {
                    checkVal = checkVal.substring(0, checkVal.length - 1);
                }
                
                // å®Œæ•´æ ¼å¼ï¼šè‡³å°‘5å€‹å­—ç¬¦ï¼ˆä¸å«Fï¼‰ï¼Œä¸”æœ€å¾Œæ˜¯æ•¸å­—ï¼ˆæ¨“å±¤ï¼‰
                if (checkVal.length >= 5 && /[0-9]$/.test(checkVal)) {
                    shouldTrigger = true;
                    console.log('[autoFormatAndCheck] ç¬¦åˆ5ç¢¼è¦å‰‡ (checkVal:', checkVal, ')');
                }
                // æˆ–è€…å·²ç¶“æ˜¯æ¨™æº–æ ¼å¼
                if (/^[A-Z]-[A-Z]-\d{2}-\d+F?$/i.test(val)) {
                    shouldTrigger = true;
                    console.log('[autoFormatAndCheck] ç¬¦åˆæ¨™æº–æ ¼å¼');
                }
            } else if (type === 'pallet') {
                // æ£§æ¿æ ¼å¼: é€šå¸¸æ˜¯è‹±æ•¸æ··åˆï¼Œ6ç¢¼ä»¥ä¸Š
                var clean = val.replace(/[^A-Z0-9]/g, '');
                if (clean.length >= 6) {
                    shouldTrigger = true;
                }
            }
            
            console.log('[autoFormatAndCheck] shouldTrigger:', shouldTrigger, 'callback:', !!callback);
            
            // æƒæå™¨è¼¸å…¥ç«‹å³è§¸ç™¼ï¼Œæ‰‹å‹•è¼¸å…¥å»¶é² 400ms
            if (shouldTrigger && callback) {
                var delay = isScanner ? 50 : 400;
                console.log('[autoFormatAndCheck] å°‡åœ¨', delay, 'ms å¾Œè§¸ç™¼å›èª¿');
                window.autoCheckTimer = setTimeout(function() {
                    console.log('[autoFormatAndCheck] è§¸ç™¼å›èª¿!');
                    callback();
                }, delay);
            }
        };
        
        // Toast æç¤º
        window.showToast = function(msg) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = 'position:fixed;top:60px;left:50%;transform:translateX(-50%);background:#3b82f6;color:#fff;padding:12px 20px;border-radius:10px;font-size:14px;z-index:9999;opacity:0;transition:opacity 0.3s;';
                document.body.appendChild(toast);
            }
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        };
        
        // è«‹æ±‚é€šçŸ¥æ¬Šé™
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
    
    <script>
        // ========== ç›¸æ©ŸæƒæåŠŸèƒ½ ==========
        let html5QrCode = null;
        let currentScanTarget = null;
        
        function openCameraScanner(targetInputId) {
            currentScanTarget = targetInputId;
            document.getElementById('camera-modal').classList.add('active');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 150 } },
                function(decodedText) {
                    // æƒææˆåŠŸ
                    if (currentScanTarget) {
                        document.getElementById(currentScanTarget).value = decodedText.toUpperCase();
                    }
                    if (navigator.vibrate) navigator.vibrate(100);
                    var target = currentScanTarget;
                    stopCameraScanner();
                    
                    // è‡ªå‹•è§¸ç™¼ç¢ºèª
                    setTimeout(function() {
                        if (target === 'inbound-pallet-scan') confirmInboundPallet();
                        else if (target === 'inbound-location-scan') confirmInboundLocation();
                        else if (target === 'picking-location-scan') confirmPickingLocation();
                        else if (target === 'picking-pallet-scan') confirmPickingPallet();
                        else if (target === 'picking-scan') confirmPickingScan();
                        else if (target === 'dispatch-scan') confirmDispatchScan();
                        else if (target === 'query-input') doInventoryQuery();
                        else if (target === 'scan-in-location') scanInboundStep1();
                        else if (target === 'scan-in-pallet') scanInboundStep2();
                        else if (target === 'scan-out-pallet') scanOutboundStep1();
                        else if (target === 'scan-move-pallet') scanMoveStep1();
                        else if (target === 'scan-move-new-loc') scanMoveStep2();
                        else if (target === 'scan-merge-less') scanMergeStep1();
                        else if (target === 'scan-merge-more') scanMergeStep2();
                    }, 100);
                },
                function(errorMessage) { /* å¿½ç•¥æƒæéŒ¯èª¤ */ }
            ).catch(function(err) {
                console.error('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', err);
                alert('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹ç¢ºèªå·²æˆäºˆç›¸æ©Ÿæ¬Šé™');
                stopCameraScanner();
            });
        }
        
        function stopCameraScanner() {
            document.getElementById('camera-modal').classList.remove('active');
            if (html5QrCode) {
                html5QrCode.stop().then(function() {
                    html5QrCode.clear();
                    html5QrCode = null;
                }).catch(function(err) { console.log('åœæ­¢ç›¸æ©ŸéŒ¯èª¤:', err); });
            }
            currentScanTarget = null;
        }
        
        // ========== åº«å­˜ç•°å‹•è¨˜éŒ„ç³»çµ± ==========
        // è¨˜éŒ„æ‰€æœ‰åº«å­˜ç•°å‹•åˆ° inventoryLogsï¼Œä¾›å ±è¡¨æŸ¥è©¢ä½¿ç”¨
        async function logInventoryChange(data) {
            try {
                var logEntry = {
                    type: data.type || 'unknown',           // inbound, outbound, move, adjust
                    productName: data.productName || '',
                    spec: data.spec || '',
                    quantity: data.quantity || 0,
                    quantityChange: data.quantityChange || 0,  // æ­£æ•¸=å…¥åº«, è² æ•¸=å‡ºåº«
                    locationId: data.locationId || '',
                    fromLocation: data.fromLocation || '',     // ç§»ä½ç”¨
                    toLocation: data.toLocation || '',         // ç§»ä½ç”¨
                    batchNo: data.batchNo || '',
                    palletId: data.palletId || '',
                    expDate: data.expDate || '',
                    note: data.note || '',
                    operator: window.currentUser ? window.currentUser.email : 'mobile-user',
                    operatorName: window.currentUser ? window.currentUser.email.split('@')[0] : 'operator',
                    deviceType: 'mobile',
                    timestamp: new Date().toISOString(),
                    createdAt: new Date()
                };
                
                await window.addDoc(window.collection(window.db, 'inventoryLogs'), logEntry);
                console.log('ğŸ“ ç•°å‹•è¨˜éŒ„å·²å„²å­˜:', logEntry.type, logEntry.productName);
            } catch (e) {
                console.error('è¨˜éŒ„ç•°å‹•å¤±æ•—:', e);
            }
        }
        
        // æ›´æ–° Badge æ•¸é‡
        function updateBadges() {
            // æ€è²¨
            var activeWaves = (window.waves || []).filter(function(w) { return w.status !== 'done'; }).length;
            var badgePicking = document.getElementById('badge-picking');
            if (badgePicking) {
                if (activeWaves > 0) {
                    badgePicking.innerText = activeWaves;
                    badgePicking.style.display = 'flex';
                } else {
                    badgePicking.style.display = 'none';
                }
            }
            
            // å…¥åº«
            var activeTasks = (window.inboundTasks || []).filter(function(t) { return t.status !== 'done'; }).length;
            var badgeInbound = document.getElementById('badge-inbound');
            if (badgeInbound) {
                if (activeTasks > 0) {
                    badgeInbound.innerText = activeTasks;
                    badgeInbound.style.display = 'flex';
                } else {
                    badgeInbound.style.display = 'none';
                }
            }
            
            // ç§»æ¿å·¥å–® - æ”¹é€²ç¯©é¸é‚è¼¯
            var orders = window.dispatchOrders || [];
            var moveOrders = orders.filter(function(o) { 
                if (o.status === 'done') return false;
                if (o.type === 'move' || o.orderType === 'move') return true;
                var ops = o.operations || [];
                var hasMoveOp = ops.some(function(op) { return op.type === 'ç§»ä½' || op.type === 'move'; });
                var hasMergeOp = ops.some(function(op) { return op.type === 'åˆä½µ' || op.type === 'merge'; });
                return hasMoveOp && !hasMergeOp;
            }).length;
            var badgeMove = document.getElementById('badge-move');
            if (badgeMove) {
                if (moveOrders > 0) {
                    badgeMove.innerText = moveOrders;
                    badgeMove.style.display = 'flex';
                } else {
                    badgeMove.style.display = 'none';
                }
            }
            
            // ä½µæ¿å·¥å–® - æ”¹é€²ç¯©é¸é‚è¼¯
            var mergeOrders = orders.filter(function(o) { 
                if (o.status === 'done') return false;
                if (o.type === 'merge' || o.orderType === 'merge') return true;
                var ops = o.operations || [];
                return ops.some(function(op) { return op.type === 'åˆä½µ' || op.type === 'merge'; });
            }).length;
            var badgeMerge = document.getElementById('badge-merge');
            if (badgeMerge) {
                if (mergeOrders > 0) {
                    badgeMerge.innerText = mergeOrders;
                    badgeMerge.style.display = 'flex';
                } else {
                    badgeMerge.style.display = 'none';
                }
            }
        }
        
        // è¼‰å…¥ç§»æ¿å·¥å–®
        window.loadMoveOrders = function() {
            console.log('[loadMoveOrders] dispatchOrders:', window.dispatchOrders);
            
            var orders = (window.dispatchOrders || []).filter(function(o) {
                if (o.status === 'done') return false;
                
                // æª¢æŸ¥ type æ¬„ä½
                if (o.type === 'move' || o.orderType === 'move') return true;
                
                // æª¢æŸ¥ operations è£¡é¢çš„é¡å‹
                var ops = o.operations || [];
                var hasMoveOp = ops.some(function(op) {
                    return op.type === 'ç§»ä½' || op.type === 'move';
                });
                
                // å¦‚æœæœ‰ç§»ä½æ“ä½œä¸”æ²’æœ‰åˆä½µæ“ä½œï¼Œè¦–ç‚ºç§»æ¿å·¥å–®
                var hasMergeOp = ops.some(function(op) {
                    return op.type === 'åˆä½µ' || op.type === 'merge';
                });
                
                return hasMoveOp && !hasMergeOp;
            });
            
            console.log('[loadMoveOrders] ç¯©é¸å¾Œå·¥å–®æ•¸:', orders.length);
            
            var countEl = document.getElementById('move-orders-count');
            var listEl = document.getElementById('move-orders-list');
            
            if (countEl) countEl.innerText = orders.length + ' ç­†';
            
            if (!listEl) return;
            
            if (orders.length === 0) {
                listEl.innerHTML = '<div style="text-align:center;color:#64748b;font-size:13px;padding:12px;">ç„¡å¾…è¾¦ç§»æ¿å·¥å–®</div>';
                return;
            }
            
            listEl.innerHTML = orders.map(function(order) {
                var ops = order.operations || [];
                var completed = (order.completedOps || []).length;
                var statusColor = completed > 0 ? '#f59e0b' : '#3b82f6';
                var statusText = completed > 0 ? 'é€²è¡Œä¸­ ' + completed + '/' + ops.length : 'å¾…åŸ·è¡Œ';
                
                return '<div class="list-item" style="padding:10px;margin-bottom:8px;cursor:pointer;" onclick="executeMoveOrder(\'' + order.id + '\')">' +
                    '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                    '<div style="font-weight:bold;color:white;">' + (order.productName || order.orderNo || 'ç§»æ¿å·¥å–®') + '</div>' +
                    '<span style="font-size:11px;padding:3px 8px;border-radius:4px;background:rgba(59,130,246,0.2);color:' + statusColor + ';">' + statusText + '</span>' +
                    '</div>' +
                    '<div style="font-size:12px;color:#94a3b8;margin-top:4px;">' + 
                    ops.slice(0,2).map(function(op) { return op.from + ' â†’ ' + op.to; }).join(' | ') +
                    (ops.length > 2 ? ' ...' : '') +
                    '</div>' +
                    '</div>';
            }).join('');
        }
        
        // è¼‰å…¥ä½µæ¿å·¥å–®
        window.loadMergeOrders = function() {
            console.log('[loadMergeOrders] dispatchOrders:', window.dispatchOrders);
            
            var orders = (window.dispatchOrders || []).filter(function(o) {
                if (o.status === 'done') return false;
                
                // æª¢æŸ¥ type æ¬„ä½
                if (o.type === 'merge' || o.orderType === 'merge') return true;
                
                // æª¢æŸ¥ operations è£¡é¢çš„é¡å‹
                var ops = o.operations || [];
                var hasMergeOp = ops.some(function(op) {
                    return op.type === 'åˆä½µ' || op.type === 'merge';
                });
                
                return hasMergeOp;
            });
            
            console.log('[loadMergeOrders] ç¯©é¸å¾Œå·¥å–®æ•¸:', orders.length);
            
            var countEl = document.getElementById('merge-orders-count');
            var listEl = document.getElementById('merge-orders-list');
            
            if (countEl) countEl.innerText = orders.length + ' ç­†';
            
            if (!listEl) return;
            
            if (orders.length === 0) {
                listEl.innerHTML = '<div style="text-align:center;color:#64748b;font-size:13px;padding:12px;">ç„¡å¾…è¾¦ä½µæ¿å·¥å–®</div>';
                return;
            }
            
            listEl.innerHTML = orders.map(function(order) {
                var ops = order.operations || [];
                var completed = (order.completedOps || []).length;
                var statusColor = completed > 0 ? '#f59e0b' : '#a855f7';
                var statusText = completed > 0 ? 'é€²è¡Œä¸­ ' + completed + '/' + ops.length : 'å¾…åŸ·è¡Œ';
                
                return '<div class="list-item" style="padding:10px;margin-bottom:8px;cursor:pointer;" onclick="executeMergeOrder(\'' + order.id + '\')">' +
                    '<div style="display:flex;justify-content:space-between;align-items:center;">' +
                    '<div style="font-weight:bold;color:white;">' + (order.productName || order.orderNo || 'ä½µæ¿å·¥å–®') + '</div>' +
                    '<span style="font-size:11px;padding:3px 8px;border-radius:4px;background:rgba(168,85,247,0.2);color:' + statusColor + ';">' + statusText + '</span>' +
                    '</div>' +
                    '<div style="font-size:12px;color:#94a3b8;margin-top:4px;">' + 
                    ops.slice(0,2).map(function(op) { return op.from + ' + ' + op.to; }).join(' | ') +
                    (ops.length > 2 ? ' ...' : '') +
                    '</div>' +
                    '</div>';
            }).join('');
        }
        
        // åŸ·è¡Œç§»æ¿å·¥å–®
        window.executeMoveOrder = function(orderId) {
            var order = (window.dispatchOrders || []).find(function(o) { return o.id === orderId; });
            if (!order) { showToast('æ‰¾ä¸åˆ°å·¥å–®'); return; }
            
            var ops = order.operations || [];
            var completedOps = order.completedOps || [];
            
            // æ‰¾åˆ°ç¬¬ä¸€å€‹æœªå®Œæˆçš„æ“ä½œ
            var nextOp = null;
            for (var i = 0; i < ops.length; i++) {
                var opId = ops[i].id || 'op-' + i;
                if (completedOps.indexOf(opId) === -1) {
                    nextOp = ops[i];
                    nextOp._idx = i;
                    break;
                }
            }
            
            if (!nextOp) {
                showToast('æ­¤å·¥å–®å·²å…¨éƒ¨å®Œæˆ');
                return;
            }
            
            // å„²å­˜ç•¶å‰å·¥å–®
            window.currentMoveOrder = order;
            window.currentMoveOp = nextOp;
            
            // é¡¯ç¤ºå·¥å–®æŒ‡å¼•
            var result = document.getElementById('scan-move-result');
            if (result) {
                result.innerHTML = '<div style="background:rgba(59,130,246,0.2);border:1px solid #3b82f6;border-radius:10px;padding:12px;margin-bottom:12px;">' +
                    '<div style="color:#93c5fd;font-size:12px;margin-bottom:4px;"><i class="fa-solid fa-clipboard-list" style="margin-right:4px;"></i>åŸ·è¡Œå·¥å–® (' + (completedOps.length + 1) + '/' + ops.length + ')</div>' +
                    '<div style="color:white;font-weight:bold;">' + (order.productName || '') + '</div>' +
                    '<div style="display:flex;align-items:center;gap:8px;margin-top:8px;">' +
                    '<span style="color:#fbbf24;font-weight:bold;font-size:16px;">' + nextOp.from + '</span>' +
                    '<span style="color:#3b82f6;">â†’</span>' +
                    '<span style="color:#10b981;font-weight:bold;font-size:16px;">' + nextOp.to + '</span>' +
                    '</div>' +
                    '</div>';
            }
            
            // èšç„¦åˆ°æƒæè¼¸å…¥æ¡†
            setTimeout(function() {
                var input = document.getElementById('scan-move-pallet');
                if (input) input.focus();
            }, 100);
            showToast('è«‹æƒææ£§æ¿æ’å–®');
        };
        
        // åŸ·è¡Œä½µæ¿å·¥å–®
        window.executeMergeOrder = function(orderId) {
            var order = (window.dispatchOrders || []).find(function(o) { return o.id === orderId; });
            if (!order) { showToast('æ‰¾ä¸åˆ°å·¥å–®'); return; }
            
            var ops = order.operations || [];
            var completedOps = order.completedOps || [];
            
            // æ‰¾åˆ°ç¬¬ä¸€å€‹æœªå®Œæˆçš„æ“ä½œ
            var nextOp = null;
            for (var i = 0; i < ops.length; i++) {
                var opId = ops[i].id || 'op-' + i;
                if (completedOps.indexOf(opId) === -1) {
                    nextOp = ops[i];
                    nextOp._idx = i;
                    break;
                }
            }
            
            if (!nextOp) {
                showToast('æ­¤å·¥å–®å·²å…¨éƒ¨å®Œæˆ');
                return;
            }
            
            // å„²å­˜ç•¶å‰å·¥å–®
            window.currentMergeOrder = order;
            window.currentMergeOp = nextOp;
            
            // é¡¯ç¤ºå·¥å–®æŒ‡å¼•
            var result = document.getElementById('scan-merge-result');
            if (result) {
                result.innerHTML = '<div style="background:rgba(168,85,247,0.2);border:1px solid #a855f7;border-radius:10px;padding:12px;margin-bottom:12px;">' +
                    '<div style="color:#d8b4fe;font-size:12px;margin-bottom:4px;"><i class="fa-solid fa-clipboard-list" style="margin-right:4px;"></i>åŸ·è¡Œå·¥å–® (' + (completedOps.length + 1) + '/' + ops.length + ')</div>' +
                    '<div style="color:white;font-weight:bold;">' + (order.productName || '') + '</div>' +
                    '<div style="display:flex;align-items:center;gap:8px;margin-top:8px;">' +
                    '<span style="color:#f97316;font-weight:bold;font-size:16px;">' + nextOp.from + '</span>' +
                    '<span style="color:#a855f7;font-size:20px;">+</span>' +
                    '<span style="color:#10b981;font-weight:bold;font-size:16px;">' + nextOp.to + '</span>' +
                    '</div>' +
                    '</div>';
            }
            
            // èšç„¦åˆ°æƒæè¼¸å…¥æ¡†
            setTimeout(function() {
                var input = document.getElementById('scan-merge-less');
                if (input) input.focus();
            }, 100);
            showToast('è«‹æƒæå°‘çš„æ£§æ¿');
        };
        
        // é¡¯ç¤º/éš±è—å…¥åº«é¸é …
        window.showInboundOptions = function() {
            var modal = document.getElementById('inbound-options-modal');
            if (modal) modal.style.display = 'flex';
        };
        
        window.hideInboundOptions = function() {
            var modal = document.getElementById('inbound-options-modal');
            if (modal) modal.style.display = 'none';
        };
        
        // é é¢åˆ‡æ›
        function openPage(page) {
            document.getElementById('app-main').classList.remove('active');
            document.getElementById('page-' + page).classList.add('active');
            
            if (page === 'picking') loadPickingWaves();
            if (page === 'inbound') loadInboundTasks();
            if (page === 'dispatch') loadDispatchOrders();
            if (page === 'scan-move') loadMoveOrders();
            if (page === 'scan-merge') loadMergeOrders();
        }
        
        function goBack() {
            document.querySelectorAll('.func-page').forEach(p => p.classList.remove('active'));
            document.getElementById('app-main').classList.add('active');
        }
        
        // ========== æ€è²¨æƒæ ==========
        let currentWave = null;
        let pickingItems = [];
        
        function loadPickingWaves() {
            const waves = window.waves || [];
            const select = document.getElementById('picking-wave-select');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
            
            waves.filter(w => w.status !== 'done').forEach(w => {
                select.innerHTML += `<option value="${w.id}">${w.waveNo} - ${w.logistics || 'æ··åˆ'} (${w.totalQty || 0}ä»¶)</option>`;
            });
        }
        
        window.loadPickingWave = function() {
            const waveId = document.getElementById('picking-wave-select').value;
            if (!waveId) {
                document.getElementById('picking-scan-area').style.display = 'none';
                document.getElementById('picking-actions').style.display = 'none';
                return;
            }
            
            const waves = window.waves || [];
            currentWave = waves.find(w => w.id === waveId);
            if (!currentWave) return;
            
            // ç”¢ç”Ÿæ€è²¨æ¸…å–®
            pickingItems = [];
            (currentWave.orders || []).forEach(order => {
                let needed = parseInt(order.quantity) || 0;
                const matching = window.pallets.filter(p => p.productName === order.productName)
                    .sort((a, b) => (a.expDate || '').localeCompare(b.expDate || ''));
                
                matching.forEach(p => {
                    if (needed <= 0) return;
                    const pick = Math.min(p.quantity, needed);
                    pickingItems.push({
                        id: p.palletId + '-' + order.id,
                        palletId: p.palletId,
                        locationId: p.locationId,
                        productName: p.productName,
                        pickQty: pick,
                        orderNo: order.orderNo,
                        customer: order.customer,
                        completed: false
                    });
                    needed -= pick;
                });
                
                if (needed > 0) {
                    pickingItems.push({
                        id: 'shortage-' + order.id,
                        locationId: 'åº«å­˜ä¸è¶³',
                        productName: order.productName,
                        pickQty: needed,
                        shortage: true
                    });
                }
            });
            
            // æ¨™è¨˜å·²å®Œæˆ
            const completed = currentWave.completedItems || [];
            pickingItems.forEach(item => {
                if (completed.includes(item.id)) item.completed = true;
            });
            
            renderPickingList();
            document.getElementById('picking-scan-area').style.display = 'block';
            document.getElementById('picking-actions').style.display = 'block';
            document.getElementById('picking-scan').focus();
        };
        
        function renderPickingList() {
            const list = document.getElementById('picking-list');
            const completed = pickingItems.filter(i => i.completed).length;
            const total = pickingItems.filter(i => !i.shortage).length;
            document.getElementById('picking-progress').innerText = completed + '/' + total;
            
            if (pickingItems.length === 0) {
                list.innerHTML = '<div class="empty-state"><i class="fa-solid fa-clipboard-list"></i><p>ç„¡æ€è²¨é …ç›®</p></div>';
                return;
            }
            
            // æŒ‰å„²ä½æ’åº
            pickingItems.sort((a, b) => (a.locationId || '').localeCompare(b.locationId || ''));
            
            list.innerHTML = pickingItems.map(item => {
                const cls = item.completed ? 'completed' : item.shortage ? 'shortage' : '';
                const status = item.completed ? '<span class="item-status done">âœ“ å®Œæˆ</span>' :
                              item.shortage ? '<span class="item-status shortage">ç¼ºè²¨</span>' :
                              '<span class="item-status pending">å¾…æ€</span>';
                return `
                    <div class="list-item ${cls}">
                        <div class="item-row">
                            <span class="item-location">${item.locationId}</span>
                            ${status}
                        </div>
                        <div class="item-product">${item.productName}</div>
                        <div class="item-row">
                            <span class="item-detail">${item.palletId || '-'} | ${item.customer || ''}</span>
                            <span class="item-qty">${item.pickQty}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ========== æ€è²¨ä¸‰æ­¥é©Ÿé©—è­‰ ==========
        let currentPickingItem = null;
        let currentPickingIndex = 0;
        
        // é¡¯ç¤ºç•¶å‰æ€è²¨é …ç›®
        function showCurrentPickingItem() {
            // æ‰¾ä¸‹ä¸€å€‹æœªå®Œæˆçš„é …ç›®
            const pending = pickingItems.filter(i => !i.completed && !i.shortage);
            if (pending.length === 0) {
                document.getElementById('picking-current-item').style.display = 'none';
                document.getElementById('picking-step1').style.display = 'none';
                document.getElementById('picking-step2').style.display = 'none';
                document.getElementById('picking-step3').style.display = 'none';
                document.getElementById('picking-scan-result').className = 'scan-result success';
                document.getElementById('picking-scan-result').innerText = 'ğŸ‰ æ‰€æœ‰é …ç›®å·²æ€å®Œï¼è«‹é»æ“Šã€Œå®Œæˆæ³¢æ¬¡ã€';
                return;
            }
            
            currentPickingItem = pending[0];
            currentPickingIndex = pickingItems.indexOf(currentPickingItem);
            
            // é¡¯ç¤ºè³‡è¨Š
            document.getElementById('picking-item-product').innerText = currentPickingItem.productName + (currentPickingItem.spec ? ' / ' + currentPickingItem.spec : '');
            document.getElementById('picking-item-batch').innerText = currentPickingItem.batchNo || '(ç„¡æ‰¹è™Ÿ)';
            document.getElementById('picking-item-qty').innerText = currentPickingItem.pickQty;
            document.getElementById('picking-item-location').innerText = currentPickingItem.locationId || '-';
            
            // é‡ç½®æ­¥é©Ÿ
            document.getElementById('picking-current-item').style.display = 'block';
            document.getElementById('picking-step1').style.display = 'block';
            document.getElementById('picking-step2').style.display = 'none';
            document.getElementById('picking-step3').style.display = 'none';
            document.getElementById('picking-location-scan').value = '';
            document.getElementById('picking-pallet-scan').value = '';
            document.getElementById('picking-qty-input').value = currentPickingItem.pickQty;
            
            document.getElementById('picking-scan-result').className = 'scan-result';
            document.getElementById('picking-scan-result').innerText = '';
            
            setTimeout(() => document.getElementById('picking-location-scan').focus(), 100);
        }
        
        // Step 1: ç¢ºèªå„²ä½
        window.confirmPickingLocation = function() {
            const input = document.getElementById('picking-location-scan');
            const result = document.getElementById('picking-scan-result');
            const scanned = input.value.trim().toUpperCase();
            
            if (!scanned) {
                result.className = 'scan-result error';
                result.innerText = 'è«‹æƒæå„²ä½';
                return;
            }
            
            if (!currentPickingItem) {
                result.className = 'scan-result error';
                result.innerText = 'è«‹å…ˆé¸æ“‡æ³¢æ¬¡';
                return;
            }
            
            const expected = (currentPickingItem.locationId || '').toUpperCase();
            
            if (scanned === expected) {
                result.className = 'scan-result success';
                result.innerText = 'âœ“ å„²ä½ç¢ºèªï¼Œè«‹æƒææ¿è™Ÿ';
                
                document.getElementById('picking-step1').style.display = 'none';
                document.getElementById('picking-step2').style.display = 'block';
                
                if (navigator.vibrate) navigator.vibrate(50);
                setTimeout(() => document.getElementById('picking-pallet-scan').focus(), 100);
            } else {
                result.className = 'scan-result error';
                result.innerText = 'âŒ å„²ä½éŒ¯èª¤ï¼\næƒæçš„: ' + scanned + '\næ­£ç¢ºçš„: ' + expected;
                input.value = '';
                input.focus();
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        };
        
        // Step 2: ç¢ºèªæ¿è™Ÿ
        window.confirmPickingPallet = function() {
            const input = document.getElementById('picking-pallet-scan');
            const result = document.getElementById('picking-scan-result');
            const scanned = input.value.trim().toUpperCase();
            
            if (!scanned) {
                result.className = 'scan-result error';
                result.innerText = 'è«‹æƒææ¿è™Ÿ';
                return;
            }
            
            const expected = (currentPickingItem.palletId || '').toUpperCase();
            
            if (scanned === expected) {
                result.className = 'scan-result success';
                result.innerText = 'âœ“ æ¿è™Ÿç¢ºèªï¼Œè«‹ç¢ºèªæ•¸é‡';
                
                document.getElementById('picking-step2').style.display = 'none';
                document.getElementById('picking-step3').style.display = 'block';
                document.getElementById('picking-qty-input').value = currentPickingItem.pickQty;
                
                if (navigator.vibrate) navigator.vibrate(50);
                setTimeout(() => document.getElementById('picking-qty-input').focus(), 100);
            } else {
                result.className = 'scan-result error';
                result.innerText = 'âŒ æ¿è™ŸéŒ¯èª¤ï¼\næƒæçš„: ' + scanned + '\næ­£ç¢ºçš„: ' + expected;
                input.value = '';
                input.focus();
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        };
        
        // Step 3: ç¢ºèªæ•¸é‡
        window.confirmPickingQty = async function() {
            const input = document.getElementById('picking-qty-input');
            const result = document.getElementById('picking-scan-result');
            const qty = parseInt(input.value) || 0;
            
            if (qty <= 0) {
                result.className = 'scan-result error';
                result.innerText = 'è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡';
                return;
            }
            
            const expectedQty = currentPickingItem.pickQty;
            
            // æ¨™è¨˜å®Œæˆ
            currentPickingItem.completed = true;
            currentPickingItem.actualQty = qty;
            
            // å„²å­˜é€²åº¦åˆ° Firebase
            try {
                if (!currentWave.completedItems) currentWave.completedItems = [];
                currentWave.completedItems.push(currentPickingItem.id);
                
                await window.updateDoc(window.doc(window.db, 'waves', currentWave.id), {
                    completedItems: currentWave.completedItems,
                    status: 'picking'
                });
            } catch (err) {
                console.error('å„²å­˜å¤±æ•—:', err);
            }
            
            // è¨˜éŒ„å‡ºåº«ç•°å‹•
            logInventoryChange({
                type: 'outbound',
                productName: currentPickingItem.productName,
                spec: currentPickingItem.spec || '',
                quantity: qty,
                quantityChange: -qty,
                locationId: currentPickingItem.locationId,
                batchNo: currentPickingItem.batchNo || '',
                palletId: currentPickingItem.palletId || '',
                note: 'æ‰‹æ©Ÿç‰ˆæ€è²¨ - æ³¢æ¬¡: ' + (currentWave.waveNo || '')
            });
            
            if (qty !== expectedQty) {
                result.className = 'scan-result info';
                result.innerText = 'âš ï¸ æ•¸é‡å·®ç•°ï¼\néœ€è¦: ' + expectedQty + ' / å¯¦éš›: ' + qty;
            } else {
                result.className = 'scan-result success';
                result.innerText = 'âœ… æ€è²¨å®Œæˆï¼' + currentPickingItem.productName + ' x ' + qty;
            }
            
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            
            renderPickingList();
            
            // 1.5 ç§’å¾Œé¡¯ç¤ºä¸‹ä¸€å€‹é …ç›®
            setTimeout(() => {
                showCurrentPickingItem();
            }, 1500);
        };
        
        // é‡ç½®æ€è²¨æ­¥é©Ÿ / è·³éæ­¤é …
        window.resetPickingScan = function() {
            if (currentPickingItem && !currentPickingItem.completed) {
                if (confirm('ç¢ºå®šè¦è·³éæ­¤é …ç›®ï¼Ÿ\n\n' + currentPickingItem.productName + ' x ' + currentPickingItem.pickQty)) {
                    currentPickingItem.shortage = true;
                    renderPickingList();
                }
            }
            showCurrentPickingItem();
        };
        
        // åŸå§‹çš„å–®æ­¥é©Ÿç¢ºèª (ä¿ç•™ç›¸å®¹æ€§)
        window.confirmPickingScan = async function() {
            const input = document.getElementById('picking-scan');
            const result = document.getElementById('picking-scan-result');
            const scanned = input.value.trim();
            
            if (!scanned) return;
            
            const found = pickingItems.find(i => !i.completed && !i.shortage && 
                (i.palletId === scanned || i.locationId === scanned));
            
            if (!found) {
                result.className = 'scan-result error';
                result.innerText = 'âŒ æ‰¾ä¸åˆ°ï¼š' + scanned;
                input.select();
                return;
            }
            
            found.completed = true;
            
            // å„²å­˜é€²åº¦åˆ° Firebase
            try {
                if (!currentWave.completedItems) currentWave.completedItems = [];
                currentWave.completedItems.push(found.id);
                
                await window.updateDoc(window.doc(window.db, 'waves', currentWave.id), {
                    completedItems: currentWave.completedItems,
                    status: 'picking'
                });
            } catch (err) {
                console.error('å„²å­˜å¤±æ•—:', err);
            }
            
            result.className = 'scan-result success';
            result.innerText = 'âœ“ ' + found.productName + ' x ' + found.pickQty;
            
            // ğŸ“ è¨˜éŒ„å‡ºåº«ç•°å‹•
            logInventoryChange({
                type: 'outbound',
                productName: found.productName,
                spec: found.spec || '',
                quantity: found.pickQty,
                quantityChange: -found.pickQty,  // è² æ•¸è¡¨ç¤ºå‡ºåº«
                locationId: found.locationId,
                batchNo: found.batchNo || '',
                palletId: found.palletId || '',
                note: 'æ‰‹æ©Ÿç‰ˆæ€è²¨ - æ³¢æ¬¡: ' + (currentWave.waveNo || '')
            });
            
            renderPickingList();
            input.value = '';
            input.focus();
            
            // éœ‡å‹•åé¥‹
            if (navigator.vibrate) navigator.vibrate(100);
        };
        
        window.completePickingWave = async function() {
            const completed = pickingItems.filter(i => i.completed).length;
            const total = pickingItems.filter(i => !i.shortage).length;
            
            if (completed === 0) {
                alert('å°šæœªæ€è²¨ä»»ä½•é …ç›®');
                return;
            }
            
            if (!confirm(`å®Œæˆæ³¢æ¬¡ï¼Ÿ\n\nå·²æ€ï¼š${completed}/${total}`)) return;
            
            // æ›´æ–° Firebase
            try {
                await window.updateDoc(window.doc(window.db, 'waves', currentWave.id), {
                    status: 'done',
                    completedAt: new Date().toISOString()
                });
            } catch (err) {
                console.error('æ›´æ–°å¤±æ•—:', err);
            }
            
            alert('âœ… æ³¢æ¬¡å®Œæˆï¼');
            goBack();
        };
        
        // ========== å…¥åº«ä»»å‹™ ==========
        
        function loadInboundTasks() {
            var tasks = (window.inboundTasks || []).filter(function(t) { return t.status !== 'done'; });
            
            var list = document.getElementById('inbound-list');
            var countEl = document.getElementById('inbound-count');
            
            // å¦‚æœæ•¸æ“šé‚„æ²’è¼‰å…¥ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
            if (!window.inboundTasks || window.inboundTasks.length === 0) {
                if (list) list.innerHTML = '<div class="loading"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>';
                if (countEl) countEl.innerText = 'è¼‰å…¥ä¸­...';
                return;
            }
            
            if (countEl) countEl.innerText = tasks.length + ' ç­†å¾…å…¥åº«';
            
            if (tasks.length === 0) {
                list.innerHTML = '<div class="empty-state"><i class="fa-solid fa-inbox"></i><p>ç›®å‰æ²’æœ‰å¾…å…¥åº«ä»»å‹™</p></div>';
                return;
            }
            
            list.innerHTML = tasks.map(function(t) {
                return '<div class="list-item" style="cursor:pointer;" onclick="selectInboundTask(\'' + t.id + '\')">' +
                    '<div class="item-row">' +
                    '<span class="item-location">' + (t.locationId || 'å¾…åˆ†é…') + '</span>' +
                    '<span class="item-status pending">é»æ“ŠåŸ·è¡Œ</span>' +
                    '</div>' +
                    '<div class="item-product">' + t.productName + '</div>' +
                    '<div class="item-row">' +
                    '<span class="item-detail">' + (t.palletId || '-') + ' | ' + (t.batchNo || '-') + '</span>' +
                    '<span class="item-qty">' + t.quantity + '</span>' +
                    '</div>' +
                    '</div>';
            }).join('');
        }
        
        // é»æ“Šä»»å‹™ - ç›´æ¥é€²å…¥æƒææ­¥é©Ÿï¼ˆä¸ç”¨ç¢ºèªè¦–çª—ï¼‰
        window.selectInboundTask = function(taskId) {
            console.log('[selectInboundTask] é–‹å§‹, taskId:', taskId);
            
            var task = (window.inboundTasks || []).find(function(t) { return t.id === taskId; });
            if (!task) { showToast('æ‰¾ä¸åˆ°ä»»å‹™'); return; }
            
            console.log('[selectInboundTask] æ‰¾åˆ°ä»»å‹™:', task);
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦è²¡å‹™æ ¸å‡†
            if (task.approvalStatus === 'pending') {
                showToast('âš ï¸ æ­¤å…¥åº«å–®å°šæœªç¶“è²¡å‹™æ ¸å‡†');
                return;
            }
            
            // ç›´æ¥è¨­å®šä»»å‹™ä¸¦é€²å…¥æƒææ­¥é©Ÿ
            window.currentInboundTask = task;
            console.log('[selectInboundTask] è¨­å®š window.currentInboundTask:', window.currentInboundTask);
            
            // é¡¯ç¤ºä»»å‹™è³‡è¨Š
            document.getElementById('inbound-show-product').innerText = task.productName + (task.spec ? ' / ' + task.spec : '');
            document.getElementById('inbound-show-qty').innerText = (task.quantity || 0) + ' ä»¶';
            document.getElementById('inbound-show-location').innerText = task.locationId || '-';
            
            // è·³åˆ° Step 2
            document.getElementById('inbound-step1').style.display = 'none';
            document.getElementById('inbound-step2').style.display = 'block';
            
            var result = document.getElementById('inbound-scan-result');
            result.className = 'scan-result info';
            result.innerHTML = '<div style="text-align:center;">' +
                '<div style="color:#22c55e;font-size:16px;font-weight:bold;">ğŸ“ è«‹å‰å¾€å„²ä½</div>' +
                '<div style="color:#fbbf24;font-size:24px;font-weight:bold;margin-top:4px;">' + task.locationId + '</div>' +
                '<div style="color:#94a3b8;font-size:12px;margin-top:4px;">åˆ°é”å¾Œæƒæå„²ä½æ¢ç¢¼</div>' +
                '</div>';
            
            setTimeout(function() { document.getElementById('inbound-location-scan').focus(); }, 100);
            if (navigator.vibrate) navigator.vibrate(50);
            playBeep();
        };
        
        // ç¢ºèªå¾Œé€²å…¥ Step 2
        window.confirmInboundTaskAndProceed = function() {
            var task = window.pendingInboundTask;
            if (!task) return;
            
            // é—œé–‰ Modal
            document.getElementById('inbound-confirm-modal').style.display = 'none';
            
            window.currentInboundTask = task;
            
            // é¡¯ç¤ºä»»å‹™è³‡è¨Š
            document.getElementById('inbound-show-product').innerText = task.productName + (task.spec ? ' / ' + task.spec : '');
            document.getElementById('inbound-show-qty').innerText = (task.quantity || 0) + ' ä»¶';
            document.getElementById('inbound-show-location').innerText = task.locationId || '-';
            
            // è·³åˆ° Step 2
            document.getElementById('inbound-step1').style.display = 'none';
            document.getElementById('inbound-step2').style.display = 'block';
            
            var result = document.getElementById('inbound-scan-result');
            result.className = 'scan-result info';
            result.innerHTML = '<div style="text-align:center;">' +
                '<div style="color:#22c55e;font-size:16px;font-weight:bold;">ğŸ“ è«‹å‰å¾€å„²ä½</div>' +
                '<div style="color:#fbbf24;font-size:24px;font-weight:bold;margin-top:4px;">' + task.locationId + '</div>' +
                '<div style="color:#94a3b8;font-size:12px;margin-top:4px;">åˆ°é”å¾Œæƒæå„²ä½æ¢ç¢¼ç¢ºèª</div>' +
                '</div>';
            
            setTimeout(function() { document.getElementById('inbound-location-scan').focus(); }, 100);
            playBeep();
        };
        
        // å–æ¶ˆç¢ºèª
        window.cancelInboundConfirm = function() {
            document.getElementById('inbound-confirm-modal').style.display = 'none';
            window.pendingInboundTask = null;
        };
        
        // ========== å…¥åº«é›™é‡æƒæé©—è­‰ (v3.0 å‡ç´š) ==========
        window.currentInboundTask = null;
        
        window.confirmInboundPallet = async function() {
            var input = document.getElementById('inbound-pallet-scan');
            var result = document.getElementById('inbound-scan-result');
            var rawInput = input.value.trim();
            
            if (!rawInput) {
                result.className = 'scan-result error';
                result.innerText = 'è«‹æƒææ¿è™Ÿ';
                return;
            }
            
            var scanned = formatPalletId(rawInput);
            
            // æŸ¥æ‰¾ä»»å‹™ï¼ˆåŒæ™‚æ¯”å°æ ¼å¼åŒ–å‰å¾Œçš„å€¼ï¼‰
            var task = (window.inboundTasks || []).find(function(t) {
                if (t.status === 'done') return false;
                var taskPallet = formatPalletId(t.palletId || '');
                var taskOrder = formatPalletId(t.orderNo || '');
                return taskPallet === scanned || taskOrder === scanned || 
                       t.palletId === rawInput || t.orderNo === rawInput;
            });
            
            if (!task) {
                result.className = 'scan-result error';
                result.innerText = 'âŒ æ‰¾ä¸åˆ°æ­¤æ¿è™Ÿçš„å…¥åº«ä»»å‹™: ' + scanned;
                input.value = '';
                input.focus();
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦è²¡å‹™æ ¸å‡†
            if (task.approvalStatus === 'pending') {
                result.className = 'scan-result error';
                result.innerText = 'âš ï¸ æ­¤å…¥åº«å–®å°šæœªç¶“è²¡å‹™æ ¸å‡†';
                input.value = '';
                return;
            }
            
            window.currentInboundTask = task;
            
            // é¡¯ç¤ºä»»å‹™è³‡è¨Š
            document.getElementById('inbound-show-product').innerText = task.productName + (task.spec ? ' / ' + task.spec : '');
            document.getElementById('inbound-show-qty').innerText = (task.quantity || 0) + ' ä»¶';
            document.getElementById('inbound-show-location').innerText = task.locationId || '-';
            
            // åˆ‡æ›åˆ° Step 2
            document.getElementById('inbound-step1').style.display = 'none';
            document.getElementById('inbound-step2').style.display = 'block';
            
            result.className = 'scan-result info';
            result.innerText = 'âœ“ æ¿è™Ÿç¢ºèªï¼Œè«‹å‰å¾€å„²ä½: ' + task.locationId;
            
            setTimeout(() => document.getElementById('inbound-location-scan').focus(), 100);
            if (navigator.vibrate) navigator.vibrate(50);
        };
        
        window.confirmInboundLocation = async function() {
            console.log('[confirmInboundLocation] é–‹å§‹åŸ·è¡Œ');
            console.log('[confirmInboundLocation] currentInboundTask:', window.currentInboundTask);
            
            var input = document.getElementById('inbound-location-scan');
            var result = document.getElementById('inbound-scan-result');
            var rawInput = input.value.trim();
            
            console.log('[confirmInboundLocation] rawInput:', rawInput);
            
            if (!rawInput) {
                result.className = 'scan-result error';
                result.innerText = 'è«‹æƒæå„²ä½æ¢ç¢¼';
                return;
            }
            
            if (!window.currentInboundTask) {
                console.log('[confirmInboundLocation] éŒ¯èª¤: currentInboundTask ç‚º null');
                result.className = 'scan-result error';
                result.innerText = 'âŒ è«‹å…ˆé¸æ“‡å…¥åº«ä»»å‹™';
                resetInboundStep();
                return;
            }
            
            // æ ¼å¼åŒ–è¼¸å…¥çš„å„²ä½
            var scanned = formatLocationId(rawInput);
            var expected = (window.currentInboundTask.locationId || '').toUpperCase();
            
            console.log('[confirmInboundLocation] scanned:', scanned, 'expected:', expected);
            
            // åŒæ™‚æ¯”å°æ ¼å¼åŒ–å¾Œå’ŒåŸå§‹æ ¼å¼
            if (scanned === expected || formatLocationId(expected) === scanned) {
                // å„²ä½æ­£ç¢ºï¼Œå®Œæˆå…¥åº«
                try {
                    await window.updateDoc(window.doc(window.db, 'inboundTasks', window.currentInboundTask.id), {
                        status: 'done',
                        confirmedAt: new Date().toISOString(),
                        confirmedBy: window.currentUser ? window.currentUser.email : 'operator',
                        confirmedLocation: expected
                    });
                    
                    // ğŸ“ è¨˜éŒ„å…¥åº«ç•°å‹•
                    logInventoryChange({
                        type: 'inbound',
                        productName: window.currentInboundTask.productName,
                        spec: window.currentInboundTask.spec || '',
                        quantity: window.currentInboundTask.quantity,
                        quantityChange: window.currentInboundTask.quantity,
                        locationId: window.currentInboundTask.locationId,
                        batchNo: window.currentInboundTask.batchNo || '',
                        palletId: window.currentInboundTask.palletId || '',
                        expDate: window.currentInboundTask.expDate || '',
                        note: 'æ‰‹æ©Ÿç‰ˆå…¥åº«ç¢ºèª'
                    });
                    
                    // éœ‡å‹•+éŸ³æ•ˆ
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    playBeep('success');
                    
                    // é¡¯ç¤ºå¿«é€ŸæˆåŠŸè¨Šæ¯
                    showToast('âœ… ' + window.currentInboundTask.productName + ' å…¥åº«å®Œæˆ');
                    
                    // è‡ªå‹•é‡ç½®ä¸¦è¼‰å…¥ä¸‹ä¸€å€‹ä»»å‹™
                    resetInboundStep();
                    loadInboundTasks();
                    
                    // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å¾…è¾¦ä»»å‹™
                    var remaining = (window.inboundTasks || []).filter(function(t) { 
                        return t.status !== 'done'; 
                    });
                    
                    if (remaining.length > 0) {
                        result.className = 'scan-result success';
                        result.innerHTML = 'âœ… å…¥åº«å®Œæˆï¼é‚„æœ‰ ' + remaining.length + ' ç­†å¾…è™•ç†';
                    } else {
                        result.className = 'scan-result success';
                        result.innerHTML = 'ğŸ‰ å¤ªæ£’äº†ï¼æ‰€æœ‰å…¥åº«ä»»å‹™å·²å®Œæˆ';
                    }
                    
                } catch (err) {
                    result.className = 'scan-result error';
                    result.innerText = 'âŒ ç¢ºèªå¤±æ•—: ' + err.message;
                }
            } else {
                // å„²ä½éŒ¯èª¤
                result.className = 'scan-result error';
                result.innerText = 'âŒ å„²ä½éŒ¯èª¤ï¼\n\næƒæçš„: ' + scanned + '\næ­£ç¢ºçš„: ' + expected + '\n\nè«‹ç§»è‡³æ­£ç¢ºå„²ä½';
                input.value = '';
                input.focus();
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        };
        
        window.resetInboundStep = function() {
            window.currentInboundTask = null;
            document.getElementById('inbound-step1').style.display = 'block';
            document.getElementById('inbound-step2').style.display = 'none';
            document.getElementById('inbound-pallet-scan').value = '';
            document.getElementById('inbound-location-scan').value = '';
            var result = document.getElementById('inbound-scan-result');
            result.className = 'scan-result';
            result.innerText = '';
        };
        
        window.confirmInboundScan = async function() {
            const input = document.getElementById('inbound-scan');
            const result = document.getElementById('inbound-scan-result');
            const scanned = input.value.trim();
            
            if (!scanned) return;
            
            // å…ˆæª¢æŸ¥å¾…å…¥åº«ä»»å‹™
            const task = (window.inboundTasks || []).find(t => 
                t.status !== 'done' && (t.palletId === scanned || t.orderNo === scanned)
            );
            
            if (task) {
                // æ‰¾åˆ°ä»»å‹™ï¼Œç¢ºèªå…¥åº«
                try {
                    await window.updateDoc(window.doc(window.db, 'inboundTasks', task.id), {
                        status: 'done',
                        confirmedAt: new Date().toISOString()
                    });
                    
                    result.className = 'scan-result success';
                    result.innerText = 'âœ“ å…¥åº«ç¢ºèªï¼š' + task.productName + ' @ ' + task.locationId;
                    
                    loadInboundTasks();
                    if (navigator.vibrate) navigator.vibrate(100);
                } catch (err) {
                    result.className = 'scan-result error';
                    result.innerText = 'âŒ ç¢ºèªå¤±æ•—ï¼š' + err.message;
                }
            } else {
                // æª¢æŸ¥åº«å­˜æ˜¯å¦å·²å­˜åœ¨
                const found = window.pallets.find(p => p.palletId === scanned);
                
                if (found) {
                    result.className = 'scan-result success';
                    result.innerText = 'âœ“ å·²å­˜åœ¨ï¼š' + found.productName + ' @ ' + found.locationId;
                } else {
                    result.className = 'scan-result error';
                    result.innerText = 'âŒ æ‰¾ä¸åˆ°ï¼š' + scanned;
                }
            }
            
            input.value = '';
            input.focus();
        };
        
        // ========== èª¿åº¦åŸ·è¡Œ ==========
        let currentDispatch = null;
        let dispatchItems = [];
        
        function loadDispatchOrders() {
            const orders = (window.dispatchOrders || []).filter(o => o.status !== 'done');
            
            const select = document.getElementById('dispatch-order-select');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ --</option>';
            
            orders.forEach((order, idx) => {
                const ops = (order.operations || []).length;
                select.innerHTML += `<option value="${order.id}">${order.orderNo || 'å·¥å–®'} - ${order.productName || ''} (${ops}é …)</option>`;
            });
        }
        
        window.loadDispatchOrder = function() {
            const orderId = document.getElementById('dispatch-order-select').value;
            if (!orderId) {
                document.getElementById('dispatch-scan-area').style.display = 'none';
                document.getElementById('dispatch-actions').style.display = 'none';
                return;
            }
            
            currentDispatch = (window.dispatchOrders || []).find(o => o.id === orderId);
            if (!currentDispatch) return;
            
            dispatchItems = (currentDispatch.operations || []).map((op, idx) => ({
                ...op,
                id: op.id || 'op-' + idx,
                completed: (currentDispatch.completedOps || []).includes(op.id || 'op-' + idx)
            }));
            
            renderDispatchList();
            document.getElementById('dispatch-scan-area').style.display = 'block';
            document.getElementById('dispatch-actions').style.display = 'block';
            document.getElementById('dispatch-scan').focus();
        };
        
        function renderDispatchList() {
            const list = document.getElementById('dispatch-list');
            const completed = dispatchItems.filter(i => i.completed).length;
            document.getElementById('dispatch-progress').innerText = completed + '/' + dispatchItems.length;
            
            if (dispatchItems.length === 0) {
                list.innerHTML = '<div class="empty-state"><i class="fa-solid fa-clipboard-list"></i><p>ç„¡èª¿åº¦é …ç›®</p></div>';
                return;
            }
            
            list.innerHTML = dispatchItems.map(item => {
                const cls = item.completed ? 'completed' : '';
                const status = item.completed ? '<span class="item-status done">âœ“ å®Œæˆ</span>' :
                              '<span class="item-status pending">' + item.type + '</span>';
                return `
                    <div class="list-item ${cls}">
                        <div class="item-row">
                            <span class="item-location">${item.from}</span>
                            ${status}
                        </div>
                        <div class="item-product">${item.palletId || '-'} â†’ ${item.to}</div>
                        <div class="item-row">
                            <span class="item-detail">${item.type}</span>
                            <span class="item-qty">${item.qty}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        window.confirmDispatchScan = async function() {
            const input = document.getElementById('dispatch-scan');
            const result = document.getElementById('dispatch-scan-result');
            const scanned = input.value.trim();
            
            if (!scanned) return;
            
            const found = dispatchItems.find(i => !i.completed && 
                (i.palletId === scanned || i.from === scanned));
            
            if (!found) {
                result.className = 'scan-result error';
                result.innerText = 'âŒ æ‰¾ä¸åˆ°ï¼š' + scanned;
                input.select();
                return;
            }
            
            found.completed = true;
            
            // å„²å­˜é€²åº¦åˆ° Firebase
            try {
                if (!currentDispatch.completedOps) currentDispatch.completedOps = [];
                currentDispatch.completedOps.push(found.id);
                
                await window.updateDoc(window.doc(window.db, 'dispatchOrders', currentDispatch.id), {
                    completedOps: currentDispatch.completedOps,
                    status: 'executing'
                });
            } catch (err) {
                console.error('å„²å­˜å¤±æ•—:', err);
            }
            
            result.className = 'scan-result success';
            result.innerText = 'âœ“ ' + found.from + ' â†’ ' + found.to;
            
            // ğŸ“ è¨˜éŒ„èª¿åº¦ç•°å‹•
            logInventoryChange({
                type: 'move',
                productName: currentDispatch.productName || '',
                fromLocation: found.from,
                toLocation: found.to,
                locationId: found.to,
                palletId: found.palletId || scanned,
                note: 'æ‰‹æ©Ÿç‰ˆèª¿åº¦åŸ·è¡Œ'
            });
            
            renderDispatchList();
            input.value = '';
            input.focus();
            if (navigator.vibrate) navigator.vibrate(100);
        };
        
        window.completeDispatchOrder = async function() {
            const completed = dispatchItems.filter(i => i.completed).length;
            
            if (completed === 0) {
                alert('å°šæœªåŸ·è¡Œä»»ä½•æ“ä½œ');
                return;
            }
            
            if (!confirm(`å®Œæˆå·¥å–®ï¼Ÿ\n\nå·²åŸ·è¡Œï¼š${completed}/${dispatchItems.length}`)) return;
            
            // æ›´æ–° Firebase
            try {
                await window.updateDoc(window.doc(window.db, 'dispatchOrders', currentDispatch.id), {
                    status: 'done',
                    completedAt: new Date().toISOString()
                });
            } catch (err) {
                console.error('æ›´æ–°å¤±æ•—:', err);
            }
            
            alert('âœ… å·¥å–®å®Œæˆï¼');
            goBack();
        };
        
        // ========== åº«å­˜å¿«æŸ¥ ==========
        window.doInventoryQuery = function() {
            const input = document.getElementById('query-input');
            const result = document.getElementById('query-result');
            const keyword = input.value.trim().toLowerCase();
            
            if (!keyword) return;
            
            const matches = window.pallets.filter(p => 
                (p.productName && p.productName.toLowerCase().includes(keyword)) ||
                (p.palletId && p.palletId.toLowerCase().includes(keyword)) ||
                (p.batchNo && p.batchNo.toLowerCase().includes(keyword))
            );
            
            if (matches.length === 0) {
                result.innerHTML = '<div class="empty-state"><i class="fa-solid fa-search"></i><p>æ‰¾ä¸åˆ°ï¼š' + keyword + '</p></div>';
                return;
            }
            
            // æŒ‰å“ååˆ†çµ„
            const grouped = {};
            matches.forEach(p => {
                const key = p.productName;
                if (!grouped[key]) grouped[key] = { name: p.productName, spec: p.spec, items: [] };
                grouped[key].items.push(p);
            });
            
            result.innerHTML = Object.values(grouped).map(g => `
                <div class="result-card">
                    <div class="result-product">${g.name}</div>
                    <div class="result-spec">${g.spec || ''}</div>
                    ${g.items.map(p => `
                        <div class="result-row">
                            <span class="result-loc">${p.locationId}</span>
                            <span class="result-qty">${p.quantity} ä»¶</span>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        };
        
        // Enter éµè§¸ç™¼
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const active = document.activeElement;
                if (active.id === 'picking-scan') confirmPickingScan();
                if (active.id === 'inbound-scan') confirmInboundScan();
                if (active.id === 'dispatch-scan') confirmDispatchScan();
                if (active.id === 'query-input') doInventoryQuery();
            }
        });
    

        // ========== å›é¥‹å·¥å…· ==========
        // éœ‡å‹•å›é¥‹
        window.vibrate = function(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern || 100);
            }
        };
        
        // æˆåŠŸéœ‡å‹•ï¼ˆçŸ­ï¼‰
        window.vibrateSuccess = function() { vibrate(100); };
        
        // éŒ¯èª¤éœ‡å‹•ï¼ˆé•·-çŸ­-é•·ï¼‰
        window.vibrateError = function() { vibrate([200, 100, 200]); };
        
        // éŸ³æ•ˆæ’­æ”¾
        window.playBeep = function(type) {
            try {
                var ctx = new (window.AudioContext || window.webkitAudioContext)();
                var osc = ctx.createOscillator();
                var gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                if (type === 'success') {
                    osc.frequency.value = 880; // é«˜éŸ³
                    gain.gain.value = 0.3;
                    osc.start();
                    setTimeout(function() { osc.stop(); ctx.close(); }, 150);
                } else if (type === 'error') {
                    osc.frequency.value = 220; // ä½éŸ³
                    gain.gain.value = 0.3;
                    osc.start();
                    setTimeout(function() { osc.stop(); ctx.close(); }, 300);
                } else {
                    osc.frequency.value = 660; // ä¸­éŸ³ï¼ˆæ™®é€šå—¶ï¼‰
                    gain.gain.value = 0.2;
                    osc.start();
                    setTimeout(function() { osc.stop(); ctx.close(); }, 100);
                }
            } catch (e) { console.log('Audio not supported'); }
        };
        
        // æˆåŠŸå›é¥‹ï¼ˆéœ‡å‹•+éŸ³æ•ˆï¼‰
        window.feedbackSuccess = function() {
            vibrateSuccess();
            playBeep('success');
        };
        
        // éŒ¯èª¤å›é¥‹
        window.feedbackError = function() {
            vibrateError();
            playBeep('error');
        };
        



        // ========== è‡ªå‹•æƒæè§¸ç™¼ï¼ˆç„¡éœ€æŒ‰ç¢ºèªéµï¼‰==========
        // æ¢ç¢¼æ§é€šå¸¸æœƒåœ¨æƒæå¾Œè‡ªå‹•é€å‡º Enter éµ
        // æˆ–è€…ç•¶è¼¸å…¥é•·åº¦é”åˆ°ä¸€å®šå€¼æ™‚è‡ªå‹•è§¸ç™¼
        
        var scanTimeout = null;
        var MIN_SCAN_LENGTH = 3;  // æœ€å°æœ‰æ•ˆæƒæé•·åº¦
        
        function autoTrigger(inputId, callback, delay) {
            delay = delay || 300;
            var input = document.getElementById(inputId);
            if (!input) return;
            var val = input.value.trim();
            if (val.length < MIN_SCAN_LENGTH) return;
            
            clearTimeout(scanTimeout);
            scanTimeout = setTimeout(function() {
                callback();
            }, delay);
        }
        
        // ----- å…¥åº«è‡ªå‹•è§¸ç™¼ -----
        window.autoScanInLoc = function(e) {
            // Enter éµç›´æ¥è§¸ç™¼
            if (e.keyCode === 13) { scanInboundStep1(); return; }
            // æˆ–è€…å»¶é²è‡ªå‹•è§¸ç™¼
            autoTrigger('scan-in-location', scanInboundStep1, 500);
        };
        
        window.autoScanInPallet = function(e) {
            if (e.keyCode === 13) { scanInboundStep2(); return; }
            autoTrigger('scan-in-pallet', scanInboundStep2, 500);
        };
        
        // ----- å‡ºåº«è‡ªå‹•è§¸ç™¼ -----
        window.autoScanOutPallet = function(e) {
            if (e.keyCode === 13) { scanOutboundStep1(); return; }
            autoTrigger('scan-out-pallet', scanOutboundStep1, 500);
        };
        
        // ----- ç§»æ¿è‡ªå‹•è§¸ç™¼ -----
        window.autoScanMovePallet = function(e) {
            if (e.keyCode === 13) { scanMoveStep1(); return; }
            autoTrigger('scan-move-pallet', scanMoveStep1, 500);
        };
        
        window.autoScanMoveNewLoc = function(e) {
            if (e.keyCode === 13) { scanMoveStep2(); return; }
            autoTrigger('scan-move-new-loc', scanMoveStep2, 500);
        };
        
        // ----- ä½µæ¿è‡ªå‹•è§¸ç™¼ -----
        window.autoScanMergeLess = function(e) {
            if (e.keyCode === 13) { scanMergeStep1(); return; }
            autoTrigger('scan-merge-less', scanMergeStep1, 500);
        };
        
        window.autoScanMergeMore = function(e) {
            if (e.keyCode === 13) { scanMergeStep2(); return; }
            autoTrigger('scan-merge-more', scanMergeStep2, 500);
        };
        
        // ========== ç›¸æ©Ÿæƒæå®Œæˆå¾Œè‡ªå‹•è§¸ç™¼ ==========
        var originalOnScanSuccess = window.onScanSuccess;
        window.onScanSuccess = function(decodedText) {
            if (originalOnScanSuccess) originalOnScanSuccess(decodedText);
            
            // æ ¹æ“šç•¶å‰ç„¦é»çš„è¼¸å…¥æ¡†è‡ªå‹•è§¸ç™¼å°æ‡‰å‡½æ•¸
            setTimeout(function() {
                var activeId = document.activeElement ? document.activeElement.id : '';
                if (activeId === 'scan-in-location') scanInboundStep1();
                else if (activeId === 'scan-in-pallet') scanInboundStep2();
                else if (activeId === 'scan-out-pallet') scanOutboundStep1();
                else if (activeId === 'scan-move-pallet') scanMoveStep1();
                else if (activeId === 'scan-move-new-loc') scanMoveStep2();
                else if (activeId === 'scan-merge-less') scanMergeStep1();
                else if (activeId === 'scan-merge-more') scanMergeStep2();
            }, 100);
        };

        // ========== æ–°ç‰ˆæƒæä½œæ¥­æµç¨‹ ==========
        var scanData = {
            inbound: { location: null },
            outbound: { pallet: null, stock: 0 },
            move: { pallet: null, oldLoc: null },
            merge: { less: null, more: null }
        };

        

        
        // ----- å…¥åº«ä½œæ¥­ -----
        window.scanInboundStep1 = function() {
            var rawLoc = document.getElementById('scan-in-location').value.trim();
            if (!rawLoc || rawLoc.length < 5) return; // æœ€å°‘5ç¢¼å¦‚ IA011
            var loc = formatLocationId(rawLoc);
            if (!loc || loc.length < 8) { showToast('å„²ä½æ ¼å¼ä¸æ­£ç¢º'); return; }
            
            scanData.inbound.location = loc;
            document.getElementById('scan-in-loc-display').innerText = loc;
            document.getElementById('scan-in-step1').style.display = 'none';
            document.getElementById('scan-in-step2').style.display = 'block';
            
            feedbackSuccess(); // éœ‡å‹•+éŸ³æ•ˆ
            setTimeout(function() { document.getElementById('scan-in-pallet').focus(); }, 100);
        };
        
        window.scanInboundStep2 = async function() {
            var rawId = document.getElementById('scan-in-pallet').value.trim();
            if (!rawId) { showToast('è«‹æƒææ’å–®'); return; }
            var palletId = formatPalletId(rawId);
            
            var loc = scanData.inbound.location;
            var result = document.getElementById('scan-in-result');
            
            // æŸ¥æ‰¾æ£§æ¿ - å¾å¤šå€‹ä¾†æºæŸ¥æ‰¾
            var pallet = null;
            if (window.allPallets && window.allPallets.length > 0) {
                pallet = window.allPallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            if (!pallet && window.pallets && window.pallets.length > 0) {
                pallet = window.pallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ Firebase æŸ¥è©¢
            if (!pallet) {
                try {
                    var docRef = window.doc(window.db, "pallets", palletId);
                    var docSnap = await window.getDoc(docRef);
                    if (docSnap.exists()) {
                        pallet = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch(e) { console.log('FirebaseæŸ¥è©¢å¤±æ•—:', e); }
            }
            
            if (!pallet) {
                feedbackError();
                result.innerHTML = '<div style="color:#f87171;text-align:center;padding:12px;"><i class="fa-solid fa-times-circle"></i> æ‰¾ä¸åˆ°æ­¤æ£§æ¿: ' + palletId + '</div>';
                document.getElementById('scan-in-pallet').value = '';
                document.getElementById('scan-in-pallet').focus();
                return;
            }
            
            // å„²å­˜æ£§æ¿è³‡è¨Šåˆ° scanData
            scanData.inbound.pallet = pallet;
            
            // é¡¯ç¤º Step 3: ç¢ºèªä»¶æ•¸
            document.getElementById('scan-in-step2').style.display = 'none';
            document.getElementById('scan-in-step3').style.display = 'block';
            
            // å¡«å…¥æ£§æ¿è³‡è¨Š
            document.getElementById('scan-in-loc-display2').innerText = scanData.inbound.location;
            document.getElementById('scan-in-product-name').innerText = pallet.productName || '-';
            document.getElementById('scan-in-spec').innerText = pallet.spec || '-';
            document.getElementById('scan-in-batch').innerText = pallet.batchNo || '-';
            document.getElementById('scan-in-qty-input').value = pallet.quantity || '';
            document.getElementById('scan-in-qty-input').placeholder = 'é è¨­: ' + (pallet.quantity || 0);
            
            feedbackSuccess();
            setTimeout(function() { document.getElementById('scan-in-qty-input').focus(); }, 100);
            result.innerHTML = '';
        };
        
        // å…¥åº«æœ€çµ‚ç¢ºèªï¼ˆå«ä»¶æ•¸ï¼‰
        window.confirmScanInbound = async function() {
            var pallet = scanData.inbound.pallet;
            var loc = scanData.inbound.location;
            if (!pallet || !loc) { showToast('è«‹å…ˆæƒæå„²ä½å’Œæ£§æ¿'); return; }
            
            var qty = parseInt(document.getElementById('scan-in-qty-input').value) || pallet.quantity;
            if (qty <= 0) { showToast('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡'); return; }
            
            var result = document.getElementById('scan-in-result');
            
            try {
                await window.updateDoc(window.doc(window.db, "pallets", pallet.id), { 
                    locationId: loc,
                    quantity: qty
                });
                
                // è¨˜éŒ„ç•°å‹•
                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'inbound', productName: pallet.productName, spec: pallet.spec || '',
                    quantity: qty, quantityChange: qty, locationId: loc,
                    batchNo: pallet.batchNo || '', palletId: pallet.palletId || pallet.id, 
                    note: 'æ‰‹æ©Ÿç‰ˆæƒæå…¥åº«',
                    operator: window.currentUser || 'mobile', timestamp: new Date()
                });
                
                result.innerHTML = '<div style="background:#065f46;border-radius:10px;padding:16px;text-align:center;">' +
                    '<div style="font-size:32px;margin-bottom:8px;">âœ…</div>' +
                    '<div style="color:white;font-size:18px;font-weight:bold;">' + pallet.productName + '</div>' +
                    '<div style="color:#6ee7b7;">' + qty + ' ä»¶</div>' +
                    '<div style="color:#10b981;font-weight:bold;margin-top:8px;">å·²ç¶å®šè‡³ ' + loc + '</div>' +
                    '<div style="display:flex;gap:10px;margin-top:16px;">' +
                    '<button onclick="resetScanInbound()" style="flex:1;padding:12px;background:#10b981;border:none;border-radius:8px;color:white;font-weight:bold;">ç¹¼çºŒå…¥åº«</button>' +
                    '<button onclick="goBack()" style="flex:1;padding:12px;background:#475569;border:none;border-radius:8px;color:white;font-weight:bold;">å›ä¸»é¸å–®</button>' +
                    '</div></div>';
                
                vibrateSuccess(); playBeep('success'); 
                showToast('âœ… å…¥åº«æˆåŠŸï¼');
            } catch (err) {
                result.innerHTML = '<div style="color:#f87171;">âŒ å…¥åº«å¤±æ•—: ' + err.message + '</div>';
            }
        };
        
        window.resetScanInbound = function() {
            scanData.inbound = { location: null, pallet: null };
            document.getElementById('scan-in-location').value = '';
            document.getElementById('scan-in-pallet').value = '';
            var qtyInput = document.getElementById('scan-in-qty-input');
            if (qtyInput) qtyInput.value = '';
            document.getElementById('scan-in-step1').style.display = 'block';
            document.getElementById('scan-in-step2').style.display = 'none';
            var step3 = document.getElementById('scan-in-step3');
            if (step3) step3.style.display = 'none';
            document.getElementById('scan-in-result').innerHTML = '';
            setTimeout(function() { document.getElementById('scan-in-location').focus(); }, 100);
        };
        
        // ----- å‡ºåº«ä½œæ¥­ -----
        window.scanOutboundStep1 = async function() {
            var rawId = document.getElementById('scan-out-pallet').value.trim();
            if (!rawId) { showToast('è«‹æƒææ’å–®'); return; }
            var palletId = formatPalletId(rawId);
            
            var result = document.getElementById('scan-out-result');
            
            // å¾å¤šå€‹ä¾†æºæŸ¥æ‰¾æ£§æ¿
            var pallet = null;
            if (window.allPallets && window.allPallets.length > 0) {
                pallet = window.allPallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            if (!pallet && window.pallets && window.pallets.length > 0) {
                pallet = window.pallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ Firebase æŸ¥è©¢
            if (!pallet) {
                try {
                    result.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:8px;"><i class="fa-solid fa-spinner fa-spin"></i> æŸ¥è©¢ä¸­...</div>';
                    var docRef = window.doc(window.db, "pallets", palletId);
                    var docSnap = await window.getDoc(docRef);
                    if (docSnap.exists()) {
                        pallet = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch(e) { console.log('FirebaseæŸ¥è©¢å¤±æ•—:', e); }
            }
            
            if (!pallet) {
                errorFeedback(); 
                result.innerHTML = '<div style="color:#f87171;text-align:center;padding:12px;"><i class="fa-solid fa-times-circle"></i> æ‰¾ä¸åˆ°æ­¤æ£§æ¿: ' + palletId + '</div>';
                document.getElementById('scan-out-pallet').value = '';
                return;
            }
            
            scanData.outbound.pallet = pallet;
            scanData.outbound.stock = pallet.quantity;
            
            document.getElementById('scan-out-product').innerText = pallet.productName;
            document.getElementById('scan-out-spec').innerText = pallet.spec || '-';
            document.getElementById('scan-out-stock').innerText = pallet.quantity;
            document.getElementById('scan-out-loc').innerText = pallet.locationId;
            
            // ç”Ÿæˆå¿«é€Ÿæ•¸é‡æŒ‰éˆ•
            var quickBtns = document.getElementById('scan-out-quick-btns');
            var stock = pallet.quantity;
            var btnHtml = '';
            
            // å¸¸ç”¨æ•¸é‡æŒ‰éˆ•
            var quickNums = [];
            if (stock >= 1) quickNums.push(1);
            if (stock >= 5) quickNums.push(5);
            if (stock >= 10) quickNums.push(10);
            if (stock >= 20) quickNums.push(20);
            if (stock >= 50 && stock > 20) quickNums.push(50);
            // æ·»åŠ åŠæ•¸å’Œå…¨æ•¸
            var half = Math.floor(stock / 2);
            if (half > 0 && quickNums.indexOf(half) === -1) quickNums.push(half);
            
            // æ’åºä¸¦ç”ŸæˆæŒ‰éˆ•
            quickNums.sort(function(a,b){ return a-b; });
            quickNums.forEach(function(num) {
                btnHtml += '<button onclick="setOutQty(' + num + ')" style="padding:12px;background:#334155;border:1px solid #475569;border-radius:8px;color:white;font-weight:bold;font-size:16px;">' + num + '</button>';
            });
            quickBtns.innerHTML = btnHtml;
            
            document.getElementById('scan-out-step1').style.display = 'none';
            document.getElementById('scan-out-step2').style.display = 'block';
            feedbackSuccess();
            setTimeout(function() { document.getElementById('scan-out-qty').focus(); }, 100);
            result.innerHTML = '';
        };
        
        window.setOutQty = function(qty) {
            document.getElementById('scan-out-qty').value = qty;
            // è‡ªå‹•èšç„¦åˆ°ç¢ºèªæŒ‰éˆ•ï¼Œæ–¹ä¾¿ç›´æ¥æŒ‰ Enter
            document.getElementById('scan-out-qty').focus();
        };
        

        // å‡ºåº«æ•¸é‡å¿«æ·è¨­å®š
        window.setOutQty = function(qty) {
            document.getElementById('scan-out-qty').value = qty;
            playBeep();
        };
        
        window.addOutQty = function(delta) {
            var input = document.getElementById('scan-out-qty');
            var current = parseInt(input.value) || 0;
            var newVal = Math.max(0, current + delta);
            var max = scanData.outbound.stock;
            input.value = Math.min(newVal, max);
            playBeep();
        };
        
        
        // å‡ºåº«æ•¸é‡å¿«æ·æŒ‰éˆ•
        window.addOutQty = function(n) {
            var el = document.getElementById('scan-out-qty');
            var current = parseInt(el.value) || 0;
            var max = scanData.outbound.stock;
            el.value = Math.min(current + n, max);
            playBeep();
        };

        window.scanOutboundAll = function() {
            document.getElementById('scan-out-qty').value = scanData.outbound.stock;
        };
        
        window.setOutQty = function(qty) {
            var stock = scanData.outbound.stock;
            var current = parseInt(document.getElementById('scan-out-qty').value) || 0;
            var newQty = current + qty;
            if (newQty > stock) newQty = stock;
            document.getElementById('scan-out-qty').value = newQty;
        };
        
        window.executeScanOutbound = async function() {
            var pallet = scanData.outbound.pallet;
            if (!pallet) { showToast('è«‹å…ˆæƒææ£§æ¿'); return; }
            
            var qty = parseInt(document.getElementById('scan-out-qty').value) || 0;
            if (qty <= 0) { showToast('è«‹è¼¸å…¥å‡ºåº«æ•¸é‡'); return; }
            if (qty > pallet.quantity) { showToast('æ•¸é‡ä¸èƒ½è¶…éåº«å­˜ ' + pallet.quantity); return; }
            
            var newQty = pallet.quantity - qty;
            var result = document.getElementById('scan-out-result');
            
            try {
                if (newQty === 0) {
                    await window.deleteDoc(window.doc(window.db, "pallets", pallet.id));
                } else {
                    await window.updateDoc(window.doc(window.db, "pallets", pallet.id), { quantity: newQty });
                }
                
                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'outbound', productName: pallet.productName, spec: pallet.spec || '',
                    quantity: qty, quantityChange: -qty, locationId: pallet.locationId,
                    batchNo: pallet.batchNo || '', palletId: pallet.palletId, note: 'æ‰‹æ©Ÿç‰ˆæƒæå‡ºåº«',
                    operator: window.currentUser || 'mobile', timestamp: new Date()
                });
                
                result.innerHTML = '<div style="background:#9a3412;border-radius:10px;padding:16px;text-align:center;">' +
                    '<div style="font-size:32px;margin-bottom:8px;">âœ…</div>' +
                    '<div style="color:white;font-size:18px;font-weight:bold;">' + pallet.productName + '</div>' +
                    '<div style="color:#fdba74;">å‡ºåº«ï¼š' + qty + ' ä»¶</div>' +
                    (newQty > 0 ? '<div style="color:#fbbf24;">å‰©é¤˜ï¼š' + newQty + ' ä»¶</div>' : '<div style="color:#f87171;">å·²æ¸…ç©ºï¼Œå„²ä½å·²é‡‹æ”¾</div>') +
                    '<div style="display:flex;gap:10px;margin-top:16px;">' +
                    '<button onclick="resetScanOutbound()" style="flex:1;padding:12px;background:#ea580c;border:none;border-radius:8px;color:white;font-weight:bold;">ç¹¼çºŒå‡ºåº«</button>' +
                    '<button onclick="goBack()" style="flex:1;padding:12px;background:#475569;border:none;border-radius:8px;color:white;font-weight:bold;">å›ä¸»é¸å–®</button>' +
                    '</div></div>';
                
                vibrateSuccess(); playBeep('success');
            } catch (err) {
                result.innerHTML = '<div style="color:#f87171;">âŒ å‡ºåº«å¤±æ•—: ' + err.message + '</div>';
            }
        };
        
        window.resetScanOutbound = function() {
            scanData.outbound = { pallet: null, stock: 0 };
            document.getElementById('scan-out-pallet').value = '';
            document.getElementById('scan-out-qty').value = '';
            document.getElementById('scan-out-step1').style.display = 'block';
            document.getElementById('scan-out-step2').style.display = 'none';
            document.getElementById('scan-out-result').innerHTML = '';
            setTimeout(function() { document.getElementById('scan-out-pallet').focus(); }, 100);
        };
        
        // ----- ç§»æ¿ä½œæ¥­ -----
        window.scanMoveStep1 = async function() {
            var rawId = document.getElementById('scan-move-pallet').value.trim();
            if (!rawId) { showToast('è«‹æƒææ’å–®'); return; }
            var palletId = formatPalletId(rawId);
            
            var result = document.getElementById('scan-move-result');
            
            // å¾å¤šå€‹ä¾†æºæŸ¥æ‰¾æ£§æ¿
            var pallet = null;
            if (window.allPallets && window.allPallets.length > 0) {
                pallet = window.allPallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            if (!pallet && window.pallets && window.pallets.length > 0) {
                pallet = window.pallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ Firebase æŸ¥è©¢
            if (!pallet) {
                try {
                    result.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:8px;"><i class="fa-solid fa-spinner fa-spin"></i> æŸ¥è©¢ä¸­...</div>';
                    var docRef = window.doc(window.db, "pallets", palletId);
                    var docSnap = await window.getDoc(docRef);
                    if (docSnap.exists()) {
                        pallet = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch(e) { console.log('FirebaseæŸ¥è©¢å¤±æ•—:', e); }
            }
            
            if (!pallet) {
                errorFeedback(); 
                result.innerHTML = '<div style="color:#f87171;text-align:center;padding:12px;"><i class="fa-solid fa-times-circle"></i> æ‰¾ä¸åˆ°æ­¤æ£§æ¿: ' + palletId + '</div>';
                document.getElementById('scan-move-pallet').value = '';
                return;
            }
            
            scanData.move.pallet = pallet;
            scanData.move.oldLoc = pallet.locationId;
            
            document.getElementById('scan-move-product').innerText = pallet.productName + ' | ' + pallet.quantity + 'ä»¶';
            document.getElementById('scan-move-old-loc').innerText = pallet.locationId;
            
            document.getElementById('scan-move-step1').style.display = 'none';
            document.getElementById('scan-move-step2').style.display = 'block';
            feedbackSuccess();
            setTimeout(function() { document.getElementById('scan-move-new-loc').focus(); }, 100);
            result.innerHTML = '';
        };
        
        window.scanMoveStep2 = async function() {
            var rawLoc = document.getElementById('scan-move-new-loc').value.trim();
            if (!rawLoc) { showToast('è«‹æƒææ–°å„²ä½'); return; }
            var newLoc = formatLocationId(rawLoc);
            
            var pallet = scanData.move.pallet;
            var oldLoc = scanData.move.oldLoc;
            var result = document.getElementById('scan-move-result');
            
            try {
                await window.updateDoc(window.doc(window.db, "pallets", pallet.id), { locationId: newLoc });
                
                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'move', productName: pallet.productName, spec: pallet.spec || '',
                    quantity: pallet.quantity, quantityChange: 0, locationId: newLoc, fromLocation: oldLoc,
                    releasedLocation: oldLoc,  // è¢«é‡‹æ”¾çš„åŸå„²ä½
                    batchNo: pallet.batchNo || '', palletId: pallet.palletId, 
                    note: 'æ‰‹æ©Ÿç‰ˆæƒæç§»æ¿: ' + oldLoc + 'â†’' + newLoc + ', å„²ä½ ' + oldLoc + ' å·²é‡‹æ”¾',
                    operator: window.currentUser || 'mobile', timestamp: new Date()
                });
                
                result.innerHTML = '<div style="background:#1e40af;border-radius:10px;padding:16px;text-align:center;">' +
                    '<div style="font-size:32px;margin-bottom:8px;">âœ…</div>' +
                    '<div style="color:white;font-size:16px;font-weight:bold;">' + pallet.productName + '</div>' +
                    '<div style="display:flex;justify-content:center;align-items:center;gap:12px;margin-top:8px;">' +
                    '<span style="color:#94a3b8;text-decoration:line-through;">' + oldLoc + '</span>' +
                    '<span style="color:#3b82f6;">â†’</span>' +
                    '<span style="color:#60a5fa;font-size:18px;font-weight:bold;">' + newLoc + '</span></div>' +
                    '<div style="color:#a3e635;font-size:12px;margin-top:8px;">ğŸ“ å„²ä½ ' + oldLoc + ' å·²é‡‹æ”¾</div>' +
                    '<div style="display:flex;gap:10px;margin-top:16px;">' +
                    '<button onclick="resetScanMove()" style="flex:1;padding:12px;background:#3b82f6;border:none;border-radius:8px;color:white;font-weight:bold;">ç¹¼çºŒç§»æ¿</button>' +
                    '<button onclick="goBack()" style="flex:1;padding:12px;background:#475569;border:none;border-radius:8px;color:white;font-weight:bold;">å›ä¸»é¸å–®</button>' +
                    '</div></div>';
                
                vibrateSuccess(); playBeep('success');
                showToast('âœ… ç§»æ¿æˆåŠŸï¼');
            } catch (err) {
                result.innerHTML = '<div style="color:#f87171;">âŒ ç§»æ¿å¤±æ•—: ' + err.message + '</div>';
            }
        };
        
        window.resetScanMove = function() {
            scanData.move = { pallet: null, oldLoc: null };
            document.getElementById('scan-move-pallet').value = '';
            document.getElementById('scan-move-new-loc').value = '';
            document.getElementById('scan-move-step1').style.display = 'block';
            document.getElementById('scan-move-step2').style.display = 'none';
            document.getElementById('scan-move-result').innerHTML = '';
            setTimeout(function() { document.getElementById('scan-move-pallet').focus(); }, 100);
        };
        
        // ----- ä½µæ¿ä½œæ¥­ -----
        window.scanMergeStep1 = async function() {
            var rawId = document.getElementById('scan-merge-less').value.trim();
            if (!rawId) { showToast('è«‹æƒææ’å–®'); return; }
            var palletId = formatPalletId(rawId);
            
            var result = document.getElementById('scan-merge-result');
            
            // å¾å¤šå€‹ä¾†æºæŸ¥æ‰¾æ£§æ¿
            var pallet = null;
            if (window.allPallets && window.allPallets.length > 0) {
                pallet = window.allPallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            if (!pallet && window.pallets && window.pallets.length > 0) {
                pallet = window.pallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ Firebase æŸ¥è©¢
            if (!pallet) {
                try {
                    result.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:8px;"><i class="fa-solid fa-spinner fa-spin"></i> æŸ¥è©¢ä¸­...</div>';
                    var docRef = window.doc(window.db, "pallets", palletId);
                    var docSnap = await window.getDoc(docRef);
                    if (docSnap.exists()) {
                        pallet = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch(e) { console.log('FirebaseæŸ¥è©¢å¤±æ•—:', e); }
            }
            
            if (!pallet) {
                errorFeedback(); 
                result.innerHTML = '<div style="color:#f87171;text-align:center;padding:12px;"><i class="fa-solid fa-times-circle"></i> æ‰¾ä¸åˆ°æ­¤æ£§æ¿: ' + palletId + '</div>';
                document.getElementById('scan-merge-less').value = '';
                return;
            }
            
            scanData.merge.less = pallet;
            
            document.getElementById('scan-merge-less-name').innerText = pallet.productName;
            document.getElementById('scan-merge-less-qty').innerText = pallet.quantity;
            
            document.getElementById('scan-merge-step1').style.display = 'none';
            document.getElementById('scan-merge-less-info').style.display = 'block';
            document.getElementById('scan-merge-plus').style.display = 'block';
            document.getElementById('scan-merge-step2').style.display = 'block';
            feedbackSuccess();
            setTimeout(function() { document.getElementById('scan-merge-more').focus(); }, 100);
            result.innerHTML = '';
        };
        
        window.scanMergeStep2 = async function() {
            var rawId = document.getElementById('scan-merge-more').value.trim();
            if (!rawId) { showToast('è«‹æƒææ’å–®'); return; }
            var palletId = formatPalletId(rawId);
            
            var result = document.getElementById('scan-merge-result');
            
            // å¾å¤šå€‹ä¾†æºæŸ¥æ‰¾æ£§æ¿
            var pallet = null;
            if (window.allPallets && window.allPallets.length > 0) {
                pallet = window.allPallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            if (!pallet && window.pallets && window.pallets.length > 0) {
                pallet = window.pallets.find(function(p) {
                    return p.palletId === palletId || p.id === palletId;
                });
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ Firebase æŸ¥è©¢
            if (!pallet) {
                try {
                    result.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:8px;"><i class="fa-solid fa-spinner fa-spin"></i> æŸ¥è©¢ä¸­...</div>';
                    var docRef = window.doc(window.db, "pallets", palletId);
                    var docSnap = await window.getDoc(docRef);
                    if (docSnap.exists()) {
                        pallet = { id: docSnap.id, ...docSnap.data() };
                    }
                } catch(e) { console.log('FirebaseæŸ¥è©¢å¤±æ•—:', e); }
            }
            
            if (!pallet) {
                errorFeedback(); 
                result.innerHTML = '<div style="color:#f87171;text-align:center;padding:12px;"><i class="fa-solid fa-times-circle"></i> æ‰¾ä¸åˆ°æ­¤æ£§æ¿: ' + palletId + '</div>';
                document.getElementById('scan-merge-more').value = '';
                return;
            }
            
            var less = scanData.merge.less;
            if (less.productName !== pallet.productName) {
                result.innerHTML = '<div style="color:#f87171;text-align:center;padding:12px;"><i class="fa-solid fa-times-circle"></i> å“åä¸åŒï¼Œç„¡æ³•åˆä½µ<br><span style="font-size:12px;">å°‘çš„: ' + less.productName + '<br>å¤šçš„: ' + pallet.productName + '</span></div>';
                document.getElementById('scan-merge-more').value = '';
                return;
            }
            
            scanData.merge.more = pallet;
            var total = less.quantity + pallet.quantity;
            
            document.getElementById('scan-merge-more-name').innerText = pallet.productName;
            document.getElementById('scan-merge-more-qty').innerText = pallet.quantity;
            document.getElementById('scan-merge-total').innerText = total;
            document.getElementById('scan-merge-calc').innerText = less.quantity + ' + ' + pallet.quantity + ' = ' + total;
            
            document.getElementById('scan-merge-step2').style.display = 'none';
            document.getElementById('scan-merge-more-info').style.display = 'block';
            document.getElementById('scan-merge-preview').style.display = 'block';
            // btn removed - auto execute
            feedbackSuccess();
            result.innerHTML = '';
            
            // è‡ªå‹•åŸ·è¡Œåˆä½µï¼ˆ3ç§’å¾Œï¼Œçµ¦ç”¨æˆ¶ç¢ºèªæ™‚é–“ï¼‰
            result.innerHTML = '<div style="color:#a855f7;text-align:center;padding:8px;font-size:14px;"><i class="fa-solid fa-spinner fa-spin"></i> 3 ç§’å¾Œè‡ªå‹•åˆä½µï¼ŒæŒ‰é‡ç½®å–æ¶ˆ...</div>';
            window.mergeCountdown = setTimeout(function() {
                executeScanMerge();
            }, 3000);
        };
        
        window.executeScanMerge = async function() {
            var less = scanData.merge.less;
            var more = scanData.merge.more;
            if (!less || !more) return;
            
            var total = less.quantity + more.quantity;
            var result = document.getElementById('scan-merge-result');
            
            try {
                var batch = window.writeBatch(window.db);
                batch.update(window.doc(window.db, "pallets", more.id), { quantity: total });
                batch.delete(window.doc(window.db, "pallets", less.id));
                await batch.commit();
                
                await window.addDoc(window.collection(window.db, 'inventoryLogs'), {
                    type: 'merge', productName: more.productName, spec: more.spec || '',
                    quantity: total, quantityChange: 0, locationId: more.locationId,
                    fromLocation: less.locationId,  // åŸå„²ä½ï¼ˆå·²é‡‹æ”¾ï¼‰
                    batchNo: more.batchNo || '', palletId: more.palletId,
                    deletedPalletId: less.palletId,  // è¢«åˆªé™¤çš„æ¿è™Ÿ
                    deletedLocation: less.locationId,  // è¢«é‡‹æ”¾çš„å„²ä½
                    note: 'æ‰‹æ©Ÿç‰ˆæƒæä½µæ¿: ' + less.palletId + '(' + less.locationId + ')â†’' + more.palletId + '(' + more.locationId + '), å„²ä½ ' + less.locationId + ' å·²é‡‹æ”¾',
                    operator: window.currentUser || 'mobile', timestamp: new Date()
                });
                
                result.innerHTML = '<div style="background:#6b21a8;border-radius:10px;padding:16px;text-align:center;">' +
                    '<div style="font-size:32px;margin-bottom:8px;">âœ…</div>' +
                    '<div style="color:white;font-size:18px;font-weight:bold;">' + more.productName + '</div>' +
                    '<div style="color:#d8b4fe;">åˆä½µå¾Œï¼š' + total + ' ä»¶</div>' +
                    '<div style="color:#a3e635;font-size:12px;margin-top:8px;">ğŸ“ å„²ä½ ' + less.locationId + ' å·²é‡‹æ”¾</div>' +
                    '<div style="display:flex;gap:10px;margin-top:16px;">' +
                    '<button onclick="resetScanMerge()" style="flex:1;padding:12px;background:#a855f7;border:none;border-radius:8px;color:white;font-weight:bold;">ç¹¼çºŒä½µæ¿</button>' +
                    '<button onclick="goBack()" style="flex:1;padding:12px;background:#475569;border:none;border-radius:8px;color:white;font-weight:bold;">å›ä¸»é¸å–®</button>' +
                    '</div></div>';
                
                vibrateSuccess(); playBeep('success');
                showToast('âœ… ä½µæ¿æˆåŠŸï¼');
            } catch (err) {
                result.innerHTML = '<div style="color:#f87171;">âŒ ä½µæ¿å¤±æ•—: ' + err.message + '</div>';
            }
        };
        
        window.resetScanMerge = function() {
            if (window.mergeCountdown) clearTimeout(window.mergeCountdown);
            scanData.merge = { less: null, more: null };
            document.getElementById('scan-merge-less').value = '';
            document.getElementById('scan-merge-more').value = '';
            document.getElementById('scan-merge-step1').style.display = 'block';
            document.getElementById('scan-merge-less-info').style.display = 'none';
            document.getElementById('scan-merge-plus').style.display = 'none';
            document.getElementById('scan-merge-step2').style.display = 'none';
            document.getElementById('scan-merge-more-info').style.display = 'none';
            document.getElementById('scan-merge-preview').style.display = 'none';
            document.getElementById('btn-scan-merge-confirm').style.display = 'none';
            document.getElementById('scan-merge-result').innerHTML = '';
            document.getElementById('scan-merge-less').focus();
        };

    </script>
    <!-- ç›¸æ©Ÿæƒæ Modal -->
    <div id="camera-modal" class="camera-modal">
        <div class="camera-header">
            <h3><i class="fa-solid fa-camera"></i> æƒææ¢ç¢¼</h3>
            <button class="camera-close" onclick="stopCameraScanner()"><i class="fa-solid fa-xmark"></i> é—œé–‰</button>
        </div>
        <div class="camera-preview">
            <div id="qr-reader"></div>
        </div>
        <div class="camera-hint">å°‡æ¢ç¢¼å°æº–æ¡†å…§ï¼Œè‡ªå‹•è­˜åˆ¥</div>
    </div>
</body>
</html>
